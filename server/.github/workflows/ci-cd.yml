name: School Canteen CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  NODE_VERSION: '18'

jobs:
  # Job 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° Ð¸ Ñ‚ÐµÑÑ‚Ñ‹
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ðŸ“¦ Install dependencies
      run: npm ci
    
    - name: ðŸ” Run ESLint (if configured)
      run: npm run lint || echo "Lint script not found, skipping..."
      continue-on-error: true
    
    - name: ðŸ§ª Run tests (if configured)
      run: npm test || echo "Test script not found, skipping..."
      continue-on-error: true
    
    - name: ðŸ”’ Security audit
      run: npm audit --audit-level=moderate || true
      continue-on-error: true

  # Job 2: Ð¡Ð±Ð¾Ñ€ÐºÐ° Backend
  build-backend:
    name: Build Backend
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ðŸ“¦ Install dependencies
      run: npm ci --only=production
    
    - name: âœ… Verify server files
      run: |
        if [ ! -f "server/index.js" ]; then
          echo "âŒ server/index.js not found!"
          exit 1
        fi
        echo "âœ… Backend files verified"
    
    - name: ðŸ“¤ Upload backend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-files
        path: |
          server/
          package*.json
          .env.production
        retention-days: 7

  # Job 3: Ð¡Ð±Ð¾Ñ€ÐºÐ° Frontend
  build-frontend:
    name: Build Frontend
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: ðŸ“¦ Install dependencies
      run: npm ci
    
    - name: ðŸ—ï¸ Build frontend
      run: npm run build
      env:
        CI: true
        NODE_ENV: production
    
    - name: âœ… Verify build
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ dist directory not found!"
          exit 1
        fi
        echo "âœ… Frontend build successful"
        ls -la dist/
    
    - name: ðŸ“¤ Upload frontend artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: dist/
        retention-days: 7

  # Job 4: Docker Ð¾Ð±Ñ€Ð°Ð·Ñ‹
  docker-build:
    name: Build & Push Docker Images
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'release'
    
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        include:
          - service: backend
            dockerfile: CICD/Dockerfile.backend
            context: .
          - service: frontend
            dockerfile: CICD/Dockerfile.frontend
            context: .
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ” Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository }}/${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: ðŸ—ï¸ Build and push ${{ matrix.service }}
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.context }}
        file: ${{ matrix.dockerfile }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
    
    - name: ðŸ“Š Image digest
      run: echo "Image pushed successfully!"

  # Job 5: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
  deploy:
    name: Deploy to Production
    needs: docker-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          cd /opt/school-canteen
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
          cat > .env << EOF
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          EOF
          
          # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
          docker-compose -f docker-compose.production.yml pull
          
          # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹
          docker-compose -f docker-compose.production.yml up -d --remove-orphans
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
          docker image prune -af
          
          echo "âœ… Deployment completed successfully!"
    
    - name: ðŸ“§ Notify deployment
      if: always()
      run: |
        echo "Deployment status: ${{ job.status }}"
        # Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ (Slack, Telegram, Email)

  # Job 6: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¿Ð¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ
  health-check:
    name: Health Check
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ¥ Check backend health
      run: |
        sleep 30
        curl -f ${{ secrets.BACKEND_URL }}/api/menu || exit 1
        echo "âœ… Backend is healthy"
    
    - name: ðŸ¥ Check frontend health
      run: |
        curl -f ${{ secrets.FRONTEND_URL }} || exit 1
        echo "âœ… Frontend is healthy"
    
    - name: ðŸ“Š Report status
      if: always()
      run: |
        echo "Health check completed with status: ${{ job.status }}"
