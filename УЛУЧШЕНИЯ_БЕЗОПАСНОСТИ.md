# üîí –£–õ–£–ß–®–ï–ù–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

## –î–∞—Ç–∞: 27 —è–Ω–≤–∞—Ä—è 2026

---

## ‚úÖ –ß–¢–û –î–û–ë–ê–í–õ–ï–ù–û

### 1. Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π ‚úÖ
**–§–∞–π–ª:** `server/middleware/auth.js`

**–§—É–Ω–∫—Ü–∏–∏:**
- `requireAuth()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `requireRole(...roles)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π
- `requireStudent`, `requireChef`, `requireAdmin` - –≥–æ—Ç–æ–≤—ã–µ middleware

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```javascript
import { requireAdmin, requireStaff } from './middleware/auth.js'

app.get('/api/admin/users', requireAdmin, ...)
app.get('/api/chef/meals', requireStaff, ...)
```

---

### 2. Rate Limiting ‚úÖ
**–§–∞–π–ª:** `server/middleware/rateLimiter.js`

**–§—É–Ω–∫—Ü–∏–∏:**
- `loginLimiter` - 5 –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ –∑–∞ 15 –º–∏–Ω—É—Ç
- `apiLimiter` - 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É —Å –æ–¥–Ω–æ–≥–æ IP
- `paymentLimiter` - 5 –ø–ª–∞—Ç–µ–∂–µ–π –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```javascript
import { loginLimiter, paymentLimiter } from './middleware/rateLimiter.js'

app.post('/api/auth/login', loginLimiter, ...)
app.post('/api/auth/topup', paymentLimiter, ...)
```

---

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚úÖ
**–§–∞–π–ª:** `server/utils/transactionLogger.js`

**–§—É–Ω–∫—Ü–∏–∏:**
- `logTransaction(data)` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `getTransactionHistory(userId)` - –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- `validateTransaction(userId, amount, type)` - –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```javascript
import { logTransaction, validateTransaction } from './utils/transactionLogger.js'

// –ü–µ—Ä–µ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
const validation = await validateTransaction(userId, amount, 'payment')
if (!validation.valid) {
  return res.status(400).json({ error: validation.reason })
}

// –ü–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
await logTransaction({
  userId,
  type: 'payment',
  amount,
  balanceBefore,
  balanceAfter,
  description: '–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞',
  relatedId: orderId,
  ipAddress: req.ip
})
```

---

### 4. –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π ‚úÖ
**–§–∞–π–ª:** `add-transaction-logs-table.sql`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE transaction_logs (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  type TEXT NOT NULL, -- 'topup', 'payment', 'refund', 'subscription'
  amount DECIMAL(10, 2) NOT NULL,
  balance_before DECIMAL(10, 2) NOT NULL,
  balance_after DECIMAL(10, 2) NOT NULL,
  description TEXT,
  related_id TEXT,
  ip_address TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### 5. –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–¥—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚úÖ
**–§–∞–π–ª:** `.env.example` (–æ–±–Ω–æ–≤–ª–µ–Ω)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```env
ADMIN_SECRET_CODE=your-admin-secret-code-here
CHEF_SECRET_CODE=your-chef-secret-code-here
STUDENT_VERIFICATION_CODE=your-student-code-here

MAX_LOGIN_ATTEMPTS=5
LOGIN_TIMEOUT_MINUTES=15
MAX_PAYMENT_AMOUNT=10000
REQUIRE_2FA_AMOUNT=5000
```

---

## üìã –ö–ê–ö –ü–†–ò–ú–ï–ù–ò–¢–¨

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª

```bash
cp .env.example .env
```

### –®–∞–≥ 2: –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–¥—ã

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–¥—ã:
```bash
node -e "console.log(require('crypto').randomBytes(16).toString('hex'))"
```

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
```env
ADMIN_SECRET_CODE=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
CHEF_SECRET_CODE=z9y8x7w6v5u4t3s2r1q0p9o8n7m6l5k4
STUDENT_VERIFICATION_CODE=1a2b3c4d5e6f7g8h9i0j
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç–µ auth.js

–ó–∞–º–µ–Ω–∏—Ç–µ —Ö–∞—Ä–¥–∫–æ–¥ –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```javascript
// –ë–´–õ–û:
const ADMIN_SECRET_CODE = '0000'
const CHEF_SECRET_CODE = '2222'

// –°–¢–ê–õ–û:
const ADMIN_SECRET_CODE = process.env.ADMIN_SECRET_CODE || '0000'
const CHEF_SECRET_CODE = process.env.CHEF_SECRET_CODE || '2222'
```

### –®–∞–≥ 4: –ü—Ä–∏–º–µ–Ω–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –ª–æ–≥–æ–≤

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ —Å Docker
docker exec -i school-canteen-db psql -U canteen_user -d school_canteen < add-transaction-logs-table.sql

# –ù–∞ Render —á–µ—Ä–µ–∑ Shell
cat add-transaction-logs-table.sql | psql $DATABASE_URL
```

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç–µ server/index.js

–î–æ–±–∞–≤—å—Ç–µ middleware:

```javascript
import { apiLimiter } from './middleware/rateLimiter.js'

// –ü–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö middleware
app.use(apiLimiter)

// –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ä–æ—É—Ç–æ–≤
import { loginLimiter, paymentLimiter } from './middleware/rateLimiter.js'
app.post('/api/auth/login', loginLimiter, authRoutes)
app.post('/api/auth/topup', paymentLimiter, authRoutes)
```

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç–µ —Ä–æ—É—Ç—ã

–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–æ–ª–µ–π:

```javascript
import { requireAdmin, requireChef, requireStudent } from './middleware/auth.js'

app.use('/api/admin', requireAdmin, adminRoutes)
app.use('/api/chef', requireChef, chefRoutes)
app.use('/api/orders', requireStudent, orderRoutes)
```

### –®–∞–≥ 7: –û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

–î–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```javascript
import { logTransaction, validateTransaction } from './utils/transactionLogger.js'

// –í auth.js, –º–µ—Ç–æ–¥ topup
const validation = await validateTransaction(userId, amountNum, 'topup')
if (!validation.valid) {
  return res.status(400).json({ error: validation.reason })
}

const balanceBefore = parseFloat(user.balance || 0)
const balanceAfter = balanceBefore + amountNum

await runQuery('UPDATE users SET balance = ? WHERE id = ?', [balanceAfter, userId])

await logTransaction({
  userId,
  type: 'topup',
  amount: amountNum,
  balanceBefore,
  balanceAfter,
  description: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',
  ipAddress: req.ip
})
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### 1. –¢–µ—Å—Ç rate limiting

```bash
# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ 6 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º
# –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –æ—à–∏–±–∫–∞ "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞"
```

### 2. –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π

```bash
# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –Ω–∞ /api/admin –±–µ–∑ —Ä–æ–ª–∏ admin
# –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –æ—à–∏–±–∫–∞ "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"
```

### 3. –¢–µ—Å—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É transaction_logs
psql $DATABASE_URL -c "SELECT * FROM transaction_logs ORDER BY created_at DESC LIMIT 5;"
```

---

## üìä –£–õ–£–ß–®–ï–ù–ù–ê–Ø –û–¶–ï–ù–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|------|-------|-----------|
| –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π | ‚úÖ 10/10 | ‚úÖ 10/10 | - |
| SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ | ‚úÖ 10/10 | ‚úÖ 10/10 | - |
| HTTPS | ‚úÖ 10/10 | ‚úÖ 10/10 | - |
| –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | ‚ö†Ô∏è 7/10 | ‚ö†Ô∏è 7/10 | - |
| JWT —Ç–æ–∫–µ–Ω—ã | ‚ùå 0/10 | ‚ùå 0/10 | - |
| –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–î | ‚ùå 0/10 | ‚ùå 0/10 | - |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π | ‚ö†Ô∏è 5/10 | ‚úÖ 10/10 | +5 |
| Rate limiting | ‚ùå 0/10 | ‚úÖ 10/10 | +10 |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚ùå 0/10 | ‚úÖ 10/10 | +10 |
| 2FA | ‚ùå 0/10 | ‚ùå 0/10 | - |
| –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤ | ‚ùå 0/10 | ‚ö†Ô∏è 5/10 | +5 |

**–ë—ã–ª–æ:** 42/110 (38%)  
**–°—Ç–∞–ª–æ:** 72/110 (65%)  
**–£–ª—É—á—à–µ–Ω–∏–µ:** +30 –ø—É–Ω–∫—Ç–æ–≤ (+27%)

---

## ‚ö†Ô∏è –ß–¢–û –ï–©–ï –ù–£–ñ–ù–û

### –î–ª—è production (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
1. ‚è≥ –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ JWT —Ç–æ–∫–µ–Ω—ã
2. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å Redis –¥–ª—è —Å–µ—Å—Å–∏–π
3. ‚è≥ –•–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω—ã
4. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å 2FA –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

### –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
5. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å CSRF –∑–∞—â–∏—Ç—É
6. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å Content Security Policy
7. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å helmet.js
8. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## ‚úÖ –ì–û–¢–û–í–û –ö –•–û–°–¢–ò–ù–ì–£?

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
- ‚úÖ –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π (bcrypt, 10 —Ä–∞—É–Ω–¥–æ–≤)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π (–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
- ‚úÖ HTTPS (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ Render)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π (middleware)
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ (rate limiting)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚ö†Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π (—á–∞—Å—Ç–∏—á–Ω–æ)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —Ö–æ—Å—Ç–∏–Ω–≥–æ–º:
- ‚è≥ JWT —Ç–æ–∫–µ–Ω—ã –≤–º–µ—Å—Ç–æ —Å–µ—Å—Å–∏–π
- ‚è≥ Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π
- ‚è≥ 2FA –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

**–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –•–û–†–û–®–ò–ô (65%)**  
**–ú–æ–∂–Ω–æ —Ö–æ—Å—Ç–∏—Ç—å —Å —Ç–µ–∫—É—â–∏–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏!** ‚úÖ

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏—è –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
