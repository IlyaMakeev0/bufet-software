"""
–®–∫–æ–ª—å–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è
–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –≤—Ö–æ–¥–æ–º –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π
–í–∫–ª—é—á–∞—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ –∏ –∑–∞—è–≤–∫–∞–º–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
"""

from flask import Flask, jsonify, request, session, redirect, g, render_template_string
import sqlite3
import uuid
import os
import json
from datetime import date, datetime, timedelta
from werkzeug.security import generate_password_hash, check_password_hash
import calendar
import re
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import secrets
import time
import qrcode
from io import BytesIO
import base64

# ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================

app = Flask(__name__)
app.secret_key = '—à–∫–æ–ª–∞-—Å—Ç–æ–ª–æ–≤–∞—è-2024-—Å–µ–∫—Ä–µ—Ç-–∫–ª—é—á'
app.config['DATABASE'] = 'data/—à–∫–æ–ª–∞_—Å—Ç–æ–ª–æ–≤–∞—è_–Ω–æ–≤–∞—è.db'
app.config['VERIFICATION_EXPIRY'] = 1800  # 30 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
app.config['PASSWORD_RESET_EXPIRY'] = 1800  # 30 –º–∏–Ω—É—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è

# ==================== –¢–ï–°–¢–û–í–´–ï –ê–ö–ö–ê–£–ù–¢–´ ====================

TEST_ACCOUNTS = {
    'student': {
        'email': 'student@test.com',
        'password': 'student123',
        'first_name': '–ò–≤–∞–Ω',
        'last_name': '–¢–µ—Å—Ç–æ–≤—ã–π',
        'class_name': '10–ê',
        'allergens': ['none']
    },
    'chef': {
        'email': 'chef@test.com',
        'password': 'chef123',
        'first_name': '–ü–µ—Ç—Ä',
        'last_name': '–ü–æ–≤–∞—Ä–æ–≤',
        'access_code': 'KITCHEN2024'
    },
    'admin': {
        'email': 'admin@test.com',
        'password': 'admin123',
        'first_name': '–ê–ª–µ–∫—Å–µ–π',
        'last_name': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤',
        'access_code': 'SCHOOLADMIN2024'
    }
}

# ==================== –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ö–û–î–´ –î–û–°–¢–£–ü–ê ====================

SPECIAL_CODES = {
    'CHEF_ACCESS_CODE': 'KITCHEN2024',
    'ADMIN_ACCESS_CODE': 'SCHOOLADMIN2024'
}

# ==================== –°–ü–ò–°–û–ö –ê–õ–õ–ï–†–ì–ï–ù–û–í ====================

ALLERGENS = {
    'gluten': '–ì–ª—é—Ç–µ–Ω (–ø—à–µ–Ω–∏—Ü–∞, —Ä–æ–∂—å, —è—á–º–µ–Ω—å)',
    'lactose': '–õ–∞–∫—Ç–æ–∑–∞ (–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã)',
    'nuts': '–û—Ä–µ—Ö–∏ (–∞—Ä–∞—Ö–∏—Å, –≥—Ä–µ—Ü–∫–∏–µ, –º–∏–Ω–¥–∞–ª—å)',
    'eggs': '–Ø–π—Ü–∞',
    'soy': '–°–æ—è',
    'fish': '–†—ã–±–∞',
    'seafood': '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã (–∫—Ä–µ–≤–µ—Ç–∫–∏, –∫—Ä–∞–±—ã)',
    'honey': '–ú—ë–¥',
    'citrus': '–¶–∏—Ç—Ä—É—Å–æ–≤—ã–µ',
    'red_fruits': '–ö—Ä–∞—Å–Ω—ã–µ —Ñ—Ä—É–∫—Ç—ã (–∫–ª—É–±–Ω–∏–∫–∞, –º–∞–ª–∏–Ω–∞)',
    'chocolate': '–®–æ–∫–æ–ª–∞–¥',
    'tomato': '–¢–æ–º–∞—Ç—ã',
    'celery': '–°–µ–ª—å–¥–µ—Ä–µ–π',
    'mustard': '–ì–æ—Ä—á–∏—Ü–∞',
    'sesame': '–ö—É–Ω–∂—É—Ç',
    'sulphites': '–°—É–ª—å—Ñ–∏—Ç—ã (–∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç—ã)',
    'none': '–ù–µ—Ç –∞–ª–ª–µ—Ä–≥–∏–π'
}

ALLERGENS_DISPLAY = {
    'gluten': 'üåæ –ì–ª—é—Ç–µ–Ω',
    'lactose': 'ü•õ –õ–∞–∫—Ç–æ–∑–∞',
    'nuts': 'ü•ú –û—Ä–µ—Ö–∏',
    'eggs': 'ü•ö –Ø–π—Ü–∞',
    'soy': 'üå± –°–æ—è',
    'fish': 'üêü –†—ã–±–∞',
    'seafood': 'ü¶ê –ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã',
    'honey': 'üçØ –ú—ë–¥',
    'citrus': 'üçä –¶–∏—Ç—Ä—É—Å–æ–≤—ã–µ',
    'red_fruits': 'üçì –ö—Ä–∞—Å–Ω—ã–µ —Ñ—Ä—É–∫—Ç—ã',
    'chocolate': 'üç´ –®–æ–∫–æ–ª–∞–¥',
    'tomato': 'üçÖ –¢–æ–º–∞—Ç—ã',
    'celery': 'ü•¨ –°–µ–ª—å–¥–µ—Ä–µ–π',
    'mustard': 'üå≠ –ì–æ—Ä—á–∏—Ü–∞',
    'sesame': 'üåø –ö—É–Ω–∂—É—Ç',
    'sulphites': 'üß™ –°—É–ª—å—Ñ–∏—Ç—ã',
    'none': '‚úÖ –ù–µ—Ç'
}

# ==================== EMAIL –ù–ê–°–¢–†–û–ô–ö–ò ====================

SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
EMAIL_SENDER = "ppredprof@gmail.com"
EMAIL_PASSWORD = "xvzr khqt hckc wabb"

# ==================== –•–†–ê–ù–ò–õ–ò–©–ï –ö–û–î–û–í –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø ====================

verification_codes = {}
pending_registrations = {}
password_reset_codes = {}

# ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø EMAIL ====================

def send_email(receiver_email, subject, body):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ email —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        print(f"\nüìß –ü—ã—Ç–∞—é—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email:")
        print(f"‚Ä¢ –ö–æ–º—É: {receiver_email}")
        print(f"‚Ä¢ –¢–µ–º–∞: {subject}")
        
        message = MIMEMultipart()
        message["From"] = EMAIL_SENDER
        message["To"] = receiver_email
        message["Subject"] = subject
        
        message.attach(MIMEText(body, "plain"))
        
        print(f"‚Ä¢ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ {SMTP_SERVER}:{SMTP_PORT}")
        server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
        server.starttls()
        
        print("‚Ä¢ –ê–≤—Ç–æ—Ä–∏–∑—É—é—Å—å...")
        server.login(EMAIL_SENDER, EMAIL_PASSWORD)
        
        print("‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª—è—é –ø–∏—Å—å–º–æ...")
        server.sendmail(EMAIL_SENDER, receiver_email, message.as_string())
        server.quit()
        
        print(f"‚úÖ Email —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {receiver_email}")
        return True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:")
        print(f"‚Ä¢ –¢–∏–ø –æ—à–∏–±–∫–∏: {type(e).__name__}")
        print(f"‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–µ: {str(e)}")
        return False

def generate_verification_code(email):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    code = ''.join([str(secrets.randbelow(10)) for _ in range(6)])
    verification_codes[email] = {
        'code': code,
        'created_at': time.time(),
        'attempts': 0
    }
    print(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ –¥–ª—è {email}: {code}")
    return code

def generate_password_reset_code(email):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
    code = ''.join([str(secrets.randbelow(10)) for _ in range(6)])
    password_reset_codes[email] = {
        'code': code,
        'created_at': time.time(),
        'attempts': 0
    }
    print(f"‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –¥–ª—è {email}: {code}")
    return code

def verify_code(email, code, code_type='verification'):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
    print(f"\nüîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ ({code_type}) –¥–ª—è {email}: '{code}'")
    
    if code_type == 'verification':
        codes_dict = verification_codes
    else:
        codes_dict = password_reset_codes
    
    if email not in codes_dict:
        print(f"‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è email: {email}")
        return False, "–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥."
    
    verification = codes_dict[email]
    
    current_time = time.time()
    expiry_time = verification['created_at'] + app.config['VERIFICATION_EXPIRY']
    
    if current_time > expiry_time:
        print(f"‚ùå –ö–æ–¥ –∏—Å—Ç–µ–∫. –ü—Ä–æ—à–ª–æ {current_time - verification['created_at']:.0f} —Å–µ–∫.")
        del codes_dict[email]
        return False, "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞ –∏—Å—Ç–µ–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥."
    
    if verification['attempts'] >= 3:
        print(f"‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: {verification['attempts']}")
        del codes_dict[email]
        return False, "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥"
    
    user_code = str(code).strip()
    expected_code = str(verification['code']).strip()
    
    if user_code != expected_code:
        verification['attempts'] += 1
        print(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥! –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: {3 - verification['attempts']}")
        return False, f"–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: {3 - verification['attempts']}"
    
    print(f"‚úÖ –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –¥–ª—è {email}")
    del codes_dict[email]
    return True, "–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω"

def generate_qr_code(data):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞"""
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
    )
    qr.add_data(data)
    qr.make(fit=True)
    
    img = qr.make_image(fill_color="black", back_color="white")
    buffered = BytesIO()
    img.save(buffered, format="PNG")
    img_str = base64.b64encode(buffered.getvalue()).decode()
    return f"data:image/png;base64,{img_str}"

# ==================== –ë–ê–ó–ê –î–ê–ù–ù–´–• ====================

def get_db():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î"""
    if 'db' not in g:
        g.db = sqlite3.connect(app.config['DATABASE'])
        g.db.row_factory = sqlite3.Row
    return g.db

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π"""
    with app.app_context():
        db = get_db()
        
        print("üîÑ –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        db.execute('DROP TABLE IF EXISTS supply_requests')
        db.execute('DROP TABLE IF EXISTS ingredients_stock')
        db.execute('DROP TABLE IF EXISTS recipe_ingredients')
        db.execute('DROP TABLE IF EXISTS recipes')
        db.execute('DROP TABLE IF EXISTS user_allergens')
        db.execute('DROP TABLE IF EXISTS menu_allergens')
        db.execute('DROP TABLE IF EXISTS subscriptions')
        db.execute('DROP TABLE IF EXISTS issued_meals')
        db.execute('DROP TABLE IF EXISTS reviews')
        db.execute('DROP TABLE IF EXISTS orders')
        db.execute('DROP TABLE IF EXISTS menu')
        db.execute('DROP TABLE IF EXISTS users')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        db.execute('''
            CREATE TABLE users (
                id TEXT PRIMARY KEY,
                email TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL,
                first_name TEXT NOT NULL,
                last_name TEXT NOT NULL,
                class_name TEXT,
                role TEXT NOT NULL DEFAULT 'student',
                balance REAL DEFAULT 1000,
                email_verified BOOLEAN DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        db.execute('''
            CREATE TABLE user_allergens (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                allergen TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                UNIQUE(user_id, allergen)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –º–µ–Ω—é
        db.execute('''
            CREATE TABLE menu (
                id TEXT PRIMARY KEY,
                day TEXT NOT NULL,
                name TEXT NOT NULL,
                description TEXT,
                price REAL NOT NULL,
                meal_type TEXT NOT NULL,
                available BOOLEAN DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–µ—Ü–µ–ø—Ç–æ–≤
        db.execute('''
            CREATE TABLE recipes (
                id TEXT PRIMARY KEY,
                menu_id TEXT NOT NULL,
                name TEXT NOT NULL,
                instructions TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (menu_id) REFERENCES menu(id) ON DELETE CASCADE
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        db.execute('''
            CREATE TABLE ingredients_stock (
                id TEXT PRIMARY KEY,
                name TEXT NOT NULL UNIQUE,
                unit TEXT NOT NULL DEFAULT '–≥—Ä',
                current_stock REAL DEFAULT 0,
                min_stock REAL DEFAULT 1000,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å–≤—è–∑–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        db.execute('''
            CREATE TABLE recipe_ingredients (
                id TEXT PRIMARY KEY,
                recipe_id TEXT NOT NULL,
                ingredient_id TEXT NOT NULL,
                quantity REAL NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE,
                FOREIGN KEY (ingredient_id) REFERENCES ingredients_stock(id) ON DELETE CASCADE
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
        db.execute('''
            CREATE TABLE supply_requests (
                id TEXT PRIMARY KEY,
                ingredient_id TEXT NOT NULL,
                ingredient_name TEXT NOT NULL,
                requested_by TEXT NOT NULL,
                requested_quantity REAL NOT NULL,
                unit TEXT NOT NULL DEFAULT '–≥—Ä',
                status TEXT DEFAULT '–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
                admin_comment TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                processed_at TIMESTAMP,
                processed_by TEXT,
                FOREIGN KEY (ingredient_id) REFERENCES ingredients_stock(id),
                FOREIGN KEY (requested_by) REFERENCES users(id)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ –≤ –±–ª—é–¥–∞—Ö
        db.execute('''
            CREATE TABLE menu_allergens (
                id TEXT PRIMARY KEY,
                menu_id TEXT NOT NULL,
                allergen TEXT NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (menu_id) REFERENCES menu(id) ON DELETE CASCADE,
                UNIQUE(menu_id, allergen)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∑–∞–∫–∞–∑–æ–≤
        db.execute('''
            CREATE TABLE orders (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                status TEXT DEFAULT '–æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –æ—Ç–∑—ã–≤–æ–≤
        db.execute('''
            CREATE TABLE reviews (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
                comment TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
        db.execute('''
            CREATE TABLE subscriptions (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                selected_dates TEXT NOT NULL,
                start_date TEXT NOT NULL,
                end_date TEXT NOT NULL,
                total_price REAL NOT NULL,
                status TEXT DEFAULT '–∞–∫—Ç–∏–≤–µ–Ω',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤—ã–¥–∞–Ω–Ω—ã—Ö –±–ª—é–¥
        db.execute('''
            CREATE TABLE issued_meals (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                subscription_id TEXT,
                issue_date TEXT NOT NULL,
                meal_type TEXT NOT NULL,
                issued_by TEXT,
                status TEXT DEFAULT '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id),
                FOREIGN KEY (subscription_id) REFERENCES subscriptions(id)
            )
        ''')
        
        db.commit()
        print("‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã!")
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        print("üë• –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...")
        
        # –¢–µ—Å—Ç–æ–≤—ã–π —É—á–µ–Ω–∏–∫
        student_data = TEST_ACCOUNTS['student']
        student_id = str(uuid.uuid4())
        db.execute('''
            INSERT INTO users (id, email, password, first_name, last_name, class_name, role, balance, email_verified)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (student_id, student_data['email'], generate_password_hash(student_data['password']),
             student_data['first_name'], student_data['last_name'], student_data['class_name'],
             'student', 1000, 1))
        
        # –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–≤–∞—Ä
        chef_data = TEST_ACCOUNTS['chef']
        chef_id = str(uuid.uuid4())
        db.execute('''
            INSERT INTO users (id, email, password, first_name, last_name, role, email_verified)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (chef_id, chef_data['email'], generate_password_hash(chef_data['password']),
             chef_data['first_name'], chef_data['last_name'], 'chef', 1))
        
        # –¢–µ—Å—Ç–æ–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
        admin_data = TEST_ACCOUNTS['admin']
        admin_id = str(uuid.uuid4())
        db.execute('''
            INSERT INTO users (id, email, password, first_name, last_name, role, email_verified)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        ''', (admin_id, admin_data['email'], generate_password_hash(admin_data['password']),
             admin_data['first_name'], admin_data['last_name'], 'admin', 1))
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ–Ω—é –Ω–∞ –º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥
        print("üçΩÔ∏è –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é —Å –∞–ª–ª–µ—Ä–≥–µ–Ω–∞–º–∏...")
        today = date.today()
        
        menu_items = [
            (today, '–ö–∞—à–∞ –æ–≤—Å—è–Ω–∞—è —Å —è–≥–æ–¥–∞–º–∏', '–ü–æ–ª–µ–∑–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫ —Å —è–≥–æ–¥–∞–º–∏ –∏ –º—ë–¥–æ–º', 120, '–∑–∞–≤—Ç—Ä–∞–∫', ['gluten', 'honey', 'red_fruits']),
            (today, '–°—ã—Ä–Ω–∏–∫–∏ —Å–æ —Å–º–µ—Ç–∞–Ω–æ–π', '–î–æ–º–∞—à–Ω–∏–µ —Å—ã—Ä–Ω–∏–∫–∏ —Å –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–π —Å–º–µ—Ç–∞–Ω–æ–π', 140, '–∑–∞–≤—Ç—Ä–∞–∫', ['lactose', 'eggs', 'gluten']),
            (today, '–û–º–ª–µ—Ç —Å –≤–µ—Ç—á–∏–Ω–æ–π', '–°—ã—Ç–Ω—ã–π –æ–º–ª–µ—Ç —Å –≤–µ—Ç—á–∏–Ω–æ–π –∏ —Å—ã—Ä–æ–º', 150, '–∑–∞–≤—Ç—Ä–∞–∫', ['eggs', 'lactose']),
            (today, '–ë–ª–∏–Ω—á–∏–∫–∏ —Å —Ç–≤–æ—Ä–æ–≥–æ–º', '–¢–æ–Ω–∫–∏–µ –±–ª–∏–Ω—ã —Å —Ç–≤–æ—Ä–æ–∂–Ω–æ–π –Ω–∞—á–∏–Ω–∫–æ–π', 130, '–∑–∞–≤—Ç—Ä–∞–∫', ['gluten', 'lactose', 'eggs']),
            (today, '–ì—Ä–∞–Ω–æ–ª–∞ —Å –π–æ–≥—É—Ä—Ç–æ–º', '–•—Ä—É—Å—Ç—è—â–∞—è –≥—Ä–∞–Ω–æ–ª–∞ —Å –≥—Ä–µ—á–µ—Å–∫–∏–º –π–æ–≥—É—Ä—Ç–æ–º', 110, '–∑–∞–≤—Ç—Ä–∞–∫', ['gluten', 'nuts', 'lactose', 'honey']),
            (today, '–°—É–ø –∫—É—Ä–∏–Ω—ã–π —Å –ª–∞–ø—à–æ–π', '–ê—Ä–æ–º–∞—Ç–Ω—ã–π —Å—É–ø —Å –¥–æ–º–∞—à–Ω–µ–π –ª–∞–ø—à–æ–π', 150, '–æ–±–µ–¥', ['gluten', 'celery']),
            (today, '–ì—Ä–µ—á–∫–∞ —Å –∫–æ—Ç–ª–µ—Ç–æ–π', '–°—ã—Ç–Ω—ã–π –æ–±–µ–¥ —Å –≥–æ–≤—è–∂—å–µ–π –∫–æ—Ç–ª–µ—Ç–æ–π', 180, '–æ–±–µ–¥', ['gluten', 'eggs']),
            (today, '–ü–ª–æ–≤ —Å –≥–æ–≤—è–¥–∏–Ω–æ–π', '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–ª–æ–≤ —Å –≥–æ–≤—è–¥–∏–Ω–æ–π –∏ –º–æ—Ä–∫–æ–≤—å—é', 200, '–æ–±–µ–¥', ['none']),
            (today, '–°–∞–ª–∞—Ç –æ–≤–æ—â–Ω–æ–π', '–°–≤–µ–∂–∏–µ –æ–≤–æ—â–∏ —Å –æ–ª–∏–≤–∫–æ–≤—ã–º –º–∞—Å–ª–æ–º', 90, '–æ–±–µ–¥', ['tomato', 'celery']),
            (today, '–†—ã–±–Ω—ã–π —Å—É–ø', '–ù–∞–≤–∞—Ä–∏—Å—Ç–∞—è —É—Ö–∞ —Å —Ä–µ—á–Ω–æ–π —Ä—ã–±–æ–π', 170, '–æ–±–µ–¥', ['fish', 'celery']),
        ]
        
        for i in range(30):
            current_date = today + timedelta(days=i)
            date_str = current_date.strftime('%Y-%m-%d')
            
            for item in menu_items:
                menu_id = str(uuid.uuid4())
                db.execute('''
                    INSERT INTO menu (id, day, name, description, price, meal_type)
                    VALUES (?, ?, ?, ?, ?, ?)
                ''', (menu_id, date_str, item[1], item[2], item[3], item[4]))
                
                for allergen in item[5]:
                    allergen_id = str(uuid.uuid4())
                    db.execute('''
                        INSERT INTO menu_allergens (id, menu_id, allergen)
                        VALUES (?, ?, ?)
                    ''', (allergen_id, menu_id, allergen))
        
        # –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
        print("ü•© –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã...")
        basic_ingredients = [
            ('–ú—É–∫–∞ –ø—à–µ–Ω–∏—á–Ω–∞—è', '–≥—Ä', 5000, 1000),
            ('–Ø–π—Ü–∞ –∫—É—Ä–∏–Ω—ã–µ', '—à—Ç', 100, 50),
            ('–ú–æ–ª–æ–∫–æ', '–º–ª', 10000, 5000),
            ('–°–∞—Ö–∞—Ä', '–≥—Ä', 3000, 1000),
            ('–°–æ–ª—å', '–≥—Ä', 1000, 500),
            ('–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ', '–º–ª', 5000, 2000),
            ('–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ', '–≥—Ä', 8000, 4000),
            ('–ì–æ–≤—è–¥–∏–Ω–∞', '–≥—Ä', 6000, 3000),
            ('–†—ã–±–∞', '–≥—Ä', 4000, 2000),
            ('–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å', '–≥—Ä', 15000, 8000),
            ('–ú–æ—Ä–∫–æ–≤—å', '–≥—Ä', 5000, 2000),
            ('–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π', '–≥—Ä', 4000, 2000),
            ('–†–∏—Å', '–≥—Ä', 8000, 4000),
            ('–ì—Ä–µ—á–∫–∞', '–≥—Ä', 5000, 2000),
            ('–¢–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞', '–≥—Ä', 2000, 1000),
            ('–°–º–µ—Ç–∞–Ω–∞', '–≥—Ä', 3000, 1500),
            ('–¢–≤–æ—Ä–æ–≥', '–≥—Ä', 4000, 2000),
            ('–°—ã—Ä', '–≥—Ä', 3000, 1500),
            ('–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ', '–≥—Ä', 2000, 1000),
            ('–ó–µ–ª–µ–Ω—å', '–≥—Ä', 1000, 500)
        ]
        
        for ingredient in basic_ingredients:
            ingredient_id = str(uuid.uuid4())
            db.execute('''
                INSERT INTO ingredients_stock (id, name, unit, current_stock, min_stock)
                VALUES (?, ?, ?, ?, ?)
            ''', (ingredient_id, ingredient[0], ingredient[1], ingredient[2], ingredient[3]))
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ü–µ–ø—Ç—ã
        print("üìù –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ü–µ–ø—Ç—ã...")
        recipes = [
            ('–ö–∞—à–∞ –æ–≤—Å—è–Ω–∞—è —Å —è–≥–æ–¥–∞–º–∏', '–û–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è 100–≥—Ä, –ú–æ–ª–æ–∫–æ 200–º–ª, –°–∞—Ö–∞—Ä 20–≥—Ä, –Ø–≥–æ–¥—ã 50–≥—Ä'),
            ('–°—ã—Ä–Ω–∏–∫–∏ —Å–æ —Å–º–µ—Ç–∞–Ω–æ–π', '–¢–≤–æ—Ä–æ–≥ 500–≥—Ä, –Ø–π—Ü–∞ 2—à—Ç, –ú—É–∫–∞ 100–≥—Ä, –°–∞—Ö–∞—Ä 50–≥—Ä, –°–º–µ—Ç–∞–Ω–∞ 100–≥—Ä'),
            ('–û–º–ª–µ—Ç —Å –≤–µ—Ç—á–∏–Ω–æ–π', '–Ø–π—Ü–∞ 3—à—Ç, –ú–æ–ª–æ–∫–æ 50–º–ª, –°—ã—Ä 50–≥—Ä, –í–µ—Ç—á–∏–Ω–∞ 100–≥—Ä'),
            ('–°—É–ø –∫—É—Ä–∏–Ω—ã–π —Å –ª–∞–ø—à–æ–π', '–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ 300–≥—Ä, –õ–∞–ø—à–∞ 200–≥—Ä, –ö–∞—Ä—Ç–æ—Ñ–µ–ª—å 500–≥—Ä, –ú–æ—Ä–∫–æ–≤—å 100–≥—Ä, –õ—É–∫ 100–≥—Ä'),
            ('–ì—Ä–µ—á–∫–∞ —Å –∫–æ—Ç–ª–µ—Ç–æ–π', '–ì—Ä–µ—á–∫–∞ 200–≥—Ä, –ì–æ–≤—è–¥–∏–Ω–∞ 400–≥—Ä, –õ—É–∫ 50–≥—Ä, –Ø–π—Ü–æ 1—à—Ç, –°—É—Ö–∞—Ä–∏ 50–≥—Ä')
        ]
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤–æ–µ –±–ª—é–¥–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
        for i, recipe in enumerate(recipes[:5]):
            menu_item = db.execute('SELECT id FROM menu WHERE name = ? LIMIT 1', (recipe[0],)).fetchone()
            if menu_item:
                recipe_id = str(uuid.uuid4())
                db.execute('''
                    INSERT INTO recipes (id, menu_id, name, instructions)
                    VALUES (?, ?, ?, ?)
                ''', (recipe_id, menu_item['id'], recipe[0], recipe[1]))
        
        db.commit()
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –º–µ–Ω—é!")
        print(f"üë®‚Äçüéì –£—á–µ–Ω–∏–∫: {student_data['email']} / {student_data['password']}")
        print(f"üë®‚Äçüç≥ –ü–æ–≤–∞—Ä: {chef_data['email']} / {chef_data['password']}")
        print(f"üë®‚Äçüíº –ê–¥–º–∏–Ω: {admin_data['email']} / {admin_data['password']}")
        print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")

# ==================== –ì–õ–ê–í–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê ====================

@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–®–∫–æ–ª—å–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è</title>
        <meta charset="utf-8">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
                color: white;
            }
            .container {
                max-width: 900px;
                margin: 0 auto;
                background: rgba(255, 255, 255, 0.95);
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                color: #333;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 10px;
                font-size: 2.5em;
            }
            .subtitle {
                text-align: center;
                color: #7f8c8d;
                margin-bottom: 40px;
                font-size: 1.2em;
            }
            .role-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin: 40px 0;
            }
            .role-card {
                background: white;
                border-radius: 15px;
                padding: 30px;
                text-align: center;
                text-decoration: none;
                color: #333;
                transition: all 0.3s;
                border: 2px solid transparent;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            .role-card:hover {
                transform: translateY(-10px);
                box-shadow: 0 15px 30px rgba(0,0,0,0.2);
                border-color: #3498db;
            }
            .role-icon {
                font-size: 3em;
                margin-bottom: 15px;
            }
            .role-name {
                font-size: 1.5em;
                font-weight: bold;
                margin-bottom: 10px;
                color: #2c3e50;
            }
            .role-desc {
                color: #7f8c8d;
                font-size: 0.9em;
            }
            .test-accounts {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
                margin-top: 30px;
                border-left: 5px solid #3498db;
            }
            .test-account {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin: 10px 0;
                border: 1px solid #e0e0e0;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üè´ –®–∫–æ–ª—å–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è</h1>
            <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º –≤ —É—á–µ–±–Ω–æ–º –∑–∞–≤–µ–¥–µ–Ω–∏–∏</p>
            
            <div class="role-grid">
                <a href="/student" class="role-card">
                    <div class="role-icon">üë®‚Äçüéì</div>
                    <div class="role-name">–£—á–µ–Ω–∏–∫</div>
                    <div class="role-desc">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥, –∑–∞–∫–∞–∑ –ø–∏—Ç–∞–Ω–∏—è, –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã, –æ—Ç–∑—ã–≤—ã</div>
                </a>
                
                <a href="/chef" class="role-card">
                    <div class="role-icon">üë®‚Äçüç≥</div>
                    <div class="role-name">–ü–æ–≤–∞—Ä</div>
                    <div class="role-desc">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, —É—á–µ—Ç –≤—ã–¥–∞—á–∏</div>
                </a>
                
                <a href="/admin" class="role-card">
                    <div class="role-icon">üë®‚Äçüíº</div>
                    <div class="role-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    <div class="role-desc">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                </a>
            </div>
            
            <div class="test-accounts">
                <h3>üîë –¢–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h3>
                <p>–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:</p>
                
                <div class="test-account">
                    <strong>üë®‚Äçüéì –£—á–µ–Ω–∏–∫:</strong><br>
                    –õ–æ–≥–∏–Ω: ''' + TEST_ACCOUNTS['student']['email'] + '''<br>
                    –ü–∞—Ä–æ–ª—å: ''' + TEST_ACCOUNTS['student']['password'] + '''
                </div>
                
                <div class="test-account">
                    <strong>üë®‚Äçüç≥ –ü–æ–≤–∞—Ä:</strong><br>
                    –õ–æ–≥–∏–Ω: ''' + TEST_ACCOUNTS['chef']['email'] + '''<br>
                    –ü–∞—Ä–æ–ª—å: ''' + TEST_ACCOUNTS['chef']['password'] + '''<br>
                    –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: ''' + TEST_ACCOUNTS['chef']['access_code'] + '''
                </div>
                
                <div class="test-account">
                    <strong>üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</strong><br>
                    –õ–æ–≥–∏–Ω: ''' + TEST_ACCOUNTS['admin']['email'] + '''<br>
                    –ü–∞—Ä–æ–ª—å: ''' + TEST_ACCOUNTS['admin']['password'] + '''<br>
                    –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: ''' + TEST_ACCOUNTS['admin']['access_code'] + '''
                </div>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –°–¢–†–ê–ù–ò–¶–ê –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student')
def student_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞: –≤—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è —É—á–µ–Ω–∏–∫–∞"""
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .btn {
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                text-decoration: none;
                display: block;
            }
            .btn-login {
                background: #3498db;
                color: white;
            }
            .btn-login:hover {
                background: #2980b9;
            }
            .btn-register {
                background: #2ecc71;
                color: white;
            }
            .btn-register:hover {
                background: #27ae60;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
                margin-top: 20px;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
            .test-account {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin-top: 20px;
                border-left: 4px solid #3498db;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üë®‚Äçüéì –í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</h1>
            
            <div class="test-account">
                <strong>üîë –¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç:</strong><br>
                –õ–æ–≥–∏–Ω: ''' + TEST_ACCOUNTS['student']['email'] + '''<br>
                –ü–∞—Ä–æ–ª—å: ''' + TEST_ACCOUNTS['student']['password'] + '''
            </div>
            
            <p style="text-align: center; margin-bottom: 30px; color: #7f8c8d;">
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
            </p>
            
            <div class="btn-group">
                <a href="/student/login" class="btn btn-login">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
                <a href="/student/register" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="/" class="btn btn-back">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student/register', methods=['GET', 'POST'])
def student_register():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π email –∏ –∞–ª–ª–µ—Ä–≥–µ–Ω–∞–º–∏"""
    if request.method == 'POST':
        if 'verify_code' in request.form:
            # –≠—Ç–∞–ø 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            email = session.get('pending_email')
            code = request.form.get('verification_code', '').strip()
            
            if not email:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            is_valid, message = verify_code(email, code)
            
            if not is_valid:
                return f'''
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
                    <meta charset="utf-8">
                    <style>
                        body {{ 
                            font-family: 'Arial', sans-serif; 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 20px;
                        }}
                        .container {{
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            max-width: 500px;
                            width: 100%;
                        }}
                        h1 {{
                            color: #2c3e50;
                            text-align: center;
                            margin-bottom: 30px;
                        }}
                        .error {{
                            background: #f8d7da;
                            color: #721c24;
                            padding: 15px;
                            border-radius: 10px;
                            margin-bottom: 20px;
                            border-left: 5px solid #e74c3c;
                        }}
                        .form-group {{
                            margin-bottom: 20px;
                        }}
                        label {{
                            display: block;
                            margin-bottom: 8px;
                            color: #2c3e50;
                            font-weight: bold;
                        }}
                        input {{
                            width: 100%;
                            padding: 12px;
                            border: 2px solid #ddd;
                            border-radius: 8px;
                            font-size: 1em;
                            transition: border-color 0.3s;
                            text-align: center;
                            font-size: 1.2em;
                            letter-spacing: 5px;
                        }}
                        input:focus {{
                            border-color: #3498db;
                            outline: none;
                        }}
                        .btn {{
                            width: 100%;
                            padding: 15px;
                            border: none;
                            border-radius: 10px;
                            font-size: 1.1em;
                            cursor: pointer;
                            transition: all 0.3s;
                            margin-top: 10px;
                        }}
                        .btn-verify {{
                            background: #2ecc71;
                            color: white;
                        }}
                        .btn-verify:hover {{
                            background: #27ae60;
                        }}
                        .btn-resend {{
                            background: #3498db;
                            color: white;
                        }}
                        .btn-resend:hover {{
                            background: #2980b9;
                        }}
                        .btn-back {{
                            background: #95a5a6;
                            color: white;
                        }}
                        .btn-back:hover {{
                            background: #7f8c8d;
                        }}
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>üìß –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                        
                        <div class="error">
                            <strong>‚ùå –û—à–∏–±–∫–∞:</strong> {message}
                        </div>
                        
                        <p style="text-align: center; margin-bottom: 20px;">
                            –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –Ω–∞ <strong>{email}</strong>
                        </p>
                        
                        <form method="POST" action="/student/register">
                            <input type="hidden" name="verify_code" value="1">
                            
                            <div class="form-group">
                                <label for="verification_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                                <input type="text" id="verification_code" name="verification_code" required 
                                       maxlength="6" minlength="6" pattern="[0-9]{{6}}"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä">
                            </div>
                            
                            <button type="submit" class="btn btn-verify">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                            <button type="button" onclick="resendCode('{email}')" class="btn btn-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                            <a href="/student/register" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                        </form>
                    </div>
                    
                    <script>
                    function resendCode(email) {{
                        fetch('/api/resend-code', {{
                            method: 'POST',
                            headers: {{'Content-Type': 'application/json'}},
                            body: JSON.stringify({{email: email}})
                        }})
                        .then(response => response.json())
                        .then(data => {{
                            if (data.success) {{
                                alert('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email!');
                            }} else {{
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                            }}
                        }})
                        .catch(error => {{
                            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                        }});
                    }}
                    </script>
                </body>
                </html>
                '''
            
            # –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_data = pending_registrations.get(email)
            if not user_data:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–î–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            db = get_db()
            user_id = str(uuid.uuid4())
            
            try:
                db.execute('''
                    INSERT INTO users (id, email, password, first_name, last_name, class_name, role, balance, email_verified)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (user_id, email, user_data['password'], user_data['first_name'], 
                     user_data['last_name'], user_data['class_name'], 
                     'student', 1000, 1))
                
                if 'allergens' in user_data:
                    for allergen in user_data['allergens']:
                        if allergen != 'none':
                            allergen_id = str(uuid.uuid4())
                            db.execute('''
                                INSERT INTO user_allergens (id, user_id, allergen)
                                VALUES (?, ?, ?)
                            ''', (allergen_id, user_id, allergen))
                
                db.commit()
                
            except sqlite3.Error as e:
                return f'''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
                    <p>{str(e)}</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            del pending_registrations[email]
            session.pop('pending_email', None)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            allergens_list = ', '.join([ALLERGENS_DISPLAY.get(a, a) for a in user_data.get('allergens', []) if a != 'none'])
            if not allergens_list:
                allergens_list = '–ù–µ—Ç –∞–ª–ª–µ—Ä–≥–∏–π'
                
            email_body = f'''
            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_data['first_name']} {user_data['last_name']}!
            
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —à–∫–æ–ª—å–Ω—É—é —Å—Ç–æ–ª–æ–≤—É—é!
            
            ‚úÖ –í–∞—à email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!
            
            –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:
            ‚Ä¢ Email: {email}
            ‚Ä¢ –ö–ª–∞—Å—Å: {user_data['class_name']}
            ‚Ä¢ –ë–∞–ª–∞–Ω—Å: 1000 —Ä—É–±.
            ‚Ä¢ –í–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã: {allergens_list}
            
            –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–∫–∞–∑—ã–≤–∞—Ç—å –ø–∏—Ç–∞–Ω–∏–µ, –æ—Ñ–æ—Ä–º–ª—è—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –∏ –æ—Å—Ç–∞–≤–ª—è—Ç—å –æ—Ç–∑—ã–≤—ã.
            
            ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞–µ—Ç –±–ª—é–¥–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –≤–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã.
            
            –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
            '''
            
            send_email(email, "‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —à–∫–æ–ª—å–Ω—É—é —Å—Ç–æ–ª–æ–≤—É—é!", email_body)
            
            session['user_id'] = user_id
            session['user_email'] = email
            session['user_name'] = f"{user_data['first_name']} {user_data['last_name']}"
            session['user_role'] = 'student'
            session['user_class'] = user_data['class_name']
            
            return '''
            <!DOCTYPE html>
            <html>
            <head>
                <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</title>
                <meta charset="utf-8">
                <style>
                    body { 
                        font-family: 'Arial', sans-serif; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 100%;
                        text-align: center;
                    }
                    .success-icon {
                        font-size: 4em;
                        color: #2ecc71;
                        margin-bottom: 20px;
                    }
                    h1 {
                        color: #2c3e50;
                        margin-bottom: 20px;
                    }
                    .btn {
                        display: inline-block;
                        background: #2ecc71;
                        color: white;
                        padding: 15px 30px;
                        border-radius: 10px;
                        text-decoration: none;
                        margin-top: 20px;
                        font-size: 1.1em;
                    }
                    .btn:hover {
                        background: #27ae60;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="success-icon">‚úÖ</div>
                    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                    <p>–í–∞—à email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω.</p>
                    <p>–ù–∞ –≤–∞—à email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º.</p>
                    <a href="/dashboard" class="btn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                </div>
            </body>
            </html>
            '''
        
        else:
            # –≠—Ç–∞–ø 1: –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            email = request.form.get('email', '').strip()
            password = request.form.get('password', '').strip()
            confirm_password = request.form.get('confirm_password', '').strip()
            first_name = request.form.get('first_name', '').strip()
            last_name = request.form.get('last_name', '').strip()
            class_name = request.form.get('class_name', '').strip()
            allergens = request.form.getlist('allergens')
            
            if not allergens or (len(allergens) == 1 and allergens[0] == 'none'):
                allergens = ['none']
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if not all([email, password, confirm_password, first_name, last_name, class_name]):
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if password != confirm_password:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if '@' not in email or '.' not in email:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å!</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            db = get_db()
            
            existing_user = db.execute('SELECT id FROM users WHERE email = ?', (email,)).fetchone()
            if existing_user:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            code = generate_verification_code(email)
            
            pending_registrations[email] = {
                'password': generate_password_hash(password),
                'first_name': first_name,
                'last_name': last_name,
                'class_name': class_name,
                'allergens': allergens
            }
            
            session['pending_email'] = email
            
            allergens_list = ', '.join([ALLERGENS_DISPLAY.get(a, a) for a in allergens if a != 'none'])
            if not allergens_list:
                allergens_list = '–ù–µ—Ç –∞–ª–ª–µ—Ä–≥–∏–π'
                
            email_body = f'''
            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {first_name} {last_name}!
            
            –°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π!
            
            –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email.
            
            –í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: {code}
            
            –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:
            ‚Ä¢ –ö–ª–∞—Å—Å: {class_name}
            ‚Ä¢ –ê–ª–ª–µ—Ä–≥–µ–Ω—ã: {allergens_list}
            
            –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.
            
            –ï—Å–ª–∏ –≤—ã –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π, 
            –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.
            
            –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
            '''
            
            send_email(email, "–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π", email_body)
            
            return f'''
            <!DOCTYPE html>
            <html>
            <head>
                <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
                <meta charset="utf-8">
                <style>
                    body {{ 
                        font-family: 'Arial', sans-serif; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }}
                    .container {{
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 100%;
                    }}
                    h1 {{
                        color: #2c3e50;
                        text-align: center;
                        margin-bottom: 30px;
                    }}
                    .success-message {{
                        background: #d4edda;
                        color: #155724;
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        border-left: 5px solid #27ae60;
                    }}
                    .form-group {{
                        margin-bottom: 20px;
                    }}
                    label {{
                        display: block;
                        margin-bottom: 8px;
                        color: #2c3e50;
                        font-weight: bold;
                    }}
                    input {{
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        font-size: 1em;
                        transition: border-color 0.3s;
                        text-align: center;
                        font-size: 1.2em;
                        letter-spacing: 5px;
                    }}
                    input:focus {{
                        border-color: #3498db;
                        outline: none;
                    }}
                    .btn {{
                        width: 100%;
                        padding: 15px;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.1em;
                        cursor: pointer;
                        transition: all 0.3s;
                        margin-top: 10px;
                    }}
                    .btn-verify {{
                        background: #2ecc71;
                        color: white;
                    }}
                    .btn-verify:hover {{
                        background: #27ae60;
                    }}
                    .btn-resend {{
                        background: #3498db;
                        color: white;
                    }}
                    .btn-resend:hover {{
                        background: #2980b9;
                    }}
                    .btn-back {{
                        background: #95a5a6;
                        color: white;
                    }}
                    .btn-back:hover {{
                        background: #7f8c8d;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üìß –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                    
                    <div class="success-message">
                        <strong>‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</strong> –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –Ω–∞ <strong>{email}</strong>
                    </div>
                    
                    <p style="text-align: center; margin-bottom: 20px;">
                        –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
                    </p>
                    
                    <form method="POST" action="/student/register">
                        <input type="hidden" name="verify_code" value="1">
                        
                        <div class="form-group">
                            <label for="verification_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                            <input type="text" id="verification_code" name="verification_code" required 
                                   maxlength="6" minlength="6" pattern="[0-9]{{6}}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä">
                        </div>
                        
                        <button type="submit" class="btn btn-verify">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                        <button type="button" onclick="resendCode('{email}')" class="btn btn-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                        <a href="/student/register" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                    </form>
                </div>
                
                <script>
                function resendCode(email) {{
                    fetch('/api/resend-code', {{
                        method: 'POST',
                        headers: {{'Content-Type': 'application/json'}},
                        body: JSON.stringify({{email: email}})
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        if (data.success) {{
                            alert('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email!');
                        }} else {{
                            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                        }}
                    }})
                    .catch(error => {{
                        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    }});
                }}
                </script>
            </body>
            </html>
            '''
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—ç—Ç–∞–ø 1)
    allergens_html = ''
    for key, value in ALLERGENS.items():
        if key == 'none':
            allergens_html += f'''
            <label style="display: block; margin-bottom: 10px; padding: 10px; background: #e8f6e8; border-radius: 5px; border: 2px solid #27ae60;">
                <input type="checkbox" name="allergens" value="{key}" id="noneAllergen" checked onclick="toggleAllergen(this)">
                <span style="font-weight: bold; color: #27ae60;">‚úÖ {value}</span>
            </label>
            '''
        else:
            allergens_html += f'''
            <label style="display: block; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0;">
                <input type="checkbox" name="allergens" value="{key}" onclick="toggleAllergen(this)">
                <span style="font-weight: bold; margin-right: 10px;">{ALLERGENS_DISPLAY.get(key, key)}</span>
                <span style="color: #666; font-size: 0.9em;">{value}</span>
            </label>
            '''
    
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 800px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .form-section {{
                margin-bottom: 30px;
                padding: 20px;
                border: 2px solid #e8f4fc;
                border-radius: 10px;
                background: #f8f9fa;
            }}
            .form-section h3 {{
                color: #3498db;
                margin-top: 0;
                margin-bottom: 15px;
                border-bottom: 2px solid #3498db;
                padding-bottom: 5px;
            }}
            .form-group {{
                margin-bottom: 20px;
            }}
            label {{
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }}
            input {{
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }}
            input:focus {{
                border-color: #3498db;
                outline: none;
            }}
            .allergens-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 15px;
                max-height: 300px;
                overflow-y: auto;
                padding: 15px;
                background: white;
                border-radius: 8px;
                border: 1px solid #ddd;
            }}
            .warning-note {{
                background: #fff3cd;
                color: #856404;
                padding: 15px;
                border-radius: 8px;
                border-left: 5px solid #ffc107;
                margin: 20px 0;
            }}
            .btn {{
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }}
            .btn-register {{
                background: #2ecc71;
                color: white;
            }}
            .btn-register:hover {{
                background: #27ae60;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
        </style>
        <script>
            function toggleAllergen(checkbox) {{
                const noneCheckbox = document.getElementById('noneAllergen');
                if (checkbox.value === 'none') {{
                    const allCheckboxes = document.querySelectorAll('input[name="allergens"]');
                    allCheckboxes.forEach(cb => {{
                        if (cb !== checkbox) {{
                            cb.checked = false;
                        }}
                    }});
                }} else {{
                    noneCheckbox.checked = false;
                }}
            }}
        </script>
    </head>
    <body>
        <div class="container">
            <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–µ–Ω–∏–∫–∞</h1>
            
            <form method="POST" action="/student/register">
                <div class="form-section">
                    <h3>üë§ –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required placeholder="example@school.ru">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="password" name="password" required minlength="6" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    
                    <div class="form-group">
                        <label for="first_name">–ò–º—è:</label>
                        <input type="text" id="first_name" name="first_name" required placeholder="–ò–≤–∞–Ω">
                    </div>
                    
                    <div class="form-group">
                        <label for="last_name">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" id="last_name" name="last_name" required placeholder="–ò–≤–∞–Ω–æ–≤">
                    </div>
                    
                    <div class="form-group">
                        <label for="class_name">–ö–ª–∞—Å—Å:</label>
                        <input type="text" id="class_name" name="class_name" required placeholder="10–ê">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã</h3>
                    
                    <div class="warning-note">
                        <strong>–í–∞–∂–Ω–æ!</strong> –û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É –≤–∞—Å –µ—Å—Ç—å –∞–ª–ª–µ—Ä–≥–∏—è. 
                        –°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞—Ç—å –±–ª—é–¥–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —ç—Ç–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã.
                    </div>
                    
                    <div class="allergens-grid">
                        {allergens_html}
                    </div>
                </div>
                
                <button type="submit" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <a href="/student" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
        </div>
    </body>
    </html>
    '''

# ==================== –í–•–û–î –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student/login', methods=['GET', 'POST'])
def student_login():
    """–í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        
        if not email or not password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</p>
                <a href="/student/login" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
            </body>
            </html>
            '''
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ? AND role = ?', (email, 'student')).fetchone()
        
        if user and check_password_hash(user['password'], password):
            if not user['email_verified']:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</p>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º.</p>
                    <a href="/student/register" style="color: #3498db;">‚Üê –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            session['user_id'] = user['id']
            session['user_email'] = email
            session['user_name'] = f"{user['first_name']} {user['last_name']}"
            session['user_role'] = user['role']
            session['user_class'] = user['class_name']
            return redirect('/dashboard')
        else:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å!</p>
                <a href="/student/login" style="color: #3498db;">‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
            </body>
            </html>
            '''
    
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .form-group {{
                margin-bottom: 20px;
            }}
            label {{
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }}
            input {{
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }}
            input:focus {{
                border-color: #3498db;
                outline: none;
            }}
            .btn {{
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }}
            .btn-login {{
                background: #3498db;
                color: white;
            }}
            .btn-login:hover {{
                background: #2980b9;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
            .register-link {{
                text-align: center;
                margin-top: 20px;
            }}
            .forgot-password {{
                text-align: center;
                margin-top: 15px;
            }}
            .forgot-password a {{
                color: #3498db;
                text-decoration: none;
            }}
            .forgot-password a:hover {{
                text-decoration: underline;
            }}
            .test-account {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #3498db;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</h1>
            
            <div class="test-account">
                <strong>üîë –¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç:</strong><br>
                –õ–æ–≥–∏–Ω: {TEST_ACCOUNTS['student']['email']}<br>
                –ü–∞—Ä–æ–ª—å: {TEST_ACCOUNTS['student']['password']}
            </div>
            
            <form method="POST" action="/student/login">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <button type="submit" class="btn btn-login">–í–æ–π—Ç–∏</button>
                <a href="/student" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
            
            <div class="forgot-password">
                <a href="/student/forgot-password">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
            </div>
            
            <div class="register-link">
                <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/student/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ü–ê–†–û–õ–Ø –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student/forgot-password', methods=['GET', 'POST'])
def student_forgot_password():
    """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –¥–ª—è —É—á–µ–Ω–∏–∫–∞"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip()
        
        if not email:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ email!</p>
                <a href="/student/forgot-password" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>
            </body>
            </html>
            '''
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ? AND role = ?', (email, 'student')).fetchone()
        
        if not user:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω!</p>
                <a href="/student/forgot-password" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>
            </body>
            </html>
            '''
        
        if not user['email_verified']:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</p>
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email.</p>
                <a href="/student/login" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
            </body>
            </html>
            '''
        
        code = generate_password_reset_code(email)
        
        email_body = f'''
        –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user['first_name']} {user['last_name']}!
        
        –í—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —à–∫–æ–ª—å–Ω—É—é —Å—Ç–æ–ª–æ–≤—É—é.
        
        –í–∞—à –∫–æ–¥ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è: {code}
        
        –ï—Å–ª–∏ –≤—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è, –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.
        
        –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.
        
        –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
        '''
        
        send_email(email, "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –¥–ª—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π", email_body)
        
        session['reset_email'] = email
        
        return f'''
        <!DOCTYPE html>
        <html>
        <head>
            <title>–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</title>
            <meta charset="utf-8">
            <style>
                body {{ 
                    font-family: 'Arial', sans-serif; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }}
                .container {{
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 500px;
                    width: 100%;
                }}
                h1 {{
                    color: #2c3e50;
                    text-align: center;
                    margin-bottom: 30px;
                }}
                .success-message {{
                    background: #d4edda;
                    color: #155724;
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    border-left: 5px solid #27ae60;
                }}
                .form-group {{
                    margin-bottom: 20px;
                }}
                label {{
                    display: block;
                    margin-bottom: 8px;
                    color: #2c3e50;
                    font-weight: bold;
                }}
                input {{
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 1em;
                    transition: border-color 0.3s;
                    text-align: center;
                    font-size: 1.2em;
                    letter-spacing: 5px;
                }}
                input:focus {{
                    border-color: #3498db;
                    outline: none;
                }}
                .btn {{
                    width: 100%;
                    padding: 15px;
                    border: none;
                    border-radius: 10px;
                    font-size: 1.1em;
                    cursor: pointer;
                    transition: all 0.3s;
                    margin-top: 10px;
                }}
                .btn-verify {{
                    background: #2ecc71;
                    color: white;
                }}
                .btn-verify:hover {{
                    background: #27ae60;
                }}
                .btn-resend {{
                    background: #3498db;
                    color: white;
                }}
                .btn-resend:hover {{
                    background: #2980b9;
                }}
                .btn-back {{
                    background: #95a5a6;
                    color: white;
                }}
                .btn-back:hover {{
                    background: #7f8c8d;
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìß –ü—Ä–æ–≤–µ—Ä–∫–∞ email</h1>
                
                <div class="success-message">
                    <strong>‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</strong> –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –Ω–∞ <strong>{email}</strong>
                </div>
                
                <p style="text-align: center; margin-bottom: 20px;">
                    –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è.
                </p>
                
                <form method="POST" action="/student/reset-password">
                    <div class="form-group">
                        <label for="reset_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                        <input type="text" id="reset_code" name="reset_code" required 
                               maxlength="6" minlength="6" pattern="[0-9]{{6}}"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä">
                    </div>
                    
                    <button type="submit" class="btn btn-verify">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                    <button type="button" onclick="resendResetCode('{email}')" class="btn btn-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                    <a href="/student/login" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É</a>
                </form>
            </div>
            
            <script>
            function resendResetCode(email) {{
                fetch('/api/resend-reset-code', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{email: email}})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.success) {{
                        alert('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email!');
                    }} else {{
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                    }}
                }})
                .catch(error => {{
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }});
            }}
            </script>
        </body>
        </html>
        '''
    
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }
            input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }
            input:focus {
                border-color: #3498db;
                outline: none;
            }
            .btn {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }
            .btn-submit {
                background: #3498db;
                color: white;
            }
            .btn-submit:hover {
                background: #2980b9;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h1>
            
            <p style="text-align: center; margin-bottom: 20px;">
                –í–≤–µ–¥–∏—Ç–µ email, —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –∫–æ–¥ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è.
            </p>
            
            <form method="POST" action="/student/forgot-password">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                </div>
                
                <button type="submit" class="btn btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
                <a href="/student/login" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É</a>
            </form>
        </div>
    </body>
    </html>
    '''

# ==================== –°–ë–†–û–° –ü–ê–†–û–õ–Ø –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student/reset-password', methods=['POST'])
def student_reset_password():
    """–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞"""
    email = session.get('reset_email')
    code = request.form.get('reset_code', '').strip()
    
    if not email:
        return '''
        <!DOCTYPE html>
        <html>
        <head><title>–û—à–∏–±–∫–∞</title></head>
        <body style="font-family: Arial; text-align: center; padding: 50px;">
            <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
            <p>–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∑–∞–Ω–æ–≤–æ.</p>
            <a href="/student/forgot-password" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è</a>
        </body>
        </html>
        '''
    
    if 'set_password' in request.form:
        # –≠—Ç–∞–ø 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        new_password = request.form.get('new_password', '').strip()
        confirm_password = request.form.get('confirm_password', '').strip()
        
        if not new_password or not confirm_password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</p>
                <a href="/student/reset-password" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>
            </body>
            </html>
            '''
        
        if new_password != confirm_password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!</p>
                <a href="/student/reset-password" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</a>
            </body>
            </html>
            '''
        
        db = get_db()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
        hashed_password = generate_password_hash(new_password)
        db.execute('UPDATE users SET password = ? WHERE email = ?', (hashed_password, email))
        db.commit()
        
        session.pop('reset_email', None)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        email_body = f'''
        –í–∞—à –ø–∞—Ä–æ–ª—å –±—ã–ª —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω.
        
        –ï—Å–ª–∏ –≤—ã –Ω–µ –º–µ–Ω—è–ª–∏ –ø–∞—Ä–æ–ª—å, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.
        
        –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
        '''
        
        send_email(email, "‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω", email_body)
        
        return '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω</title>
            <meta charset="utf-8">
            <style>
                body { 
                    font-family: 'Arial', sans-serif; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 500px;
                    width: 100%;
                    text-align: center;
                }
                .success-icon {
                    font-size: 4em;
                    color: #2ecc71;
                    margin-bottom: 20px;
                }
                h1 {
                    color: #2c3e50;
                    margin-bottom: 20px;
                }
                .btn {
                    display: inline-block;
                    background: #3498db;
                    color: white;
                    padding: 15px 30px;
                    border-radius: 10px;
                    text-decoration: none;
                    margin-top: 20px;
                    font-size: 1.1em;
                }
                .btn:hover {
                    background: #2980b9;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="success-icon">‚úÖ</div>
                <h1>–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!</h1>
                <p>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º.</p>
                <a href="/student/login" class="btn">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>
            </div>
        </body>
        </html>
        '''
    
    else:
        # –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        is_valid, message = verify_code(email, code, 'password_reset')
        
        if not is_valid:
            return f'''
            <!DOCTYPE html>
            <html>
            <head>
                <title>–û—à–∏–±–∫–∞</title>
                <meta charset="utf-8">
                <style>
                    body {{ 
                        font-family: 'Arial', sans-serif; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }}
                    .container {{
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 100%;
                    }}
                    h1 {{
                        color: #2c3e50;
                        text-align: center;
                        margin-bottom: 30px;
                    }}
                    .error {{
                        background: #f8d7da;
                        color: #721c24;
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        border-left: 5px solid #e74c3c;
                    }}
                    .btn {{
                        width: 100%;
                        padding: 15px;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.1em;
                        cursor: pointer;
                        transition: all 0.3s;
                        margin-top: 10px;
                    }}
                    .btn-back {{
                        background: #95a5a6;
                        color: white;
                    }}
                    .btn-back:hover {{
                        background: #7f8c8d;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>‚ùå –û—à–∏–±–∫–∞</h1>
                    
                    <div class="error">
                        <strong>{message}</strong>
                    </div>
                    
                    <a href="/student/forgot-password" class="btn btn-back">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è</a>
                </div>
            </body>
            </html>
            '''
        
        # –ö–æ–¥ –≤–µ—Ä–Ω—ã–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        return '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</title>
            <meta charset="utf-8">
            <style>
                body { 
                    font-family: 'Arial', sans-serif; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 500px;
                    width: 100%;
                }
                h1 {
                    color: #2c3e50;
                    text-align: center;
                    margin-bottom: 30px;
                }
                .form-group {
                    margin-bottom: 20px;
                }
                label {
                    display: block;
                    margin-bottom: 8px;
                    color: #2c3e50;
                    font-weight: bold;
                }
                input {
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    font-size: 1em;
                    transition: border-color 0.3s;
                }
                input:focus {
                    border-color: #3498db;
                    outline: none;
                }
                .btn {
                    width: 100%;
                    padding: 15px;
                    border: none;
                    border-radius: 10px;
                    font-size: 1.1em;
                    cursor: pointer;
                    transition: all 0.3s;
                    margin-top: 10px;
                }
                .btn-submit {
                    background: #2ecc71;
                    color: white;
                }
                .btn-submit:hover {
                    background: #27ae60;
                }
                .btn-back {
                    background: #95a5a6;
                    color: white;
                }
                .btn-back:hover {
                    background: #7f8c8d;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è</h1>
                
                <form method="POST" action="/student/reset-password">
                    <input type="hidden" name="set_password" value="1">
                    
                    <div class="form-group">
                        <label for="new_password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="new_password" name="new_password" required minlength="6" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="confirm_password" name="confirm_password" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    
                    <button type="submit" class="btn btn-submit">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</button>
                    <a href="/student/login" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –û—Ç–º–µ–Ω–∞</a>
                </form>
            </div>
        </body>
        </html>
        '''

# ==================== –°–¢–†–ê–ù–ò–¶–ê –ü–û–í–ê–†–ê ====================

@app.route('/chef')
def chef_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞: –≤—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–≤–∞—Ä–∞"""
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .btn-group {{
                display: flex;
                flex-direction: column;
                gap: 15px;
            }}
            .btn {{
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                text-decoration: none;
                display: block;
            }}
            .btn-login {{
                background: #e67e22;
                color: white;
            }}
            .btn-login:hover {{
                background: #d35400;
            }}
            .btn-register {{
                background: #f39c12;
                color: white;
            }}
            .btn-register:hover {{
                background: #e67e22;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
                margin-top: 20px;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
            .test-account {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #f39c12;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üë®‚Äçüç≥ –í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</h1>
            
            <div class="test-account">
                <strong>üîë –¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç:</strong><br>
                –õ–æ–≥–∏–Ω: {TEST_ACCOUNTS['chef']['email']}<br>
                –ü–∞—Ä–æ–ª—å: {TEST_ACCOUNTS['chef']['password']}<br>
                –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: {TEST_ACCOUNTS['chef']['access_code']}
            </div>
            
            <p style="text-align: center; margin-bottom: 30px; color: #7f8c8d;">
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
            </p>
            
            <div class="btn-group">
                <a href="/chef/login" class="btn btn-login">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
                <a href="/chef/register" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="/" class="btn btn-back">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ü–û–í–ê–†–ê ====================

@app.route('/chef/register', methods=['GET', 'POST'])
def chef_register():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–≤–∞—Ä–∞"""
    if request.method == 'POST':
        if 'verify_code' in request.form:
            email = session.get('pending_email')
            code = request.form.get('verification_code', '').strip()
            
            if not email:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            is_valid, message = verify_code(email, code)
            
            if not is_valid:
                return f'''
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
                    <meta charset="utf-8">
                    <style>
                        body {{ 
                            font-family: 'Arial', sans-serif; 
                            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 20px;
                        }}
                        .container {{
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            max-width: 500px;
                            width: 100%;
                        }}
                        h1 {{
                            color: #2c3e50;
                            text-align: center;
                            margin-bottom: 30px;
                        }}
                        .error {{
                            background: #f8d7da;
                            color: #721c24;
                            padding: 15px;
                            border-radius: 10px;
                            margin-bottom: 20px;
                            border-left: 5px solid #e74c3c;
                        }}
                        .btn {{
                            width: 100%;
                            padding: 15px;
                            border: none;
                            border-radius: 10px;
                            font-size: 1.1em;
                            cursor: pointer;
                            transition: all 0.3s;
                            margin-top: 10px;
                        }}
                        .btn-verify {{
                            background: #f39c12;
                            color: white;
                        }}
                        .btn-resend {{
                            background: #3498db;
                            color: white;
                        }}
                        .btn-back {{
                            background: #95a5a6;
                            color: white;
                        }}
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>üìß –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                        
                        <div class="error">
                            <strong>‚ùå –û—à–∏–±–∫–∞:</strong> {message}
                        </div>
                        
                        <form method="POST" action="/chef/register">
                            <input type="hidden" name="verify_code" value="1">
                            
                            <div class="form-group">
                                <label for="verification_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                                <input type="text" id="verification_code" name="verification_code" required 
                                       maxlength="6" minlength="6" pattern="[0-9]{{6}}"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä">
                            </div>
                            
                            <button type="submit" class="btn btn-verify">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                            <button type="button" onclick="resendCode('{email}')" class="btn btn-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                            <a href="/chef/register" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                        </form>
                    </div>
                    
                    <script>
                    function resendCode(email) {{
                        fetch('/api/resend-code', {{
                            method: 'POST',
                            headers: {{'Content-Type': 'application/json'}},
                            body: JSON.stringify({{email: email}})
                        }})
                        .then(response => response.json())
                        .then(data => {{
                            if (data.success) {{
                                alert('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email!');
                            }} else {{
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                            }}
                        }})
                        .catch(error => {{
                            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                        }});
                    }}
                    </script>
                </body>
                </html>
                '''
            
            user_data = pending_registrations.get(email)
            if not user_data:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–î–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            db = get_db()
            user_id = str(uuid.uuid4())
            
            db.execute('''
                INSERT INTO users (id, email, password, first_name, last_name, role, email_verified)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (user_id, email, user_data['password'], user_data['first_name'], 
                 user_data['last_name'], 'chef', 1))
            
            db.commit()
            
            del pending_registrations[email]
            session.pop('pending_email', None)
            
            email_body = f'''
            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_data['first_name']} {user_data['last_name']}!
            
            –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∫ –ø–æ–≤–∞—Ä –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π.
            
            ‚úÖ –í–∞—à email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!
            
            –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:
            ‚Ä¢ –†–æ–ª—å: –ü–æ–≤–∞—Ä
            ‚Ä¢ Email –¥–ª—è –≤—Ö–æ–¥–∞: {email}
            
            –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:
            1. –û—Ç–º–µ—á–∞—Ç—å –≤—ã–¥–∞—á—É –±–ª—é–¥
            2. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
            3. –£–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏
            4. –ó–∞–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫–∏
            
            –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
            '''
            
            send_email(email, "‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞ –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π", email_body)
            
            session['user_id'] = user_id
            session['user_email'] = email
            session['user_name'] = f"{user_data['first_name']} {user_data['last_name']}"
            session['user_role'] = 'chef'
            
            return '''
            <!DOCTYPE html>
            <html>
            <head>
                <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</title>
                <meta charset="utf-8">
                <style>
                    body { 
                        font-family: 'Arial', sans-serif; 
                        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                        min-height: 100vh;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 100%;
                        text-align: center;
                    }
                    .success-icon {
                        font-size: 4em;
                        color: #f39c12;
                        margin-bottom: 20px;
                    }
                    h1 {
                        color: #2c3e50;
                        margin-bottom: 20px;
                    }
                    .btn {
                        display: inline-block;
                        background: #f39c12;
                        color: white;
                        padding: 15px 30px;
                        border-radius: 10px;
                        text-decoration: none;
                        margin-top: 20px;
                        font-size: 1.1em;
                    }
                    .btn:hover {
                        background: #e67e22;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="success-icon">‚úÖ</div>
                    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                    <p>–í–∞—à email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω.</p>
                    <p>–ù–∞ –≤–∞—à email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º.</p>
                    <a href="/dashboard" class="btn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                </div>
            </body>
            </html>
            '''
        
        else:
            email = request.form.get('email', '').strip()
            password = request.form.get('password', '').strip()
            confirm_password = request.form.get('confirm_password', '').strip()
            first_name = request.form.get('first_name', '').strip()
            last_name = request.form.get('last_name', '').strip()
            access_code = request.form.get('access_code', '').strip()
            
            if not all([email, password, confirm_password, first_name, last_name, access_code]):
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if access_code != SPECIAL_CODES['CHEF_ACCESS_CODE']:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–≤–∞—Ä–∞!</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if password != confirm_password:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if '@' not in email or '.' not in email:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å!</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            db = get_db()
            
            existing_user = db.execute('SELECT id FROM users WHERE email = ?', (email,)).fetchone()
            if existing_user:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            code = generate_verification_code(email)
            
            pending_registrations[email] = {
                'password': generate_password_hash(password),
                'first_name': first_name,
                'last_name': last_name
            }
            
            session['pending_email'] = email
            
            email_body = f'''
            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {first_name} {last_name}!
            
            –°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ–≤–∞—Ä–∞ –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π!
            
            –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email.
            
            –í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: {code}
            
            –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.
            
            –ï—Å–ª–∏ –≤—ã –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π, 
            –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.
            
            –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
            '''
            
            send_email(email, "–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–≤–∞—Ä–∞", email_body)
            
            return f'''
            <!DOCTYPE html>
            <html>
            <head>
                <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
                <meta charset="utf-8">
                <style>
                    body {{ 
                        font-family: 'Arial', sans-serif; 
                        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                        min-height: 100vh;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }}
                    .container {{
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 100%;
                    }}
                    h1 {{
                        color: #2c3e50;
                        text-align: center;
                        margin-bottom: 30px;
                    }}
                    .success-message {{
                        background: #d4edda;
                        color: #155724;
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        border-left: 5px solid #27ae60;
                    }}
                    .form-group {{
                        margin-bottom: 20px;
                    }}
                    label {{
                        display: block;
                        margin-bottom: 8px;
                        color: #2c3e50;
                        font-weight: bold;
                    }}
                    input {{
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        font-size: 1em;
                        transition: border-color 0.3s;
                        text-align: center;
                        font-size: 1.2em;
                        letter-spacing: 5px;
                    }}
                    input:focus {{
                        border-color: #e67e22;
                        outline: none;
                    }}
                    .btn {{
                        width: 100%;
                        padding: 15px;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.1em;
                        cursor: pointer;
                        transition: all 0.3s;
                        margin-top: 10px;
                    }}
                    .btn-verify {{
                        background: #f39c12;
                        color: white;
                    }}
                    .btn-resend {{
                        background: #3498db;
                        color: white;
                    }}
                    .btn-back {{
                        background: #95a5a6;
                        color: white;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üìß –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                    
                    <div class="success-message">
                        <strong>‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</strong> –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –Ω–∞ <strong>{email}</strong>
                    </div>
                    
                    <form method="POST" action="/chef/register">
                        <input type="hidden" name="verify_code" value="1">
                        
                        <div class="form-group">
                            <label for="verification_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                            <input type="text" id="verification_code" name="verification_code" required 
                                   maxlength="6" minlength="6" pattern="[0-9]{{6}}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä">
                        </div>
                        
                        <button type="submit" class="btn btn-verify">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                        <button type="button" onclick="resendCode('{email}')" class="btn btn-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                        <a href="/chef/register" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                    </form>
                </div>
                
                <script>
                function resendCode(email) {{
                    fetch('/api/resend-code', {{
                        method: 'POST',
                        headers: {{'Content-Type': 'application/json'}},
                        body: JSON.stringify({{email: email}})
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        if (data.success) {{
                            alert('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email!');
                        }} else {{
                            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                        }}
                    }})
                    .catch(error => {{
                        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    }});
                }}
                </script>
            </body>
            </html>
            '''
    
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .info-box {{
                background: #fef9e7;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 5px solid #f39c12;
            }}
            .form-group {{
                margin-bottom: 20px;
            }}
            label {{
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }}
            input {{
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }}
            input:focus {{
                border-color: #e67e22;
                outline: none;
            }}
            .btn {{
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }}
            .btn-register {{
                background: #f39c12;
                color: white;
            }}
            .btn-register:hover {{
                background: #e67e22;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞</h1>
            
            <div class="info-box">
                <strong>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞!</strong>
                <p>–ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–æ–≤: <strong>{SPECIAL_CODES['CHEF_ACCESS_CODE']}</strong></p>
            </div>
            
            <form method="POST" action="/chef/register">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="chef@school.ru">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required>
                </div>
                
                <div class="form-group">
                    <label for="first_name">–ò–º—è:</label>
                    <input type="text" id="first_name" name="first_name" required placeholder="–ü–µ—Ç—Ä">
                </div>
                
                <div class="form-group">
                    <label for="last_name">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="last_name" name="last_name" required placeholder="–ü–æ–≤–∞—Ä–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="access_code">üîê –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞:</label>
                    <input type="text" id="access_code" name="access_code" required 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–≤–∞—Ä–∞">
                </div>
                
                <button type="submit" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <a href="/chef" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
        </div>
    </body>
    </html>
    '''

# ==================== –í–•–û–î –ü–û–í–ê–†–ê ====================

@app.route('/chef/login', methods=['GET', 'POST'])
def chef_login():
    """–í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        
        if not email or not password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</p>
                <a href="/chef/login" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
            </body>
            </html>
            '''
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ? AND role = ?', (email, 'chef')).fetchone()
        
        if user and check_password_hash(user['password'], password):
            if not user['email_verified']:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</p>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º.</p>
                    <a href="/chef/register" style="color: #3498db;">‚Üê –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            session['user_id'] = user['id']
            session['user_email'] = email
            session['user_name'] = f"{user['first_name']} {user['last_name']}"
            session['user_role'] = user['role']
            return redirect('/dashboard')
        else:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å!</p>
                <a href="/chef/login" style="color: #3498db;">‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
            </body>
            </html>
            '''
    
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .form-group {{
                margin-bottom: 20px;
            }}
            label {{
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }}
            input {{
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }}
            input:focus {{
                border-color: #e67e22;
                outline: none;
            }}
            .btn {{
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }}
            .btn-login {{
                background: #e67e22;
                color: white;
            }}
            .btn-login:hover {{
                background: #d35400;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
            .register-link {{
                text-align: center;
                margin-top: 20px;
            }}
            .test-account {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #f39c12;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</h1>
            
            <div class="test-account">
                <strong>üîë –¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç:</strong><br>
                –õ–æ–≥–∏–Ω: {TEST_ACCOUNTS['chef']['email']}<br>
                –ü–∞—Ä–æ–ª—å: {TEST_ACCOUNTS['chef']['password']}
            </div>
            
            <form method="POST" action="/chef/login">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <button type="submit" class="btn btn-login">–í–æ–π—Ç–∏</button>
                <a href="/chef" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
            
            <div class="register-link">
                <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/chef/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –°–¢–†–ê–ù–ò–¶–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================

@app.route('/admin')
def admin_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞: –≤—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .btn-group {{
                display: flex;
                flex-direction: column;
                gap: 15px;
            }}
            .btn {{
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                text-decoration: none;
                display: block;
            }}
            .btn-login {{
                background: #2c3e50;
                color: white;
            }}
            .btn-login:hover {{
                background: #1a252f;
            }}
            .btn-register {{
                background: #34495e;
                color: white;
            }}
            .btn-register:hover {{
                background: #2c3e50;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
                margin-top: 20px;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
            .test-account {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #2c3e50;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üë®‚Äçüíº –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            
            <div class="test-account">
                <strong>üîë –¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç:</strong><br>
                –õ–æ–≥–∏–Ω: {TEST_ACCOUNTS['admin']['email']}<br>
                –ü–∞—Ä–æ–ª—å: {TEST_ACCOUNTS['admin']['password']}<br>
                –ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞: {TEST_ACCOUNTS['admin']['access_code']}
            </div>
            
            <p style="text-align: center; margin-bottom: 30px; color: #7f8c8d;">
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
            </p>
            
            <div class="btn-group">
                <a href="/admin/login" class="btn btn-login">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
                <a href="/admin/register" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="/" class="btn btn-back">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================

@app.route('/admin/register', methods=['GET', 'POST'])
def admin_register():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    if request.method == 'POST':
        if 'verify_code' in request.form:
            email = session.get('pending_email')
            code = request.form.get('verification_code', '').strip()
            
            if not email:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ù–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            is_valid, message = verify_code(email, code)
            
            if not is_valid:
                return f'''
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
                    <meta charset="utf-8">
                    <style>
                        body {{ 
                            font-family: 'Arial', sans-serif; 
                            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                            min-height: 100vh;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            padding: 20px;
                        }}
                        .container {{
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            max-width: 500px;
                            width: 100%;
                        }}
                        h1 {{
                            color: #2c3e50;
                            text-align: center;
                            margin-bottom: 30px;
                        }}
                        .error {{
                            background: #f8d7da;
                            color: #721c24;
                            padding: 15px;
                            border-radius: 10px;
                            margin-bottom: 20px;
                            border-left: 5px solid #e74c3c;
                        }}
                        .btn {{
                            width: 100%;
                            padding: 15px;
                            border: none;
                            border-radius: 10px;
                            font-size: 1.1em;
                            cursor: pointer;
                            transition: all 0.3s;
                            margin-top: 10px;
                        }}
                        .btn-verify {{
                            background: #34495e;
                            color: white;
                        }}
                        .btn-resend {{
                            background: #3498db;
                            color: white;
                        }}
                        .btn-back {{
                            background: #95a5a6;
                            color: white;
                        }}
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>üìß –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                        
                        <div class="error">
                            <strong>‚ùå –û—à–∏–±–∫–∞:</strong> {message}
                        </div>
                        
                        <form method="POST" action="/admin/register">
                            <input type="hidden" name="verify_code" value="1">
                            
                            <div class="form-group">
                                <label for="verification_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                                <input type="text" id="verification_code" name="verification_code" required 
                                       maxlength="6" minlength="6" pattern="[0-9]{{6}}"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä">
                            </div>
                            
                            <button type="submit" class="btn btn-verify">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                            <button type="button" onclick="resendCode('{email}')" class="btn btn-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                            <a href="/admin/register" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                        </form>
                    </div>
                    
                    <script>
                    function resendCode(email) {{
                        fetch('/api/resend-code', {{
                            method: 'POST',
                            headers: {{'Content-Type': 'application/json'}},
                            body: JSON.stringify({{email: email}})
                        }})
                        .then(response => response.json())
                        .then(data => {{
                            if (data.success) {{
                                alert('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email!');
                            }} else {{
                                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                            }}
                        }})
                        .catch(error => {{
                            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                        }});
                    }}
                    </script>
                </body>
                </html>
                '''
            
            user_data = pending_registrations.get(email)
            if not user_data:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–î–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            db = get_db()
            user_id = str(uuid.uuid4())
            
            db.execute('''
                INSERT INTO users (id, email, password, first_name, last_name, role, email_verified)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (user_id, email, user_data['password'], user_data['first_name'], 
                 user_data['last_name'], 'admin', 1))
            
            db.commit()
            
            del pending_registrations[email]
            session.pop('pending_email', None)
            
            email_body = f'''
            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_data['first_name']} {user_data['last_name']}!
            
            –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π.
            
            ‚úÖ –í–∞—à email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!
            
            –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:
            1. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã
            2. –£–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            3. –†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
            
            –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
            '''
            
            send_email(email, "‚úÖ Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π", email_body)
            
            session['user_id'] = user_id
            session['user_email'] = email
            session['user_name'] = f"{user_data['first_name']} {user_data['last_name']}"
            session['user_role'] = 'admin'
            
            return '''
            <!DOCTYPE html>
            <html>
            <head>
                <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</title>
                <meta charset="utf-8">
                <style>
                    body { 
                        font-family: 'Arial', sans-serif; 
                        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                        min-height: 100vh;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 100%;
                        text-align: center;
                    }
                    .success-icon {
                        font-size: 4em;
                        color: #2c3e50;
                        margin-bottom: 20px;
                    }
                    h1 {
                        color: #2c3e50;
                        margin-bottom: 20px;
                    }
                    .btn {
                        display: inline-block;
                        background: #34495e;
                        color: white;
                        padding: 15px 30px;
                        border-radius: 10px;
                        text-decoration: none;
                        margin-top: 20px;
                        font-size: 1.1em;
                    }
                    .btn:hover {
                        background: #2c3e50;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="success-icon">‚úÖ</div>
                    <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>
                    <p>–í–∞—à email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω.</p>
                    <a href="/dashboard" class="btn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
                </div>
            </body>
            </html>
            '''
        
        else:
            email = request.form.get('email', '').strip()
            password = request.form.get('password', '').strip()
            confirm_password = request.form.get('confirm_password', '').strip()
            first_name = request.form.get('first_name', '').strip()
            last_name = request.form.get('last_name', '').strip()
            access_code = request.form.get('access_code', '').strip()
            
            if not all([email, password, confirm_password, first_name, last_name, access_code]):
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if access_code != SPECIAL_CODES['ADMIN_ACCESS_CODE']:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if password != confirm_password:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            if '@' not in email or '.' not in email:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å!</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            db = get_db()
            
            existing_user = db.execute('SELECT id FROM users WHERE email = ?', (email,)).fetchone()
            if existing_user:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            code = generate_verification_code(email)
            
            pending_registrations[email] = {
                'password': generate_password_hash(password),
                'first_name': first_name,
                'last_name': last_name
            }
            
            session['pending_email'] = email
            
            email_body = f'''
            –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {first_name} {last_name}!
            
            –°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π!
            
            –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email.
            
            –í–∞—à –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: {code}
            
            –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.
            
            –ï—Å–ª–∏ –≤—ã –Ω–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π, 
            –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.
            
            –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
            –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
            '''
            
            send_email(email, "–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", email_body)
            
            return f'''
            <!DOCTYPE html>
            <html>
            <head>
                <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
                <meta charset="utf-8">
                <style>
                    body {{ 
                        font-family: 'Arial', sans-serif; 
                        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                        min-height: 100vh;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        padding: 20px;
                    }}
                    .container {{
                        background: white;
                        padding: 40px;
                        border-radius: 20px;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                        max-width: 500px;
                        width: 100%;
                    }}
                    h1 {{
                        color: #2c3e50;
                        text-align: center;
                        margin-bottom: 30px;
                    }}
                    .success-message {{
                        background: #d4edda;
                        color: #155724;
                        padding: 15px;
                        border-radius: 10px;
                        margin-bottom: 20px;
                        border-left: 5px solid #27ae60;
                    }}
                    .form-group {{
                        margin-bottom: 20px;
                    }}
                    label {{
                        display: block;
                        margin-bottom: 8px;
                        color: #2c3e50;
                        font-weight: bold;
                    }}
                    input {{
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        font-size: 1em;
                        transition: border-color 0.3s;
                        text-align: center;
                        font-size: 1.2em;
                        letter-spacing: 5px;
                    }}
                    input:focus {{
                        border-color: #2c3e50;
                        outline: none;
                    }}
                    .btn {{
                        width: 100%;
                        padding: 15px;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.1em;
                        cursor: pointer;
                        transition: all 0.3s;
                        margin-top: 10px;
                    }}
                    .btn-verify {{
                        background: #34495e;
                        color: white;
                    }}
                    .btn-resend {{
                        background: #3498db;
                        color: white;
                    }}
                    .btn-back {{
                        background: #95a5a6;
                        color: white;
                    }}
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üìß –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                    
                    <div class="success-message">
                        <strong>‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!</strong> –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –Ω–∞ <strong>{email}</strong>
                    </div>
                    
                    <form method="POST" action="/admin/register">
                        <input type="hidden" name="verify_code" value="1">
                        
                        <div class="form-group">
                            <label for="verification_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                            <input type="text" id="verification_code" name="verification_code" required 
                                   maxlength="6" minlength="6" pattern="[0-9]{{6}}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä">
                        </div>
                        
                        <button type="submit" class="btn btn-verify">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥</button>
                        <button type="button" onclick="resendCode('{email}')" class="btn btn-resend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>
                        <a href="/admin/register" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
                    </form>
                </div>
                
                <script>
                function resendCode(email) {{
                    fetch('/api/resend-code', {{
                        method: 'POST',
                        headers: {{'Content-Type': 'application/json'}},
                        body: JSON.stringify({{email: email}})
                    }})
                    .then(response => response.json())
                    .then(data => {{
                        if (data.success) {{
                            alert('‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email!');
                        }} else {{
                            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                        }}
                    }})
                    .catch(error => {{
                        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    }});
                }}
                </script>
            </body>
            </html>
            '''
    
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .info-box {{
                background: #f0f8ff;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 5px solid #2c3e50;
            }}
            .form-group {{
                margin-bottom: 20px;
            }}
            label {{
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }}
            input {{
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }}
            input:focus {{
                border-color: #2c3e50;
                outline: none;
            }}
            .btn {{
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }}
            .btn-register {{
                background: #34495e;
                color: white;
            }}
            .btn-register:hover {{
                background: #2c3e50;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            
            <div class="info-box">
                <strong>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞!</strong>
                <p>–ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: <strong>{SPECIAL_CODES['ADMIN_ACCESS_CODE']}</strong></p>
            </div>
            
            <form method="POST" action="/admin/register">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="admin@school.ru">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required>
                </div>
                
                <div class="form-group">
                    <label for="first_name">–ò–º—è:</label>
                    <input type="text" id="first_name" name="first_name" required placeholder="–ê–ª–µ–∫—Å–µ–π">
                </div>
                
                <div class="form-group">
                    <label for="last_name">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="last_name" name="last_name" required placeholder="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="access_code">üîê –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞:</label>
                    <input type="text" id="access_code" name="access_code" required 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
                </div>
                
                <button type="submit" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <a href="/admin" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
        </div>
    </body>
    </html>
    '''

# ==================== –í–•–û–î –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================

@app.route('/admin/login', methods=['GET', 'POST'])
def admin_login():
    """–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        
        if not email or not password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</p>
                <a href="/admin/login" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
            </body>
            </html>
            '''
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ? AND role = ?', (email, 'admin')).fetchone()
        
        if user and check_password_hash(user['password'], password):
            if not user['email_verified']:
                return '''
                <!DOCTYPE html>
                <html>
                <head><title>–û—à–∏–±–∫–∞</title></head>
                <body style="font-family: Arial; text-align: center; padding: 50px;">
                    <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!</p>
                    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à email –ø–µ—Ä–µ–¥ –≤—Ö–æ–¥–æ–º.</p>
                    <a href="/admin/register" style="color: #3498db;">‚Üê –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
                </body>
                </html>
                '''
            
            session['user_id'] = user['id']
            session['user_email'] = email
            session['user_name'] = f"{user['first_name']} {user['last_name']}"
            session['user_role'] = user['role']
            return redirect('/dashboard')
        else:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å!</p>
                <a href="/admin/login" style="color: #3498db;">‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
            </body>
            </html>
            '''
    
    return f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }}
            .container {{
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }}
            .form-group {{
                margin-bottom: 20px;
            }}
            label {{
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }}
            input {{
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }}
            input:focus {{
                border-color: #2c3e50;
                outline: none;
            }}
            .btn {{
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }}
            .btn-login {{
                background: #2c3e50;
                color: white;
            }}
            .btn-login:hover {{
                background: #1a252f;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
            .register-link {{
                text-align: center;
                margin-top: 20px;
            }}
            .test-account {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
                border-left: 4px solid #2c3e50;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            
            <div class="test-account">
                <strong>üîë –¢–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç:</strong><br>
                –õ–æ–≥–∏–Ω: {TEST_ACCOUNTS['admin']['email']}<br>
                –ü–∞—Ä–æ–ª—å: {TEST_ACCOUNTS['admin']['password']}
            </div>
            
            <form method="POST" action="/admin/login">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <button type="submit" class="btn btn-login">–í–æ–π—Ç–∏</button>
                <a href="/admin" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
            
            <div class="register-link">
                <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/admin/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ====================

@app.route('/dashboard')
def dashboard():
    """–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞"""
    if 'user_id' not in session:
        return redirect('/')
    
    role = session.get('user_role')
    
    if role == 'student':
        return student_dashboard()
    elif role == 'chef':
        return chef_dashboard()
    elif role == 'admin':
        return admin_dashboard()
    
    return redirect('/')

def student_dashboard():
    """–ü–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–∞"""
    db = get_db()
    today = date.today()
    today_str = today.strftime('%Y-%m-%d')
    
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        session.clear()
        return redirect('/')
    
    user_allergens = db.execute('SELECT allergen FROM user_allergens WHERE user_id = ?', (session.get('user_id'),)).fetchall()
    user_allergens_list = [a['allergen'] for a in user_allergens]
    
    allergens_display = ', '.join([ALLERGENS_DISPLAY.get(a, a) for a in user_allergens_list])
    if not allergens_display:
        allergens_display = '‚úÖ –ù–µ—Ç –∞–ª–ª–µ—Ä–≥–∏–π'
    
    if not user['email_verified']:
        return '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
            <meta charset="utf-8">
            <style>
                body { 
                    font-family: 'Arial', sans-serif; 
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 500px;
                    width: 100%;
                    text-align: center;
                }
                .warning-icon {
                    font-size: 4em;
                    color: #f39c12;
                    margin-bottom: 20px;
                }
                h1 {
                    color: #2c3e50;
                    margin-bottom: 20px;
                }
                .btn {
                    display: inline-block;
                    background: #3498db;
                    color: white;
                    padding: 15px 30px;
                    border-radius: 10px;
                    text-decoration: none;
                    margin-top: 20px;
                    font-size: 1.1em;
                }
                .logout-btn {
                    background: #e74c3c;
                    margin-left: 10px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h1>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∞—à email.</p>
                <a href="/logout" class="btn logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </body>
        </html>
        '''
    
    menu = db.execute('SELECT * FROM menu WHERE day = ? AND available = 1', (today_str,)).fetchall()
    
    subscriptions = db.execute('''
        SELECT s.*, m.name as menu_name, m.price, m.meal_type
        FROM subscriptions s
        JOIN menu m ON s.menu_id = m.id
        WHERE s.user_id = ? AND s.status = '–∞–∫—Ç–∏–≤–µ–Ω'
        ORDER BY s.created_at DESC
    ''', (session.get('user_id'),)).fetchall()
    
    issued_today = db.execute('''
        SELECT im.*, m.name as menu_name
        FROM issued_meals im
        JOIN menu m ON im.menu_id = m.id
        WHERE im.user_id = ? AND im.issue_date = ? 
        ORDER BY im.created_at DESC
    ''', (session.get('user_id'), today_str)).fetchall()
    
    user_reviews = db.execute('''
        SELECT r.*, m.name as menu_name
        FROM reviews r
        JOIN menu m ON r.menu_id = m.id
        WHERE r.user_id = ?
        ORDER BY r.created_at DESC
        LIMIT 5
    ''', (session.get('user_id'),)).fetchall()
    
    user_orders = db.execute('''
        SELECT o.*, m.name as menu_name, m.price, m.meal_type
        FROM orders o
        JOIN menu m ON o.menu_id = m.id
        WHERE o.user_id = ?
        ORDER BY o.created_at DESC
        LIMIT 10
    ''', (session.get('user_id'),)).fetchall()
    
    allergens_modal = f'''
    <div id="allergensModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">‚ö†Ô∏è –ú–æ–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã</h2>
                <button onclick="closeAllergensModal()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p>–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É –≤–∞—Å –µ—Å—Ç—å –∞–ª–ª–µ—Ä–≥–∏—è:</p>
                <div id="allergensList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
    '''
    
    for key, value in ALLERGENS.items():
        is_checked = key in user_allergens_list or (not user_allergens_list and key == 'none')
        allergen_class = 'allergen-item' + (' selected' if is_checked else '')
        
        allergens_modal += f'''
                    <label class="{allergen_class}" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 5px;">
                        <input type="checkbox" name="user_allergens" value="{key}" style="margin-right: 10px;" { 'checked' if is_checked else '' }>
                        <span style="font-weight: bold; margin-right: 10px;">{ALLERGENS_DISPLAY.get(key, key)}</span>
                        <span style="color: #666; font-size: 0.9em;">{value}</span>
                    </label>
        '''
    
    allergens_modal += '''
                </div>
            </div>
            
            <button onclick="saveAllergens()" class="btn" style="background: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–ª–ª–µ—Ä–≥–µ–Ω—ã</button>
        </div>
    </div>
    '''
    
    qr_code_section = ''
    if user_orders:
        last_order = user_orders[0]
        qr_data = f'''
–ó–∞–∫–∞–∑ ‚Ññ{last_order['id'][:8]}
–£—á–µ–Ω–∏–∫: {user['first_name']} {user['last_name']}
–ö–ª–∞—Å—Å: {user['class_name']}
–ë–ª—é–¥–æ: {last_order['menu_name']}
–¶–µ–Ω–∞: {last_order['price']} —Ä—É–±.
–î–∞—Ç–∞: {last_order['created_at'][:10] if last_order['created_at'] else today_str}
–°—Ç–∞—Ç—É—Å: {last_order['status']}
        '''
        qr_img = generate_qr_code(qr_data)
        qr_code_section = f'''
        <div class="section">
            <h2>üì± –ú–æ–π QR-–∫–æ–¥</h2>
            <div style="text-align: center;">
                <img src="{qr_img}" alt="QR-–∫–æ–¥" style="max-width: 200px; margin: 0 auto 15px; display: block;">
                <p><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> {last_order['id'][:8]}</p>
                <p><strong>–ë–ª—é–¥–æ:</strong> {last_order['menu_name']}</p>
                <p><strong>–¶–µ–Ω–∞:</strong> {last_order['price']} —Ä—É–±.</p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {last_order['status']}</p>
                <p style="font-size: 0.9em; color: #7f8c8d;">–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ—Ç QR-–∫–æ–¥ –ø–æ–≤–∞—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞</p>
            </div>
        </div>
        '''
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–ü–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: #f0f8ff;
                margin: 0;
                padding: 20px;
            }}
            .header {{ 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; 
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                position: relative;
            }}
            .header-buttons {{
                position: absolute;
                top: 30px;
                right: 30px;
                display: flex;
                gap: 10px;
            }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-bottom: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            .menu-grid {{ 
                display: grid; 
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
                gap: 25px;
                margin-top: 30px;
            }}
            .menu-card {{ 
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                transition: transform 0.3s;
                border-left: 5px solid #3498db;
                position: relative;
            }}
            .menu-card.has-allergen {{
                border-left: 5px solid #e74c3c;
                background: #fff5f5;
            }}
            .menu-card:hover {{
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            }}
            .btn {{ 
                background: #27ae60; 
                color: white; 
                padding: 12px 25px;
                border: none; 
                border-radius: 8px; 
                cursor: pointer; 
                margin-top: 15px;
                font-size: 1em;
                transition: background 0.3s;
                display: inline-block;
                text-decoration: none;
            }}
            .btn:hover {{ 
                background: #219653; 
            }}
            .btn-allergens {{
                background: #f39c12;
                margin-left: 10px;
            }}
            .btn-allergens:hover {{
                background: #e67e22;
            }}
            .btn-subscription {{
                background: #3498db;
                margin-left: 10px;
            }}
            .btn-subscription:hover {{
                background: #2980b9;
            }}
            .btn-review {{
                background: #9b59b6;
                margin-left: 10px;
            }}
            .btn-review:hover {{
                background: #8e44ad;
            }}
            .balance {{ 
                font-size: 1.8em; 
                color: #2ecc71; 
                font-weight: bold; 
                background: rgba(255, 255, 255, 0.2);
                padding: 10px 20px;
                border-radius: 10px;
                display: inline-block;
                margin: 10px 0;
            }}
            .logout-btn {{
                background: #e74c3c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                transition: background 0.3s;
            }}
            .logout-btn:hover {{ 
                background: #c0392b; 
            }}
            .allergens-info {{
                background: rgba(255, 255, 255, 0.2);
                padding: 8px 15px;
                border-radius: 8px;
                display: inline-block;
                margin: 10px 0;
                border: 1px solid rgba(255, 255, 255, 0.3);
            }}
            .allergen-tag {{
                display: inline-block;
                background: #ff6b6b;
                color: white;
                padding: 3px 10px;
                border-radius: 15px;
                font-size: 0.8em;
                margin: 2px;
            }}
            .warning-banner {{
                background: #ff6b6b;
                color: white;
                padding: 10px 15px;
                border-radius: 8px;
                margin: 10px 0;
                border-left: 5px solid #e74c3c;
                display: flex;
                align-items: center;
            }}
            .subscription-card {{
                background: #e8f4fc;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #3498db;
            }}
            .issued-card {{
                background: #e8f6e8;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #27ae60;
            }}
            .order-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #9b59b6;
            }}
        </style>
    </head>
    <body>
        <div class="header">
            <div class="header-buttons">
                <button onclick="openAllergensModal()" class="btn btn-allergens">‚ö†Ô∏è –ú–æ–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã</button>
                <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>
            
            <h1>üë®‚Äçüéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user['first_name']} {user['last_name']}!</h1>
            <div class="user-info">
                <p><strong>–ö–ª–∞—Å—Å:</strong> {user['class_name']} | <strong>–ë–∞–ª–∞–Ω—Å:</strong> <span class="balance" id="userBalance">{user['balance']} —Ä—É–±.</span></p>
                <div class="allergens-info">
                    ‚ö†Ô∏è <strong>–í–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã:</strong> {allergens_display}
                </div>
            </div>
        </div>
        
        {allergens_modal}
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>üìã –í–∞—à–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã:</h2>
    '''
    
    if subscriptions:
        for sub in subscriptions:
            selected_dates = json.loads(sub['selected_dates'])
            html += f'''
                <div class="subscription-card">
                    <h4>{sub['menu_name']} ({sub['meal_type']})</h4>
                    <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> {sub['start_date']} - {sub['end_date']}</p>
                    <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {sub['total_price']} —Ä—É–±.</p>
                    <p><strong>–í—ã–±—Ä–∞–Ω–æ –¥–Ω–µ–π:</strong> {len(selected_dates)}</p>
                </div>
            '''
    else:
        html += '<p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üì± –ú–æ–∏ –∑–∞–∫–∞–∑—ã:</h2>
    '''
    
    if user_orders:
        for order in user_orders[:5]:
            html += f'''
                <div class="order-card">
                    <h4>{order['menu_name']} ({order['meal_type']})</h4>
                    <p><strong>–¶–µ–Ω–∞:</strong> {order['price']} —Ä—É–±.</p>
                    <p><strong>–î–∞—Ç–∞:</strong> {order['created_at'][:10] if order['created_at'] else '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {order['status']}</p>
                </div>
            '''
    else:
        html += '<p>–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>'
    
    html += '''
            </div>
        </div>
        
        '''
    
    if qr_code_section:
        html += f'''
        <div class="dashboard-grid">
            {qr_code_section}
            
            <div class="section">
                <h2>üçΩÔ∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</h2>
        '''
        
        if issued_today:
            for meal in issued_today:
                html += f'''
                    <div class="issued-card">
                        <h4>{meal['menu_name']}</h4>
                        <p><strong>–í—Ä–µ–º—è –≤—ã–¥–∞—á–∏:</strong> {meal['created_at'][11:16] if meal['created_at'] else '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    </div>
                '''
        else:
            html += '<p>–°–µ–≥–æ–¥–Ω—è –≤—ã –µ—â–µ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –ø–∏—Ç–∞–Ω–∏–µ.</p>'
        
        html += '''
            </div>
        </div>
        '''
    
    html += f'''
        <h2>üçΩÔ∏è –ú–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({today_str}):</h2>
        
        <div class="menu-grid">
    '''
    
    if menu:
        for item in menu:
            menu_allergens = db.execute('SELECT allergen FROM menu_allergens WHERE menu_id = ?', (item['id'],)).fetchall()
            menu_allergens_list = [a['allergen'] for a in menu_allergens]
            
            user_allergens_set = set(user_allergens_list)
            menu_allergens_set = set(menu_allergens_list)
            common_allergens = user_allergens_set.intersection(menu_allergens_set)
            
            has_user_allergen = len(common_allergens) > 0
            
            avg_rating = db.execute('''
                SELECT AVG(rating) as avg_rating, COUNT(*) as review_count 
                FROM reviews 
                WHERE menu_id = ?
            ''', (item['id'],)).fetchone()
            
            avg_rating_value = avg_rating['avg_rating'] if avg_rating['avg_rating'] else 0
            review_count = avg_rating['review_count'] or 0
            
            has_subscription_today = False
            for sub in subscriptions:
                selected_dates = json.loads(sub['selected_dates'])
                if sub['menu_id'] == item['id'] and today_str in selected_dates:
                    has_subscription_today = True
                    break
            
            allergens_tags = ''
            for allergen in menu_allergens_list:
                if allergen != 'none':
                    display_name = ALLERGENS_DISPLAY.get(allergen, allergen)
                    is_user_allergen = allergen in user_allergens_list
                    tag_class = 'allergen-tag' + (' user-allergen' if is_user_allergen else '')
                    style = 'background: #ff6b6b;' if is_user_allergen else 'background: #95a5a6;'
                    allergens_tags += f'<span class="{tag_class}" style="{style}">{display_name}</span>'
            
            html += f'''
            <div class="menu-card {'has-allergen' if has_user_allergen else ''}">
                {f'<div class="warning-banner"><span class="warning-icon">‚ö†Ô∏è</span>–°–æ–¥–µ—Ä–∂–∏—Ç –≤–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã!</div>' if has_user_allergen else ''}
                <h3>{item['name']}</h3>
                <p>{item['description']}</p>
                <p><strong>–¶–µ–Ω–∞:</strong> {item['price']} —Ä—É–±.</p>
                
                {f'<div class="allergens-tags">{allergens_tags}</div>' if allergens_tags else ''}
                
                <div>
                    <button onclick="orderItem('{item['id']}', {str(has_user_allergen).lower()})" class="btn">–ó–∞–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</button>
            '''
            
            if not has_subscription_today:
                html += f'''<button onclick="openSubscriptionForm('{item['id']}', '{item['name']}', {item['price']}, '{item['meal_type']}')" class="btn btn-subscription">–û—Ñ–æ—Ä–º–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç</button>'''
            else:
                html += '''<button class="btn" style="background: #95a5a6;" disabled>–ê–±–æ–Ω–µ–º–µ–Ω—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω</button>'''
            
            html += f'''
                    <button onclick="openReviewForm('{item['id']}', '{item['name']}')" class="btn btn-review">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </div>
            </div>
            '''
    else:
        html += '<p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –º–µ–Ω—é –Ω–µ—Ç.</p>'
    
    html += '''
        </div>
        
        <div id="subscriptionModal" class="calendar-container">
            <div class="calendar">
                <div class="calendar-header">
                    <h2 id="subscriptionTitle">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞</h2>
                    <button onclick="closeSubscriptionForm()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                
                <div class="calendar-grid">
                    <div class="calendar-day-header">–ü–Ω</div>
                    <div class="calendar-day-header">–í—Ç</div>
                    <div class="calendar-day-header">–°—Ä</div>
                    <div class="calendar-day-header">–ß—Ç</div>
                    <div class="calendar-day-header">–ü—Ç</div>
                    <div class="calendar-day-header" style="color: #e74c3c;">–°–±</div>
                    <div class="calendar-day-header" style="color: #e74c3c;">–í—Å</div>
    '''
    
    for i in range(42):
        day_date = today + timedelta(days=i)
        date_str = day_date.strftime('%Y-%m-%d')
        day_name = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'][day_date.weekday()]
        is_weekend = day_date.weekday() >= 5
        is_today = i == 0
        
        day_class = 'calendar-day'
        if is_today:
            day_class += ' today'
        if is_weekend:
            day_class += ' weekend'
        
        html += f'''
            <div class="{day_class}" data-date="{date_str}" onclick="toggleDate('{date_str}')">
                {day_date.day}
            </div>
        '''
    
    html += '''
                </div>
                
                <div class="selected-dates">
                    <h4>üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã:</h4>
                    <div id="selectedDatesList"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <p><strong>–¶–µ–Ω–∞ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å:</strong> <span id="dayPrice">0</span> —Ä—É–±.</p>
                    <p><strong>–í—ã–±—Ä–∞–Ω–æ –¥–Ω–µ–π:</strong> <span id="selectedDaysCount">0</span></p>
                    <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> <span id="totalPrice" style="font-size: 1.5em; color: #27ae60; font-weight: bold;">0</span> —Ä—É–±.</p>
                </div>
                
                <input type="hidden" id="selectedMenuId" value="">
                <input type="hidden" id="selectedMenuPrice" value="0">
                
                <div style="margin-top: 30px;">
                    <button onclick="createSubscription()" class="btn" style="font-size: 1.2em; padding: 15px 30px;">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç</button>
                    <button onclick="closeSubscriptionForm()" class="btn" style="background: #95a5a6; margin-left: 10px;">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <div id="reviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                <h3 id="reviewTitle">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
                <div id="ratingStars" class="rating-stars">
                    <span data-rating="1">‚òÜ</span>
                    <span data-rating="2">‚òÜ</span>
                    <span data-rating="3">‚òÜ</span>
                    <span data-rating="4">‚òÜ</span>
                    <span data-rating="5">‚òÜ</span>
                </div>
                <input type="hidden" id="selectedRating" value="0">
                <input type="hidden" id="selectedMenuIdReview" value="">
                <input type="hidden" id="editReviewId" value="">
                <textarea id="reviewComment" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤ –∑–¥–µ—Å—å..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px;"></textarea>
                <div style="margin-top: 20px;">
                    <button onclick="submitReview()" class="btn" style="margin-right: 10px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                    <button onclick="closeReviewForm()" class="btn" style="background: #95a5a6;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <div id="message" style="margin-top: 40px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"></div>
        
        <script>
            let selectedDates = new Set();
            let currentRating = 0;
            let dayPrice = 0;
            
            function orderItem(menuId, hasAllergen) {{
                if (hasAllergen) {{
                    if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\\n\\n–≠—Ç–æ –±–ª—é–¥–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞—à–∏ –∞–ª–ª–µ—Ä–≥–µ–Ω—ã!\\n\\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å –µ–≥–æ?')) {{
                        return;
                    }}
                }}
                
                fetch('/api/order', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{menu_id: menuId}})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', '‚úÖ <strong>–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</strong><br>üí∞ <strong>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:</strong> ' + data.new_balance + ' —Ä—É–±.');
                        document.getElementById('userBalance').textContent = data.new_balance + ' —Ä—É–±.';
                        setTimeout(() => location.reload(), 2000);
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            function openAllergensModal() {{
                document.getElementById('allergensModal').style.display = 'flex';
            }}
            
            function closeAllergensModal() {{
                document.getElementById('allergensModal').style.display = 'none';
            }}
            
            function saveAllergens() {{
                const checkboxes = document.querySelectorAll('input[name="user_allergens"]:checked');
                const allergens = Array.from(checkboxes).map(cb => cb.value);
                
                fetch('/api/update-allergens', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{allergens: allergens}})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', '‚úÖ –ê–ª–ª–µ—Ä–≥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
                        closeAllergensModal();
                        setTimeout(() => location.reload(), 1500);
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            function openSubscriptionForm(menuId, menuName, price, mealType) {{
                document.getElementById('subscriptionTitle').textContent = '–ê–±–æ–Ω–µ–º–µ–Ω—Ç: ' + menuName + ' (' + mealType + ')';
                document.getElementById('selectedMenuId').value = menuId;
                document.getElementById('selectedMenuPrice').value = price;
                document.getElementById('dayPrice').textContent = price;
                
                selectedDates.clear();
                updateSelectedDatesList();
                updatePrice();
                
                document.getElementById('subscriptionModal').style.display = 'flex';
                dayPrice = price;
            }}
            
            function closeSubscriptionForm() {{
                document.getElementById('subscriptionModal').style.display = 'none';
            }}
            
            function toggleDate(date) {{
                if (selectedDates.has(date)) {{
                    selectedDates.delete(date);
                }} else {{
                    selectedDates.add(date);
                }}
                
                updateCalendarSelection();
                updateSelectedDatesList();
                updatePrice();
            }}
            
            function updateCalendarSelection() {{
                document.querySelectorAll('.calendar-day').forEach(day => {{
                    const date = day.getAttribute('data-date');
                    if (selectedDates.has(date)) {{
                        day.classList.add('selected');
                    }} else {{
                        day.classList.remove('selected');
                    }}
                }});
            }}
            
            function updateSelectedDatesList() {{
                const container = document.getElementById('selectedDatesList');
                container.innerHTML = '';
                
                const sortedDates = Array.from(selectedDates).sort();
                
                sortedDates.forEach(date => {{
                    const dateObj = new Date(date);
                    const dateStr = dateObj.toLocaleDateString('ru-RU', {{
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short'
                    }});
                    
                    const chip = document.createElement('div');
                    chip.className = 'date-chip';
                    chip.innerHTML = `
                        ${{dateStr}}
                        <button onclick="removeDate('${{date}}')">‚úï</button>
                    `;
                    container.appendChild(chip);
                }});
                
                document.getElementById('selectedDaysCount').textContent = selectedDates.size;
            }}
            
            function removeDate(date) {{
                selectedDates.delete(date);
                updateCalendarSelection();
                updateSelectedDatesList();
                updatePrice();
            }}
            
            function updatePrice() {{
                const totalPrice = dayPrice * selectedDates.size;
                document.getElementById('totalPrice').textContent = totalPrice;
            }}
            
            function createSubscription() {{
                const menuId = document.getElementById('selectedMenuId').value;
                const dates = Array.from(selectedDates);
                
                if (dates.length === 0) {{
                    showMessage('error', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –¥–∞—Ç—É –¥–ª—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞');
                    return;
                }}
                
                const sortedDates = dates.sort();
                const startDate = sortedDates[0];
                const endDate = sortedDates[sortedDates.length - 1];
                const totalPrice = dayPrice * dates.length;
                
                fetch('/api/subscription', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{
                        menu_id: menuId,
                        selected_dates: dates,
                        start_date: startDate,
                        end_date: endDate,
                        total_price: totalPrice
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', '‚úÖ <strong>–ê–±–æ–Ω–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</strong><br>' +
                            'üìÖ <strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</strong> ' + data.days_count + '<br>' +
                            'üí∞ <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ' + data.total_price + ' —Ä—É–±.<br>' +
                            'üí≥ <strong>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:</strong> ' + data.new_balance + ' —Ä—É–±.');
                        
                        document.getElementById('userBalance').textContent = data.new_balance + ' —Ä—É–±.';
                        
                        closeSubscriptionForm();
                        setTimeout(() => location.reload(), 3000);
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            function openReviewForm(menuId, menuName) {{
                document.getElementById('reviewTitle').textContent = '–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤: ' + menuName;
                document.getElementById('selectedMenuIdReview').value = menuId;
                document.getElementById('editReviewId').value = '';
                document.getElementById('reviewComment').value = '';
                currentRating = 0;
                updateStars();
                document.getElementById('reviewModal').style.display = 'flex';
            }}
            
            function closeReviewForm() {{
                document.getElementById('reviewModal').style.display = 'none';
            }}
            
            function updateStars() {{
                const stars = document.querySelectorAll('#ratingStars span');
                stars.forEach((star, index) => {{
                    if (index < currentRating) {{
                        star.textContent = '‚òÖ';
                        star.style.color = '#f39c12';
                    }} else {{
                        star.textContent = '‚òÜ';
                        star.style.color = '#ddd';
                    }}
                }});
                document.getElementById('selectedRating').value = currentRating;
            }}
            
            function submitReview() {{
                const menuId = document.getElementById('selectedMenuIdReview').value;
                const rating = currentRating;
                const comment = document.getElementById('reviewComment').value.trim();
                const reviewId = document.getElementById('editReviewId').value;
                
                if (rating === 0) {{
                    showMessage('error', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
                    return;
                }}
                
                if (!comment) {{
                    showMessage('error', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
                    return;
                }}
                
                const url = reviewId ? '/api/review/' + reviewId : '/api/review';
                const method = reviewId ? 'PUT' : 'POST';
                
                fetch(url, {{
                    method: method,
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{
                        menu_id: menuId,
                        rating: rating,
                        comment: comment
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', reviewId ? '‚úÖ –û—Ç–∑—ã–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '‚úÖ –û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                        closeReviewForm();
                        setTimeout(() => location.reload(), 2000);
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            document.addEventListener('DOMContentLoaded', function() {{
                const stars = document.querySelectorAll('#ratingStars span');
                stars.forEach(star => {{
                    star.addEventListener('click', function() {{
                        currentRating = parseInt(this.getAttribute('data-rating'));
                        updateStars();
                    }});
                    
                    star.addEventListener('mouseover', function() {{
                        const hoverRating = parseInt(this.getAttribute('data-rating'));
                        const stars = document.querySelectorAll('#ratingStars span');
                        stars.forEach((s, index) => {{
                            if (index < hoverRating) {{
                                s.style.color = '#f39c12';
                            }} else {{
                                s.style.color = '#ddd';
                            }}
                        }});
                    }});
                    
                    star.addEventListener('mouseout', function() {{
                        updateStars();
                    }});
                }});
                
                const allergenCheckboxes = document.querySelectorAll('input[name="user_allergens"]');
                allergenCheckboxes.forEach(checkbox => {{
                    checkbox.addEventListener('change', function() {{
                        const parent = this.parentElement;
                        if (this.checked) {{
                            parent.classList.add('selected');
                        }} else {{
                            parent.classList.remove('selected');
                        }}
                        
                        if (this.value === 'none' && this.checked) {{
                            allergenCheckboxes.forEach(cb => {{
                                if (cb !== this) {{
                                    cb.checked = false;
                                    cb.parentElement.classList.remove('selected');
                                }}
                            }});
                        }}
                        
                        if (this.value !== 'none' && this.checked) {{
                            const noneCheckbox = document.querySelector('input[value="none"]');
                            if (noneCheckbox) {{
                                noneCheckbox.checked = false;
                                noneCheckbox.parentElement.classList.remove('selected');
                            }}
                        }}
                    }});
                }});
            }});
            
            function showMessage(type, content) {{
                const messageDiv = document.getElementById('message');
                if (type === 'error') {{
                    messageDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border-left: 5px solid #e74c3c;">' + content + '</div>';
                }} else {{
                    messageDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; border-left: 5px solid #27ae60;">' + content + '</div>';
                }}
                messageDiv.scrollIntoView({{behavior: 'smooth'}});
            }}
        </script>
    </body>
    </html>
    '''
    
    return html

def chef_dashboard():
    """–ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞"""
    db = get_db()
    today = date.today().strftime('%Y-%m-%d')
    
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        session.clear()
        return redirect('/')
    
    if not user['email_verified']:
        return '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
            <meta charset="utf-8">
            <style>
                body { 
                    font-family: 'Arial', sans-serif; 
                    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 500px;
                    width: 100%;
                    text-align: center;
                }
                .warning-icon {
                    font-size: 4em;
                    color: #f39c12;
                    margin-bottom: 20px;
                }
                h1 {
                    color: #2c3e50;
                    margin-bottom: 20px;
                }
                .btn {
                    display: inline-block;
                    background: #e67e22;
                    color: white;
                    padding: 15px 30px;
                    border-radius: 10px;
                    text-decoration: none;
                    margin-top: 20px;
                    font-size: 1.1em;
                }
                .logout-btn {
                    background: #e74c3c;
                    margin-left: 10px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h1>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∞—à email.</p>
                <a href="/logout" class="btn logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </body>
        </html>
        '''
    
    orders = db.execute('''
        SELECT o.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.price, m.meal_type
        FROM orders o
        JOIN users u ON o.user_id = u.id
        JOIN menu m ON o.menu_id = m.id
        WHERE DATE(o.created_at) = ?
        ORDER BY o.created_at DESC
    ''', (today,)).fetchall()
    
    subscriptions_today = db.execute('''
        SELECT s.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.price, m.meal_type
        FROM subscriptions s
        JOIN users u ON s.user_id = u.id
        JOIN menu m ON s.menu_id = m.id
        WHERE s.status = '–∞–∫—Ç–∏–≤–µ–Ω' AND json_extract(s.selected_dates, '$') LIKE ?
        ORDER BY s.created_at DESC
    ''', (f'%{today}%',)).fetchall()
    
    meals_to_issue = db.execute('''
        SELECT im.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.meal_type
        FROM issued_meals im
        JOIN users u ON im.user_id = u.id
        JOIN menu m ON im.menu_id = m.id
        WHERE im.issue_date = ? AND im.status = '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏'
        ORDER BY im.created_at ASC
    ''', (today,)).fetchall()
    
    issued_meals = db.execute('''
        SELECT im.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.meal_type
        FROM issued_meals im
        JOIN users u ON im.user_id = u.id
        JOIN menu m ON im.menu_id = m.id
        WHERE im.issue_date = ? AND im.status = '–≤—ã–¥–∞–Ω' AND im.issued_by = ?
        ORDER BY im.created_at DESC
        LIMIT 20
    ''', (today, session.get('user_id'))).fetchall()
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{
                font-family: 'Arial', sans-serif;
                background: #fff8f0;
                margin: 0;
                padding: 20px;
            }}
            .header {{
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                margin-bottom: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            .meal-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #e67e22;
            }}
            .meal-card.issued {{
                border-left-color: #27ae60;
                background: #e8f6e8;
            }}
            .btn {{
                background: #e67e22;
                color: white;
                padding: 8px 16px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
                transition: background 0.3s;
            }}
            .btn:hover {{
                background: #d35400;
            }}
            .btn-issue {{
                background: #27ae60;
            }}
            .btn-issue:hover {{
                background: #219653;
            }}
            .logout-btn {{
                background: #e74c3c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-left: 20px;
                transition: background 0.3s;
            }}
            .logout-btn:hover {{
                background: #c0392b;
            }}
            .statistics {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }}
            .stat-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                text-align: center;
            }}
            .stat-value {{
                font-size: 1.5em;
                font-weight: bold;
                color: #e67e22;
                margin: 5px 0;
            }}
            .fridge-btn {{
                background: #3498db;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-left: 10px;
                transition: background 0.3s;
            }}
            .fridge-btn:hover {{
                background: #2980b9;
            }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üë®‚Äçüç≥ –ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user['first_name']} {user['last_name']}!</p>
            <p><strong>–î–∞—Ç–∞:</strong> {today}</p>
            <div>
                <a href="/chef/fridge" class="fridge-btn">üßä –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫</a>
                <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </div>
        
        <div class="statistics">
            <div class="stat-card">
                <div class="stat-value">{len(orders)}</div>
                <div>–†–∞–∑–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(subscriptions_today)}</div>
                <div>–ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(meals_to_issue)}</div>
                <div>–û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(issued_meals)}</div>
                <div>–í—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>‚è≥ –û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏:</h2>
    '''
    
    if meals_to_issue:
        for meal in meals_to_issue:
            user_allergens = db.execute('SELECT allergen FROM user_allergens WHERE user_id = ?', (meal['user_id'],)).fetchall()
            user_allergens_list = [a['allergen'] for a in user_allergens]
            
            menu_allergens = db.execute('SELECT allergen FROM menu_allergens WHERE menu_id = ?', (meal['menu_id'],)).fetchall()
            menu_allergens_list = [a['allergen'] for a in menu_allergens]
            
            common_allergens = set(user_allergens_list).intersection(set(menu_allergens_list))
            has_allergen_warning = len(common_allergens) > 0
            
            html += f'''
                <div class="meal-card">
                    <h4>{meal['menu_name']} ({meal['meal_type']}) {f'<span style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è –ê–õ–õ–ï–†–ì–ï–ù–´!</span>' if has_allergen_warning else ''}</h4>
                    <p><strong>–£—á–µ–Ω–∏–∫:</strong> {meal['first_name']} {meal['last_name']} ({meal['class_name']})</p>
                    {f'<p style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è –£ —É—á–µ–Ω–∏–∫–∞ –µ—Å—Ç—å –∞–ª–ª–µ—Ä–≥–∏—è –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —ç—Ç–æ–≥–æ –±–ª—é–¥–∞!</p>' if has_allergen_warning else ''}
                    <button onclick="issueMeal('{meal['id']}')" class="btn btn-issue">‚úÖ –í—ã–¥–∞—Ç—å</button>
                </div>
            '''
    else:
        html += '<p>–ù–µ—Ç –±–ª—é–¥, –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–¥–∞—á–∏.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üìã –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:</h2>
    '''
    
    if subscriptions_today:
        for sub in subscriptions_today:
            html += f'''
                <div class="meal-card">
                    <h4>{sub['menu_name']} ({sub['meal_type']})</h4>
                    <p><strong>–£—á–µ–Ω–∏–∫:</strong> {sub['first_name']} {sub['last_name']} ({sub['class_name']})</p>
                    <button onclick="createIssueFromSubscription('{sub['id']}', '{sub['menu_id']}', '{sub['user_id']}')" class="btn btn-issue">‚úÖ –í—ã–¥–∞—Ç—å –ø–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—É</button>
                </div>
            '''
    else:
        html += '<p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>‚úÖ –í—ã–¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –≤–∞–º–∏:</h2>
    '''
    
    if issued_meals:
        for meal in issued_meals:
            html += f'''
                <div class="meal-card issued">
                    <h4>{meal['menu_name']} ({meal['meal_type']})</h4>
                    <p><strong>–£—á–µ–Ω–∏–∫:</strong> {meal['first_name']} {meal['last_name']} ({meal['class_name']})</p>
                    <p><strong>–í—Ä–µ–º—è –≤—ã–¥–∞—á–∏:</strong> {meal['created_at'][11:16] if meal['created_at'] else '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                </div>
            '''
    else:
        html += '<p>–í—ã –µ—â–µ –Ω–µ –≤—ã–¥–∞–≤–∞–ª–∏ –±–ª—é–¥ —Å–µ–≥–æ–¥–Ω—è.</p>'
    
    html += '''
            </div>
        </div>
        
        <div id="message" style="margin-top: 40px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"></div>
        
        <script>
            function issueMeal(mealId) {{
                fetch('/api/issue-meal', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{meal_id: mealId}})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', '‚úÖ –ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–æ!');
                        setTimeout(() => location.reload(), 1500);
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            function createIssueFromSubscription(subscriptionId, menuId, userId) {{
                fetch('/api/issue-from-subscription', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{
                        subscription_id: subscriptionId,
                        menu_id: menuId,
                        user_id: userId
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', '‚úÖ –ó–∞–ø–∏—Å—å –Ω–∞ –≤—ã–¥–∞—á—É —Å–æ–∑–¥–∞–Ω–∞! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–í—ã–¥–∞—Ç—å" –≤ —Å–ø–∏—Å–∫–µ –æ–∂–∏–¥–∞—é—â–∏—Ö.');
                        setTimeout(() => location.reload(), 1500);
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            function showMessage(type, content) {{
                const messageDiv = document.getElementById('message');
                if (type === 'error') {{
                    messageDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border-left: 5px solid #e74c3c;">' + content + '</div>';
                }} else {{
                    messageDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; border-left: 5px solid #27ae60;">' + content + '</div>';
                }}
                messageDiv.scrollIntoView({{behavior: 'smooth'}});
            }}
        </script>
    </body>
    </html>
    '''
    
    return html

@app.route('/chef/fridge')
def chef_fridge():
    """–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –ø–æ–≤–∞—Ä–∞ - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏"""
    if 'user_id' not in session or session.get('user_role') != 'chef':
        return redirect('/')
    
    db = get_db()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
    ingredients = db.execute('SELECT * FROM ingredients_stock ORDER BY name').fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–≤–∞—Ä–∞
    my_requests = db.execute('''
        SELECT sr.*, u.first_name, u.last_name
        FROM supply_requests sr
        JOIN users u ON sr.requested_by = u.id
        WHERE sr.requested_by = ? AND sr.status = '–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏'
        ORDER BY sr.created_at DESC
    ''', (session.get('user_id'),)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞—è–≤–æ–∫
    request_history = db.execute('''
        SELECT sr.*, u.first_name, u.last_name, admin.first_name as admin_first_name, admin.last_name as admin_last_name
        FROM supply_requests sr
        JOIN users u ON sr.requested_by = u.id
        LEFT JOIN users admin ON sr.processed_by = admin.id
        WHERE sr.requested_by = ? AND sr.status != '–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏'
        ORDER BY sr.created_at DESC
        LIMIT 20
    ''', (session.get('user_id'),)).fetchall()
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{
                font-family: 'Arial', sans-serif;
                background: #e8f4fc;
                margin: 0;
                padding: 20px;
            }}
            .header {{
                background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                margin-bottom: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            .ingredient-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #3498db;
            }}
            .ingredient-card.low {{
                border-left-color: #e74c3c;
                background: #ffe6e6;
            }}
            .ingredient-card.medium {{
                border-left-color: #f39c12;
                background: #fff3cd;
            }}
            .ingredient-card.good {{
                border-left-color: #27ae60;
                background: #e8f6e8;
            }}
            .stock-bar {{
                height: 10px;
                background: #e0e0e0;
                border-radius: 5px;
                margin: 5px 0;
                overflow: hidden;
            }}
            .stock-fill {{
                height: 100%;
                background: #27ae60;
            }}
            .stock-fill.low {{
                background: #e74c3c;
            }}
            .stock-fill.medium {{
                background: #f39c12;
            }}
            .btn {{
                background: #3498db;
                color: white;
                padding: 8px 16px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
                transition: background 0.3s;
            }}
            .btn:hover {{
                background: #2980b9;
            }}
            .btn-order {{
                background: #9b59b6;
            }}
            .btn-order:hover {{
                background: #8e44ad;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-top: 20px;
            }}
            .btn-back:hover {{
                background: #7f8c8d;
            }}
            .request-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #f39c12;
            }}
            .request-card.approved {{
                border-left-color: #27ae60;
                background: #e8f6e8;
            }}
            .request-card.rejected {{
                border-left-color: #e74c3c;
                background: #ffe6e6;
            }}
            .status-badge {{
                display: inline-block;
                padding: 3px 8px;
                border-radius: 12px;
                font-size: 0.8em;
                font-weight: bold;
                margin-left: 10px;
            }}
            .status-pending {{ background: #f39c12; color: white; }}
            .status-approved {{ background: #27ae60; color: white; }}
            .status-rejected {{ background: #e74c3c; color: white; }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üßä –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –ø–æ–≤–∞—Ä–∞</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ –∏ –∑–∞–∫–∞–∑–∞–º–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</p>
            <a href="/dashboard" class="btn-back">‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞</a>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>üì¶ –°–∫–ª–∞–¥ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h2>
                <p>–í—Å–µ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: {len(ingredients)}</p>
    '''
    
    if ingredients:
        for ingredient in ingredients:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–∞–ø–∞—Å–æ–≤
            stock_percentage = (ingredient['current_stock'] / ingredient['min_stock']) * 100 if ingredient['min_stock'] > 0 else 100
            card_class = 'ingredient-card'
            fill_class = 'stock-fill'
            
            if stock_percentage < 30:
                card_class += ' low'
                fill_class += ' low'
            elif stock_percentage < 70:
                card_class += ' medium'
                fill_class += ' medium'
            else:
                card_class += ' good'
            
            html += f'''
                <div class="{card_class}">
                    <h4>{ingredient['name']}</h4>
                    <p><strong>–ù–∞ —Å–∫–ª–∞–¥–µ:</strong> {ingredient['current_stock']} {ingredient['unit']}</p>
                    <p><strong>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å:</strong> {ingredient['min_stock']} {ingredient['unit']}</p>
                    <div class="stock-bar">
                        <div class="{fill_class}" style="width: {min(stock_percentage, 100)}%"></div>
                    </div>
                    <p><strong>–£—Ä–æ–≤–µ–Ω—å –∑–∞–ø–∞—Å–∞:</strong> {stock_percentage:.1f}%</p>
                    <button onclick="openOrderModal('{ingredient['id']}', '{ingredient['name']}', '{ingredient['unit']}')" class="btn btn-order">üì¶ –ó–∞–∫–∞–∑–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É</button>
                </div>
            '''
    else:
        html += '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞—Ö.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏</h2>
    '''
    
    if my_requests:
        for req in my_requests:
            html += f'''
                <div class="request-card">
                    <h4>{req['ingredient_name']} <span class="status-badge status-pending">{req['status']}</span></h4>
                    <p><strong>–ó–∞–ø—Ä–æ—à–µ–Ω–æ:</strong> {req['requested_quantity']} {req['unit']}</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> {req['created_at'][:10]}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –û–∂–∏–¥–∞–µ—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</p>
                </div>
            '''
    else:
        html += '<p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h2>
    '''
    
    if request_history:
        for req in request_history:
            status_class = f'status-{req["status"]}'
            card_class = 'request-card'
            if req['status'] == '–æ–¥–æ–±—Ä–µ–Ω–æ':
                card_class += ' approved'
                status_class = 'status-approved'
            elif req['status'] == '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ':
                card_class += ' rejected'
                status_class = 'status-rejected'
            
            processed_by = f'{req["admin_first_name"]} {req["admin_last_name"]}' if req['admin_first_name'] else '–Ω–µ —É–∫–∞–∑–∞–Ω'
            
            html += f'''
                <div class="{card_class}">
                    <h4>{req['ingredient_name']} <span class="status-badge {status_class}">{req['status']}</span></h4>
                    <p><strong>–ó–∞–ø—Ä–æ—à–µ–Ω–æ:</strong> {req['requested_quantity']} {req['unit']}</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> {req['created_at'][:10]}</p>
                    <p><strong>–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ:</strong> {req['processed_at'][:10] if req['processed_at'] else '–Ω–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ'}</p>
                    <p><strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</strong> {processed_by}</p>
                    {f'<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {req["admin_comment"]}</p>' if req['admin_comment'] else ''}
                </div>
            '''
    else:
        html += '<p>–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ –ø—É—Å—Ç–∞.</p>'
    
    html += '''
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–∞ –ø–æ—Å—Ç–∞–≤–∫–∏ -->
        <div id="orderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                <h2>üì¶ –ó–∞–∫–∞–∑ –ø–æ—Å—Ç–∞–≤–∫–∏</h2>
                
                <div class="form-group">
                    <label for="ingredientName">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:</label>
                    <input type="text" id="ingredientName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;" readonly>
                </div>
                
                <div class="form-group">
                    <label for="orderQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ({'<span id="orderUnit">–≥—Ä</span>'})</label>
                    <input type="number" id="orderQuantity" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;" min="1" step="1" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                </div>
                
                <div class="form-group">
                    <label for="orderReason">–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–∫–∞–∑–∞:</label>
                    <textarea id="orderReason" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; height: 100px;" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–∫–∞–∑–∞"></textarea>
                </div>
                
                <input type="hidden" id="ingredientId" value="">
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="submitOrder()" class="btn" style="flex: 1;">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                    <button onclick="closeOrderModal()" class="btn" style="background: #95a5a6; flex: 1;">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <div id="message" style="margin-top: 40px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"></div>
        
        <script>
            function openOrderModal(ingredientId, ingredientName, unit) {{
                document.getElementById('ingredientId').value = ingredientId;
                document.getElementById('ingredientName').value = ingredientName;
                document.getElementById('orderUnit').textContent = unit;
                document.getElementById('orderQuantity').value = '';
                document.getElementById('orderReason').value = '';
                document.getElementById('orderModal').style.display = 'flex';
            }}
            
            function closeOrderModal() {{
                document.getElementById('orderModal').style.display = 'none';
            }}
            
            function submitOrder() {{
                const ingredientId = document.getElementById('ingredientId').value;
                const quantity = document.getElementById('orderQuantity').value;
                const reason = document.getElementById('orderReason').value.trim();
                
                if (!quantity || quantity <= 0) {{
                    showMessage('error', '‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
                    return;
                }}
                
                if (!reason) {{
                    showMessage('error', '‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–∫–∞–∑–∞');
                    return;
                }}
                
                fetch('/api/supply-request', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{
                        ingredient_id: ingredientId,
                        quantity: parseFloat(quantity),
                        reason: reason
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', '‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É!');
                        closeOrderModal();
                        setTimeout(() => location.reload(), 2000);
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            function showMessage(type, content) {{
                const messageDiv = document.getElementById('message');
                if (type === 'error') {{
                    messageDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border-left: 5px solid #e74c3c;">' + content + '</div>';
                }} else {{
                    messageDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; border-left: 5px solid #27ae60;">' + content + '</div>';
                }}
                messageDiv.scrollIntoView({{behavior: 'smooth'}});
            }}
        </script>
    </body>
    </html>
    '''
    
    return html

def admin_dashboard():
    """–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    db = get_db()
    today = date.today().strftime('%Y-%m-%d')
    
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        session.clear()
        return redirect('/')
    
    if not user['email_verified']:
        return '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</title>
            <meta charset="utf-8">
            <style>
                body { 
                    font-family: 'Arial', sans-serif; 
                    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                    min-height: 100vh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 20px;
                }
                .container {
                    background: white;
                    padding: 40px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    max-width: 500px;
                    width: 100%;
                    text-align: center;
                }
                .warning-icon {
                    font-size: 4em;
                    color: #f39c12;
                    margin-bottom: 20px;
                }
                h1 {
                    color: #2c3e50;
                    margin-bottom: 20px;
                }
                .btn {
                    display: inline-block;
                    background: #2c3e50;
                    color: white;
                    padding: 15px 30px;
                    border-radius: 10px;
                    text-decoration: none;
                    margin-top: 20px;
                    font-size: 1.1em;
                }
                .logout-btn {
                    background: #e74c3c;
                    margin-left: 10px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h1>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email</h1>
                <p>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∞—à email.</p>
                <a href="/logout" class="btn logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </body>
        </html>
        '''
    
    users_stats = db.execute('''
        SELECT 
            COUNT(*) as total_users,
            SUM(CASE WHEN role = 'student' THEN 1 ELSE 0 END) as total_students,
            SUM(CASE WHEN role = 'chef' THEN 1 ELSE 0 END) as total_chefs,
            SUM(CASE WHEN role = 'admin' THEN 1 ELSE 0 END) as total_admins
        FROM users
    ''').fetchone()
    
    total_users = users_stats['total_users'] or 0
    total_students = users_stats['total_students'] or 0
    total_chefs = users_stats['total_chefs'] or 0
    total_admins = users_stats['total_admins'] or 0
    
    orders_stats = db.execute('''
        SELECT 
            COUNT(*) as order_count,
            COALESCE(SUM(m.price), 0) as revenue
        FROM orders o 
        LEFT JOIN menu m ON o.menu_id = m.id
    ''').fetchone()
    
    total_orders_count = orders_stats['order_count'] or 0
    total_revenue = orders_stats['revenue'] or 0
    
    subscriptions_stats = db.execute('''
        SELECT 
            COUNT(*) as sub_count,
            COALESCE(SUM(total_price), 0) as sub_revenue
        FROM subscriptions 
        WHERE status = '–∞–∫—Ç–∏–≤–µ–Ω'
    ''').fetchone()
    
    total_subs = subscriptions_stats['sub_count'] or 0
    total_sub_revenue = subscriptions_stats['sub_revenue'] or 0
    
    issued_today = db.execute('''
        SELECT COUNT(*) as count 
        FROM issued_meals 
        WHERE issue_date = ? AND status = '–≤—ã–¥–∞–Ω'
    ''', (today,)).fetchone()['count'] or 0
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏
    supply_requests = db.execute('''
        SELECT sr.*, u.first_name, u.last_name
        FROM supply_requests sr
        JOIN users u ON sr.requested_by = u.id
        WHERE sr.status = '–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏'
        ORDER BY sr.created_at DESC
    ''').fetchall()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º
    ingredients_stats = db.execute('''
        SELECT 
            COUNT(*) as total_ingredients,
            SUM(CASE WHEN current_stock < min_stock THEN 1 ELSE 0 END) as low_stock_count,
            SUM(CASE WHEN current_stock >= min_stock AND current_stock < min_stock * 1.5 THEN 1 ELSE 0 END) as medium_stock_count,
            SUM(CASE WHEN current_stock >= min_stock * 1.5 THEN 1 ELSE 0 END) as good_stock_count
        FROM ingredients_stock
    ''').fetchone()
    
    recent_users = db.execute('''
        SELECT * FROM users 
        ORDER BY created_at DESC 
        LIMIT 10
    ''').fetchall()
    
    recent_orders = db.execute('''
        SELECT o.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.price
        FROM orders o
        JOIN users u ON o.user_id = u.id
        JOIN menu m ON o.menu_id = m.id
        ORDER BY o.created_at DESC 
        LIMIT 10
    ''').fetchall()
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{
                font-family: 'Arial', sans-serif;
                background: #f8f9fa;
                margin: 0;
                padding: 20px;
            }}
            .header {{
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                margin-bottom: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            .stats-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }}
            .stat-card {{
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                text-align: center;
            }}
            .stat-value {{
                font-size: 2em;
                font-weight: bold;
                color: #2c3e50;
                margin: 10px 0;
            }}
            .stat-label {{
                color: #7f8c8d;
                font-size: 0.9em;
            }}
            .revenue {{ color: #27ae60; }}
            .users {{ color: #3498db; }}
            .orders {{ color: #9b59b6; }}
            .logout-btn {{
                background: #e74c3c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-left: 20px;
                transition: background 0.3s;
            }}
            .logout-btn:hover {{ background: #c0392b; }}
            .table {{
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }}
            .table th {{
                background: #f8f9fa;
                padding: 12px;
                text-align: left;
                border-bottom: 2px solid #e0e0e0;
                color: #2c3e50;
            }}
            .table td {{
                padding: 12px;
                border-bottom: 1px solid #e0e0e0;
            }}
            .table tr:hover {{
                background: #f8f9fa;
            }}
            .badge {{
                display: inline-block;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 0.8em;
                font-weight: bold;
            }}
            .badge-student {{ background: #3498db; color: white; }}
            .badge-chef {{ background: #e67e22; color: white; }}
            .badge-admin {{ background: #2c3e50; color: white; }}
            .request-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #f39c12;
            }}
            .btn {{
                background: #3498db;
                color: white;
                padding: 8px 16px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
                transition: background 0.3s;
            }}
            .btn:hover {{ background: #2980b9; }}
            .btn-approve {{ background: #27ae60; }}
            .btn-approve:hover {{ background: #219653; }}
            .btn-reject {{ background: #e74c3c; }}
            .btn-reject:hover {{ background: #c0392b; }}
            .supply-btn {{
                background: #9b59b6;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-left: 10px;
                transition: background 0.3s;
            }}
            .supply-btn:hover {{ background: #8e44ad; }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user['first_name']} {user['last_name']}!</p>
            <p><strong>–î–∞—Ç–∞:</strong> {today}</p>
            <div>
                <a href="/admin/supplies" class="supply-btn">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏</a>
                <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value users">{total_users}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-value orders">{total_orders_count}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value revenue">{total_revenue + total_sub_revenue:.0f} —Ä—É–±.</div>
                <div class="stat-label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{total_students}</div>
                <div class="stat-label">–£—á–µ–Ω–∏–∫–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{total_chefs}</div>
                <div class="stat-label">–ü–æ–≤–∞—Ä–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{issued_today}</div>
                <div class="stat-label">–í—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(supply_requests)}</div>
                <div class="stat-label">–ó–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{ingredients_stats['low_stock_count'] or 0}</div>
                <div class="stat-label">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –º–∞–ª–æ</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>üì¶ –ó–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</h2>
    '''
    
    if supply_requests:
        for req in supply_requests:
            html += f'''
                <div class="request-card" id="request-{req['id']}">
                    <h4>{req['ingredient_name']}</h4>
                    <p><strong>–ü–æ–≤–∞—Ä:</strong> {req['first_name']} {req['last_name']}</p>
                    <p><strong>–ó–∞–ø—Ä–æ—à–µ–Ω–æ:</strong> {req['requested_quantity']} {req['unit']}</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> {req['created_at'][:10]}</p>
                    <div style="margin-top: 10px;">
                        <button onclick="processRequest('{req['id']}', 'approve')" class="btn btn-approve">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                        <button onclick="processRequest('{req['id']}', 'reject')" class="btn btn-reject">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            '''
    else:
        html += '<p>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üë• –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>Email</th>
                            <th>–†–æ–ª—å</th>
                            <th>–î–∞—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody>
    '''
    
    for user_row in recent_users:
        role_badge = f'<span class="badge badge-{user_row["role"]}">{user_row["role"]}</span>'
        html += f'''
                        <tr>
                            <td>{user_row['first_name']} {user_row['last_name']}</td>
                            <td>{user_row['email']}</td>
                            <td>{role_badge}</td>
                            <td>{user_row['created_at'][:10] if user_row['created_at'] else ''}</td>
                        </tr>
        '''
    
    html += '''
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>–£—á–µ–Ω–∏–∫</th>
                            <th>–ë–ª—é–¥–æ</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
    '''
    
    for order in recent_orders:
        html += f'''
                        <tr>
                            <td>{order['first_name']} {order['last_name']} ({order['class_name']})</td>
                            <td>{order['menu_name']}</td>
                            <td>{order['price']} —Ä—É–±.</td>
                            <td>{order['created_at'][:10] if order['created_at'] else ''}</td>
                            <td>{order['status']}</td>
                        </tr>
        '''
    
    html += '''
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="message" style="margin-top: 40px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"></div>
        
        <script>
            function processRequest(requestId, action) {{
                const comment = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–µ—à–µ–Ω–∏—é:');
                if (comment === null) return;
                
                fetch('/api/process-supply-request', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{
                        request_id: requestId,
                        action: action,
                        comment: comment
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.error) {{
                        showMessage('error', data.error);
                    }} else {{
                        showMessage('success', `‚úÖ –ó–∞—è–≤–∫–∞ ${{action === 'approve' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}}!`);
                        document.getElementById(`request-${{requestId}}`).remove();
                    }}
                }})
                .catch(error => {{
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                }});
            }}
            
            function showMessage(type, content) {{
                const messageDiv = document.getElementById('message');
                if (type === 'error') {{
                    messageDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border-left: 5px solid #e74c3c;">' + content + '</div>';
                }} else {{
                    messageDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; border-left: 5px solid #27ae60;">' + content + '</div>';
                }}
                messageDiv.scrollIntoView({{behavior: 'smooth'}});
            }}
        </script>
    </body>
    </html>
    '''
    
    return html

@app.route('/admin/supplies')
def admin_supplies():
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    if 'user_id' not in session or session.get('user_role') != 'admin':
        return redirect('/')
    
    db = get_db()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
    ingredients = db.execute('SELECT * FROM ingredients_stock ORDER BY name').fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏
    all_requests = db.execute('''
        SELECT sr.*, u.first_name, u.last_name, 
               admin.first_name as admin_first_name, admin.last_name as admin_last_name
        FROM supply_requests sr
        JOIN users u ON sr.requested_by = u.id
        LEFT JOIN users admin ON sr.processed_by = admin.id
        ORDER BY sr.created_at DESC
    ''').fetchall()
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏</title>
        <meta charset="utf-8">
        <style>
            body {{
                font-family: 'Arial', sans-serif;
                background: #f8f9fa;
                margin: 0;
                padding: 20px;
            }}
            .header {{
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 60px rgba(0,0,0,0.3);
            }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                margin-bottom: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            .ingredient-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #3498db;
            }}
            .request-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
            }}
            .request-pending {{
                border-left: 4px solid #f39c12;
                background: #fff3cd;
            }}
            .request-approved {{
                border-left: 4px solid #27ae60;
                background: #e8f6e8;
            }}
            .request-rejected {{
                border-left: 4px solid #e74c3c;
                background: #ffe6e6;
            }}
            .btn-back {{
                background: #95a5a6;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-top: 20px;
            }}
            .btn-back:hover {{ background: #7f8c8d; }}
            .status-badge {{
                display: inline-block;
                padding: 3px 8px;
                border-radius: 12px;
                font-size: 0.8em;
                font-weight: bold;
            }}
            .status-pending {{ background: #f39c12; color: white; }}
            .status-approved {{ background: #27ae60; color: white; }}
            .status-rejected {{ background: #e74c3c; color: white; }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∞–º–∏</h1>
            <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ –∏ –∑–∞—è–≤–∫–∞–º–∏</p>
            <a href="/dashboard" class="btn-back">‚Üê –ù–∞–∑–∞–¥ –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤</h2>
                <p>–í—Å–µ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤: {len(ingredients)}</p>
    '''
    
    if ingredients:
        for ingredient in ingredients:
            stock_percentage = (ingredient['current_stock'] / ingredient['min_stock']) * 100 if ingredient['min_stock'] > 0 else 100
            status_color = '#27ae60'
            if stock_percentage < 30:
                status_color = '#e74c3c'
            elif stock_percentage < 70:
                status_color = '#f39c12'
            
            html += f'''
                <div class="ingredient-card">
                    <h4>{ingredient['name']}</h4>
                    <p><strong>–ù–∞ —Å–∫–ª–∞–¥–µ:</strong> {ingredient['current_stock']} {ingredient['unit']}</p>
                    <p><strong>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–ø–∞—Å:</strong> {ingredient['min_stock']} {ingredient['unit']}</p>
                    <p><strong>–£—Ä–æ–≤–µ–Ω—å –∑–∞–ø–∞—Å–∞:</strong> <span style="color: {status_color};">{stock_percentage:.1f}%</span></p>
                </div>
            '''
    else:
        html += '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞—Ö.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üìã –í—Å–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</h2>
    '''
    
    if all_requests:
        for req in all_requests:
            status_class = f'status-{req["status"]}'
            card_class = 'request-card'
            
            if req['status'] == '–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏':
                card_class += ' request-pending'
                status_class = 'status-pending'
            elif req['status'] == '–æ–¥–æ–±—Ä–µ–Ω–æ':
                card_class += ' request-approved'
                status_class = 'status-approved'
            elif req['status'] == '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ':
                card_class += ' request-rejected'
                status_class = 'status-rejected'
            
            processed_by = f'{req["admin_first_name"]} {req["admin_last_name"]}' if req['admin_first_name'] else '–Ω–µ —É–∫–∞–∑–∞–Ω'
            
            html += f'''
                <div class="{card_class}">
                    <h4>{req['ingredient_name']} <span class="status-badge {status_class}">{req['status']}</span></h4>
                    <p><strong>–ü–æ–≤–∞—Ä:</strong> {req['first_name']} {req['last_name']}</p>
                    <p><strong>–ó–∞–ø—Ä–æ—à–µ–Ω–æ:</strong> {req['requested_quantity']} {req['unit']}</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞—è–≤–∫–∏:</strong> {req['created_at'][:10]}</p>
                    <p><strong>–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ:</strong> {req['processed_at'][:10] if req['processed_at'] else '–Ω–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–æ'}</p>
                    <p><strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</strong> {processed_by}</p>
                    {f'<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> {req["admin_comment"]}</p>' if req['admin_comment'] else ''}
                </div>
            '''
    else:
        html += '<p>–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏.</p>'
    
    html += '''
            </div>
        </div>
    </body>
    </html>
    '''
    
    return html

# ==================== API –ú–ï–¢–û–î–´ ====================

@app.route('/api/order', methods=['POST'])
def create_order():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""
    if 'user_id' not in session or session.get('user_role') != 'student':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401
    
    data = request.json
    menu_id = data.get('menu_id')
    
    if not menu_id:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω–æ –±–ª—é–¥–æ'}), 400
    
    db = get_db()
    
    today = date.today().strftime('%Y-%m-%d')
    menu_item = db.execute('SELECT * FROM menu WHERE id = ? AND day = ? AND available = 1', (menu_id, today)).fetchone()
    
    if not menu_item:
        return jsonify({'error': '–ë–ª—é–¥–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}), 400
    
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if user['balance'] < menu_item['price']:
        return jsonify({'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ'}), 400
    
    order_id = str(uuid.uuid4())
    db.execute('''
        INSERT INTO orders (id, user_id, menu_id, status)
        VALUES (?, ?, ?, '–æ–ø–ª–∞—á–µ–Ω')
    ''', (order_id, session.get('user_id'), menu_id))
    
    new_balance = user['balance'] - menu_item['price']
    db.execute('UPDATE users SET balance = ? WHERE id = ?', (new_balance, session.get('user_id')))
    
    issue_id = str(uuid.uuid4())
    db.execute('''
        INSERT INTO issued_meals (id, user_id, menu_id, issue_date, meal_type, status)
        VALUES (?, ?, ?, ?, ?, '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏')
    ''', (issue_id, session.get('user_id'), menu_id, today, menu_item['meal_type']))
    
    db.commit()
    
    return jsonify({
        'success': True,
        'order_id': order_id,
        'new_balance': new_balance,
        'price': menu_item['price']
    })

@app.route('/api/subscription', methods=['POST'])
def create_subscription():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞"""
    if 'user_id' not in session or session.get('user_role') != 'student':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401
    
    data = request.json
    menu_id = data.get('menu_id')
    selected_dates = data.get('selected_dates', [])
    start_date = data.get('start_date')
    end_date = data.get('end_date')
    total_price = data.get('total_price')
    
    if not all([menu_id, selected_dates, start_date, end_date, total_price]):
        return jsonify({'error': '–ù–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∫–∞–∑–∞–Ω—ã'}), 400
    
    db = get_db()
    
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if user['balance'] < total_price:
        return jsonify({'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ'}), 400
    
    existing_subs = db.execute('''
        SELECT * FROM subscriptions 
        WHERE user_id = ? AND menu_id = ? AND status = '–∞–∫—Ç–∏–≤–µ–Ω'
    ''', (session.get('user_id'), menu_id)).fetchall()
    
    for sub in existing_subs:
        sub_dates = json.loads(sub['selected_dates'])
        common_dates = set(sub_dates).intersection(set(selected_dates))
        if common_dates:
            return jsonify({'error': f'–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ —ç—Ç–∏ –¥–∞—Ç—ã: {", ".join(list(common_dates)[:3])}...'}), 400
    
    subscription_id = str(uuid.uuid4())
    db.execute('''
        INSERT INTO subscriptions (id, user_id, menu_id, selected_dates, start_date, end_date, total_price, status)
        VALUES (?, ?, ?, ?, ?, ?, ?, '–∞–∫—Ç–∏–≤–µ–Ω')
    ''', (subscription_id, session.get('user_id'), menu_id, json.dumps(selected_dates), start_date, end_date, total_price))
    
    new_balance = user['balance'] - total_price
    db.execute('UPDATE users SET balance = ? WHERE id = ?', (new_balance, session.get('user_id')))
    
    db.commit()
    
    return jsonify({
        'success': True,
        'subscription_id': subscription_id,
        'days_count': len(selected_dates),
        'total_price': total_price,
        'new_balance': new_balance
    })

@app.route('/api/issue-meal', methods=['POST'])
def issue_meal():
    """–í—ã–¥–∞—á–∞ –±–ª—é–¥–∞"""
    if 'user_id' not in session or session.get('user_role') != 'chef':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞'}), 401
    
    data = request.json
    meal_id = data.get('meal_id')
    
    if not meal_id:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω–æ –±–ª—é–¥–æ'}), 400
    
    db = get_db()
    
    db.execute('''
        UPDATE issued_meals 
        SET status = '–≤—ã–¥–∞–Ω', issued_by = ?
        WHERE id = ? AND status = '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏'
    ''', (session.get('user_id'), meal_id))
    
    db.commit()
    
    return jsonify({'success': True})

@app.route('/api/issue-from-subscription', methods=['POST'])
def issue_from_subscription():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –≤—ã–¥–∞—á–µ –∏–∑ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞"""
    if 'user_id' not in session or session.get('user_role') != 'chef':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞'}), 401
    
    data = request.json
    subscription_id = data.get('subscription_id')
    menu_id = data.get('menu_id')
    user_id = data.get('user_id')
    
    if not all([subscription_id, menu_id, user_id]):
        return jsonify({'error': '–ù–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∫–∞–∑–∞–Ω—ã'}), 400
    
    db = get_db()
    
    subscription = db.execute('SELECT * FROM subscriptions WHERE id = ? AND status = "–∞–∫—Ç–∏–≤–µ–Ω"', (subscription_id,)).fetchone()
    if not subscription:
        return jsonify({'error': '–ê–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω'}), 400
    
    today = date.today().strftime('%Y-%m-%d')
    selected_dates = json.loads(subscription['selected_dates'])
    
    if today not in selected_dates:
        return jsonify({'error': '–ù–∞ —Å–µ–≥–æ–¥–Ω—è —ç—Ç–æ—Ç –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç'}), 400
    
    existing_issue = db.execute('''
        SELECT * FROM issued_meals 
        WHERE user_id = ? AND menu_id = ? AND issue_date = ? AND subscription_id = ?
    ''', (user_id, menu_id, today, subscription_id)).fetchone()
    
    if existing_issue:
        return jsonify({'error': '–ó–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400
    
    issue_id = str(uuid.uuid4())
    
    menu_item = db.execute('SELECT meal_type FROM menu WHERE id = ?', (menu_id,)).fetchone()
    meal_type = menu_item['meal_type'] if menu_item else '–æ–±–µ–¥'
    
    db.execute('''
        INSERT INTO issued_meals (id, user_id, menu_id, subscription_id, issue_date, meal_type, status)
        VALUES (?, ?, ?, ?, ?, ?, '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏')
    ''', (issue_id, user_id, menu_id, subscription_id, today, meal_type))
    
    db.commit()
    
    return jsonify({'success': True, 'issue_id': issue_id})

@app.route('/api/review', methods=['POST'])
def create_review():
    """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞"""
    if 'user_id' not in session or session.get('user_role') != 'student':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401
    
    data = request.json
    menu_id = data.get('menu_id')
    rating = data.get('rating')
    comment = data.get('comment', '')
    
    if not menu_id or not rating:
        return jsonify({'error': '–ù–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∫–∞–∑–∞–Ω—ã'}), 400
    
    if rating < 1 or rating > 5:
        return jsonify({'error': '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5'}), 400
    
    db = get_db()
    
    existing_review = db.execute('SELECT * FROM reviews WHERE user_id = ? AND menu_id = ?', 
                                (session.get('user_id'), menu_id)).fetchone()
    
    if existing_review:
        return jsonify({'error': '–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ –±–ª—é–¥–æ'}), 400
    
    review_id = str(uuid.uuid4())
    db.execute('''
        INSERT INTO reviews (id, user_id, menu_id, rating, comment)
        VALUES (?, ?, ?, ?, ?)
    ''', (review_id, session.get('user_id'), menu_id, rating, comment))
    
    db.commit()
    
    return jsonify({'success': True, 'review_id': review_id})

@app.route('/api/review/<review_id>', methods=['PUT'])
def update_review(review_id):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞"""
    if 'user_id' not in session or session.get('user_role') != 'student':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401
    
    data = request.json
    rating = data.get('rating')
    comment = data.get('comment', '')
    
    if not rating:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω —Ä–µ–π—Ç–∏–Ω–≥'}), 400
    
    if rating < 1 or rating > 5:
        return jsonify({'error': '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5'}), 400
    
    db = get_db()
    
    review = db.execute('SELECT * FROM reviews WHERE id = ? AND user_id = ?', 
                       (review_id, session.get('user_id'))).fetchone()
    
    if not review:
        return jsonify({'error': '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
    
    db.execute('''
        UPDATE reviews 
        SET rating = ?, comment = ?, created_at = CURRENT_TIMESTAMP
        WHERE id = ?
    ''', (rating, comment, review_id))
    
    db.commit()
    
    return jsonify({'success': True})

@app.route('/api/update-allergens', methods=['POST'])
def update_user_allergens():
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if 'user_id' not in session or session.get('user_role') != 'student':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'}), 401
    
    data = request.json
    allergens = data.get('allergens', [])
    
    db = get_db()
    
    db.execute('DELETE FROM user_allergens WHERE user_id = ?', (session.get('user_id'),))
    
    for allergen in allergens:
        if allergen != 'none':
            allergen_id = str(uuid.uuid4())
            db.execute('''
                INSERT INTO user_allergens (id, user_id, allergen)
                VALUES (?, ?, ?)
            ''', (allergen_id, session.get('user_id'), allergen))
    
    db.commit()
    
    return jsonify({'success': True})

@app.route('/api/resend-code', methods=['POST'])
def resend_verification_code():
    """–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    data = request.json
    email = data.get('email')
    
    if not email:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω email'}), 400
    
    code = generate_verification_code(email)
    
    email_body = f'''
    –í—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
    
    –í–∞—à –Ω–æ–≤—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: {code}
    
    –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.
    
    –ï—Å–ª–∏ –≤—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ –Ω–æ–≤—ã–π –∫–æ–¥, –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.
    
    –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
    '''
    
    success = send_email(email, "–ù–æ–≤—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è", email_body)
    
    if success:
        return jsonify({'success': True, 'message': '–ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email'})
    else:
        return jsonify({'error': '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email'}), 500

@app.route('/api/resend-reset-code', methods=['POST'])
def resend_password_reset_code():
    """–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è"""
    data = request.json
    email = data.get('email')
    
    if not email:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω email'}), 400
    
    code = generate_password_reset_code(email)
    
    email_body = f'''
    –í—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –∫–æ–¥–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è.
    
    –í–∞—à –Ω–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è: {code}
    
    –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç.
    
    –ï—Å–ª–∏ –≤—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è, –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.
    
    –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
    '''
    
    success = send_email(email, "–ù–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è", email_body)
    
    if success:
        return jsonify({'success': True, 'message': '–ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email'})
    else:
        return jsonify({'error': '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email'}), 500

@app.route('/api/supply-request', methods=['POST'])
def create_supply_request():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É"""
    if 'user_id' not in session or session.get('user_role') != 'chef':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞'}), 401
    
    data = request.json
    ingredient_id = data.get('ingredient_id')
    quantity = data.get('quantity')
    reason = data.get('reason', '')
    
    if not ingredient_id or not quantity:
        return jsonify({'error': '–ù–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∫–∞–∑–∞–Ω—ã'}), 400
    
    if quantity <= 0:
        return jsonify({'error': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0'}), 400
    
    db = get_db()
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–µ
    ingredient = db.execute('SELECT * FROM ingredients_stock WHERE id = ?', (ingredient_id,)).fetchone()
    if not ingredient:
        return jsonify({'error': '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É
    request_id = str(uuid.uuid4())
    db.execute('''
        INSERT INTO supply_requests (id, ingredient_id, ingredient_name, requested_by, 
                                    requested_quantity, unit, status)
        VALUES (?, ?, ?, ?, ?, ?, '–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏')
    ''', (request_id, ingredient_id, ingredient['name'], session.get('user_id'), 
         quantity, ingredient['unit']))
    
    db.commit()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
    admins = db.execute('SELECT email, first_name, last_name FROM users WHERE role = "admin"').fetchall()
    
    for admin in admins:
        email_body = f'''
        –£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {admin['first_name']} {admin['last_name']}!
        
        –ü–æ–≤–∞—Ä {session.get('user_name')} –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É.
        
        –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏:
        ‚Ä¢ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç: {ingredient['name']}
        ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity} {ingredient['unit']}
        ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: {reason}
        ‚Ä¢ –î–∞—Ç–∞: {date.today().strftime('%d.%m.%Y')}
        
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
        
        –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
        –°–∏—Å—Ç–µ–º–∞ —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
        '''
        
        send_email(admin['email'], "üì¶ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É", email_body)
    
    return jsonify({'success': True, 'request_id': request_id})

@app.route('/api/process-supply-request', methods=['POST'])
def process_supply_request():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    if 'user_id' not in session or session.get('user_role') != 'admin':
        return jsonify({'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞'}), 401
    
    data = request.json
    request_id = data.get('request_id')
    action = data.get('action')  # 'approve' –∏–ª–∏ 'reject'
    comment = data.get('comment', '')
    
    if not request_id or not action:
        return jsonify({'error': '–ù–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —É–∫–∞–∑–∞–Ω—ã'}), 400
    
    if action not in ['approve', 'reject']:
        return jsonify({'error': '–ù–µ–≤–µ—Ä–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ'}), 400
    
    db = get_db()
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
    supply_request = db.execute('SELECT * FROM supply_requests WHERE id = ?', (request_id,)).fetchone()
    if not supply_request:
        return jsonify({'error': '–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404
    
    if supply_request['status'] != '–Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏':
        return jsonify({'error': '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞'}), 400
    
    status = '–æ–¥–æ–±—Ä–µ–Ω–æ' if action == 'approve' else '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ'
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
    db.execute('''
        UPDATE supply_requests 
        SET status = ?, admin_comment = ?, processed_at = CURRENT_TIMESTAMP, processed_by = ?
        WHERE id = ?
    ''', (status, comment, session.get('user_id'), request_id))
    
    # –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
    if action == 'approve':
        db.execute('''
            UPDATE ingredients_stock 
            SET current_stock = current_stock + ?, updated_at = CURRENT_TIMESTAMP
            WHERE id = ?
        ''', (supply_request['requested_quantity'], supply_request['ingredient_id']))
    
    db.commit()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–≤–∞—Ä—É
    chef = db.execute('SELECT email, first_name, last_name FROM users WHERE id = ?', 
                     (supply_request['requested_by'],)).fetchone()
    
    if chef:
        status_text = '–æ–¥–æ–±—Ä–µ–Ω–∞' if action == 'approve' else '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'
        email_body = f'''
        –£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {chef['first_name']} {chef['last_name']}!
        
        –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É –±—ã–ª–∞ {status_text} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
        
        –î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏:
        ‚Ä¢ –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç: {supply_request['ingredient_name']}
        ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {supply_request['requested_quantity']} {supply_request['unit']}
        ‚Ä¢ –°—Ç–∞—Ç—É—Å: {status}
        ‚Ä¢ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {comment}
        
        –° —É–≤–∞–∂–µ–Ω–∏–µ–º,
        –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è —à–∫–æ–ª—å–Ω–æ–π —Å—Ç–æ–ª–æ–≤–æ–π
        '''
        
        send_email(chef['email'], f"üì¶ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫—É {status_text}", email_body)
    
    return jsonify({'success': True, 'status': status})

# ==================== –í–´–•–û–î ====================

@app.route('/logout')
def logout():
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    session.clear()
    return redirect('/')

# ==================== –ó–ê–ö–†–´–¢–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• ====================

@app.teardown_appcontext
def close_db(error):
    """–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î"""
    if hasattr(g, 'db'):
        g.db.close()

# ==================== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================

if __name__ == '__main__':
    db_path = app.config['DATABASE']
    db_dir = os.path.dirname(db_path)
    
    if db_dir and not os.path.exists(db_dir):
        try:
            os.makedirs(db_dir, exist_ok=True)
            print(f"üìÅ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {db_dir}")
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é {db_dir}: {e}")
            app.config['DATABASE'] = os.path.basename(db_path)
    
    init_db()
    
    print("\n" + "="*60)
    print("‚úÖ –®–∫–æ–ª—å–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è –∑–∞–ø—É—â–µ–Ω–∞!")
    print("="*60)
    print("üåê –ê–¥—Ä–µ—Å: http://localhost:5000")
    print("\nüîë –¢–ï–°–¢–û–í–´–ï –ê–ö–ö–ê–£–ù–¢–´:")
    print("="*60)
    print(f"üë®‚Äçüéì –£—á–µ–Ω–∏–∫: {TEST_ACCOUNTS['student']['email']} / {TEST_ACCOUNTS['student']['password']}")
    print(f"üë®‚Äçüç≥ –ü–æ–≤–∞—Ä: {TEST_ACCOUNTS['chef']['email']} / {TEST_ACCOUNTS['chef']['password']}")
    print(f"üë®‚Äçüíº –ê–¥–º–∏–Ω: {TEST_ACCOUNTS['admin']['email']} / {TEST_ACCOUNTS['admin']['password']}")
    print("="*60)
    print("üßä –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –¥–ª—è –ø–æ–≤–∞—Ä–æ–≤")
    print("üì¶ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: –°–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ—Å—Ç–∞–≤–∫–∏")
    print("üîê –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –¥–ª—è —É—á–µ–Ω–∏–∫–æ–≤")
    print("üì± –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: QR-–∫–æ–¥—ã –¥–ª—è –∑–∞–∫–∞–∑–æ–≤")
    print("="*60 + "\n")
    
    app.run(host='0.0.0.0', port=5000, debug=True)
