# 🔄 Схема работы системы склада

## Процесс выдачи блюда

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПОВАР ВЫДАЕТ БЛЮДО                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. Получить информацию о блюде                                 │
│     - ID блюда                                                  │
│     - Название                                                  │
│     - Тип приема пищи                                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. Получить список ингредиентов                                │
│     SELECT * FROM menu_ingredients WHERE menu_id = ?            │
│                                                                 │
│     Результат:                                                  │
│     - Яйца: 3 шт                                                │
│     - Молоко: 0.1 л                                             │
│     - Ветчина: 0.08 кг                                          │
│     - Сыр: 0.04 кг                                              │
│     - Зелень: 0.01 кг                                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. Проверить наличие каждого ингредиента                       │
│                                                                 │
│     ┌──────────────────────────────────────┐                   │
│     │ Для каждого ингредиента:            │                   │
│     │                                      │                   │
│     │ SELECT quantity FROM inventory       │                   │
│     │ WHERE name = ingredient_name         │                   │
│     │                                      │                   │
│     │ IF quantity < required_quantity:     │                   │
│     │    ❌ ОШИБКА: Недостаточно          │                   │
│     │ ELSE:                                │                   │
│     │    ✅ OK                             │                   │
│     └──────────────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
        ┌───────────────────┐   ┌──────────────────┐
        │  ❌ НЕДОСТАТОЧНО  │   │  ✅ ВСЁ В НАЛИЧИИ│
        │   ИНГРЕДИЕНТОВ    │   │                  │
        └───────────────────┘   └──────────────────┘
                    │                   │
                    ▼                   ▼
        ┌───────────────────┐   ┌──────────────────────────────┐
        │ Показать ошибку:  │   │ 4. Списать ингредиенты       │
        │                   │   │                              │
        │ "Недостаточно:    │   │ Для каждого ингредиента:    │
        │ - Яйца (нужно 3,  │   │                              │
        │   есть 1)"        │   │ a) Получить текущее кол-во   │
        │                   │   │ b) Вычислить новое кол-во    │
        │ Выдача блокирована│   │ c) Обновить inventory        │
        └───────────────────┘   │ d) Записать в inventory_log  │
                                └──────────────────────────────┘
                                              │
                                              ▼
                                ┌──────────────────────────────┐
                                │ 5. Обновить статус блюда     │
                                │                              │
                                │ UPDATE issued_meals          │
                                │ SET status = 'выдан'         │
                                │ WHERE id = meal_id           │
                                └──────────────────────────────┘
                                              │
                                              ▼
                                ┌──────────────────────────────┐
                                │ ✅ БЛЮДО ВЫДАНО УСПЕШНО      │
                                │                              │
                                │ Уведомление:                 │
                                │ "Блюдо выдано успешно!       │
                                │  Ингредиенты списаны"        │
                                └──────────────────────────────┘
```

## Структура данных

### Таблица menu_ingredients
```
┌──────────────────────────────────────────────────────────┐
│ menu_ingredients                                         │
├──────────────┬───────────────────────────────────────────┤
│ id           │ "uuid-1234"                               │
│ menu_id      │ "menu-uuid-5678" (FK → menu.id)           │
│ ingredient   │ "Яйца"                                    │
│ quantity     │ 3.00                                      │
│ unit         │ "шт"                                      │
│ created_at   │ 2025-01-24 10:00:00                       │
└──────────────┴───────────────────────────────────────────┘
```

### Таблица inventory
```
┌──────────────────────────────────────────────────────────┐
│ inventory                                                │
├──────────────┬───────────────────────────────────────────┤
│ id           │ "inv-uuid-9012"                           │
│ name         │ "Яйца"                                    │
│ quantity     │ 500.00                                    │
│ unit         │ "шт"                                      │
│ min_quantity │ 100.00                                    │
│ created_at   │ 2025-01-24 08:00:00                       │
│ updated_at   │ 2025-01-24 14:30:00                       │
└──────────────┴───────────────────────────────────────────┘
```

### Таблица inventory_log
```
┌──────────────────────────────────────────────────────────┐
│ inventory_log                                            │
├──────────────────┬───────────────────────────────────────┤
│ id               │ "log-uuid-3456"                       │
│ inventory_id     │ "inv-uuid-9012" (FK → inventory.id)   │
│ action           │ "списание"                            │
│ quantity_change  │ -3.00                                 │
│ quantity_before  │ 500.00                                │
│ quantity_after   │ 497.00                                │
│ reason           │ "Выдача блюда (issued_meal: xxx)"     │
│ created_by       │ "user-uuid-7890" (FK → users.id)      │
│ created_at       │ 2025-01-24 14:30:00                   │
└──────────────────┴───────────────────────────────────────┘
```

## Пример: Выдача омлета

### Исходные данные

**Блюдо:** Омлет с ветчиной (menu_id: "omelet-123")

**Ингредиенты:**
```
menu_ingredients:
├─ Яйца: 3 шт
├─ Молоко: 0.1 л
├─ Ветчина: 0.08 кг
├─ Сыр: 0.04 кг
└─ Зелень: 0.01 кг
```

**Склад (до выдачи):**
```
inventory:
├─ Яйца: 500 шт
├─ Молоко: 100 л
├─ Ветчина: 20 кг
├─ Сыр: 15 кг
└─ Зелень: 10 кг
```

### Процесс выдачи

1. **Проверка наличия:**
   ```
   ✅ Яйца: нужно 3, есть 500
   ✅ Молоко: нужно 0.1, есть 100
   ✅ Ветчина: нужно 0.08, есть 20
   ✅ Сыр: нужно 0.04, есть 15
   ✅ Зелень: нужно 0.01, есть 10
   ```

2. **Списание:**
   ```sql
   -- Яйца
   UPDATE inventory SET quantity = 497 WHERE name = 'Яйца'
   INSERT INTO inventory_log (action, quantity_change, ...) 
   VALUES ('списание', -3, ...)
   
   -- Молоко
   UPDATE inventory SET quantity = 99.9 WHERE name = 'Молоко'
   INSERT INTO inventory_log (action, quantity_change, ...) 
   VALUES ('списание', -0.1, ...)
   
   -- И так далее для всех ингредиентов...
   ```

3. **Результат:**
   ```
   inventory (после выдачи):
   ├─ Яйца: 497 шт (-3)
   ├─ Молоко: 99.9 л (-0.1)
   ├─ Ветчина: 19.92 кг (-0.08)
   ├─ Сыр: 14.96 кг (-0.04)
   └─ Зелень: 9.99 кг (-0.01)
   ```

### История изменений

```
inventory_log:
┌────────────┬──────────┬────────┬────────┬────────┬─────────────────────────┐
│ Продукт    │ Действие │ Было   │ Стало  │ Δ      │ Причина                 │
├────────────┼──────────┼────────┼────────┼────────┼─────────────────────────┤
│ Яйца       │ списание │ 500    │ 497    │ -3     │ Выдача блюда (omelet)   │
│ Молоко     │ списание │ 100    │ 99.9   │ -0.1   │ Выдача блюда (omelet)   │
│ Ветчина    │ списание │ 20     │ 19.92  │ -0.08  │ Выдача блюда (omelet)   │
│ Сыр        │ списание │ 15     │ 14.96  │ -0.04  │ Выдача блюда (omelet)   │
│ Зелень     │ списание │ 10     │ 9.99   │ -0.01  │ Выдача блюда (omelet)   │
└────────────┴──────────┴────────┴────────┴────────┴─────────────────────────┘
```

## Сценарий: Недостаточно ингредиентов

### Исходные данные

**Блюдо:** Омлет с ветчиной

**Склад (критический):**
```
inventory:
├─ Яйца: 1 шт ⚠️
├─ Молоко: 0.05 л ⚠️
├─ Ветчина: 20 кг ✅
├─ Сыр: 15 кг ✅
└─ Зелень: 10 кг ✅
```

### Процесс выдачи

1. **Проверка наличия:**
   ```
   ❌ Яйца: нужно 3, есть 1
   ❌ Молоко: нужно 0.1, есть 0.05
   ✅ Ветчина: нужно 0.08, есть 20
   ✅ Сыр: нужно 0.04, есть 15
   ✅ Зелень: нужно 0.01, есть 10
   ```

2. **Результат:**
   ```
   ❌ ОШИБКА: Недостаточно ингредиентов на складе
   
   Детали:
   - Яйца (нужно 3 шт, есть 1 шт)
   - Молоко (нужно 0.1 л, есть 0.05 л)
   ```

3. **Действия повара:**
   - Создать заявку на закупку яиц
   - Создать заявку на закупку молока
   - Выбрать другое блюдо для выдачи

## Визуальные индикаторы

### Уровень запасов

```
🟢 Зеленый (>150% от минимума)
   ████████████████████ 100%
   Запасов достаточно

🟠 Оранжевый (100-150% от минимума)
   ████████████░░░░░░░░ 60%
   Требует внимания

🔴 Красный (<100% от минимума)
   ████░░░░░░░░░░░░░░░░ 20%
   Критически мало!
```

### Срочность заявок

```
🟢 Обычная
   Можно заказать в плановом порядке

🟠 Высокая
   Требуется в ближайшее время

🔴 Срочная
   Требуется немедленно!
   (анимация пульсации)
```

## API Endpoints

```
POST /api/chef/issue-meal
├─ Проверяет наличие ингредиентов
├─ Списывает со склада
├─ Логирует изменения
└─ Обновляет статус блюда

GET /api/chef/inventory-log?inventoryId=xxx&limit=50
├─ Возвращает историю изменений
└─ С информацией о пользователе

GET /api/chef/inventory/low-stock
├─ Возвращает продукты с низким запасом
└─ Отсортированные по критичности

GET /api/chef/menu/:menuId/ingredients
├─ Возвращает список ингредиентов блюда
└─ С количеством и единицами измерения
```

---

**Документация:** См. `md/INVENTORY_SYSTEM.md` для подробностей
