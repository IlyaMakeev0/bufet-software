# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 500 –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –î–∞—Ç–∞: 9 —Ñ–µ–≤—Ä–∞–ª—è 2026
## –û–±–Ω–æ–≤–ª–µ–Ω–æ: 9 —Ñ–µ–≤—Ä–∞–ª—è 2026 (–¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã)

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
DELETE /api/admin/users/{id} 500 (Internal Server Error)
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–ª—Å—è —É—Å–ø–µ—à–Ω–æ, –Ω–æ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–µ–Ω–∏—è –¥—Ä—É–≥–æ–≥–æ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞. –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–ª–æ –Ω–∞ —Ç–æ, —á—Ç–æ –Ω–µ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –±—ã–ª–∏ —É—á—Ç–µ–Ω—ã.

---

## üîç –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏ (Foreign Keys)

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö.

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–æ–ø—É—â–µ–Ω—ã:

1. **payment_security_logs** - –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂–µ–π
2. **login_attempts** - –ü–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
3. **two_factor_codes** - –ö–æ–¥—ã –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
4. **audit_logs** - –õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞
5. **inventory_logs** - –õ–æ–≥–∏ —Å–∫–ª–∞–¥–∞
6. **menu_requests.reviewed_by** - –°—Å—ã–ª–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª –∑–∞—è–≤–∫—É

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ü–æ–ª–Ω–æ–µ –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

–ü–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –í–°–ï–• —Ç–∞–±–ª–∏—Ü:

```javascript
const tablesToClean = [
  { name: 'orders', column: 'user_id' },
  { name: 'issued_meals', column: 'user_id' },
  { name: 'subscriptions', column: 'user_id' },
  { name: 'notifications', column: 'user_id' },
  { name: 'purchase_requests', column: 'created_by' },
  { name: 'menu_requests', column: 'created_by' },
  { name: 'password_reset_tokens', column: 'user_id' },
  { name: 'reviews', column: 'user_id' },
  { name: 'transaction_logs', column: 'user_id' },
  { name: 'payment_security_logs', column: 'user_id' },
  { name: 'login_attempts', column: 'user_id' },
  { name: 'two_factor_codes', column: 'user_id' },
  { name: 'audit_logs', column: 'user_id' },
  { name: 'inventory_logs', column: 'created_by' }
]
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ reviewed_by (SET NULL)

–î–ª—è –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ NULL:

```javascript
const reviewedByTables = [
  { name: 'menu_requests', column: 'reviewed_by' },
  { name: 'inventory_logs', column: 'created_by' }
]

for (const table of reviewedByTables) {
  await runQuery(`UPDATE ${table.name} SET ${table.column} = NULL WHERE ${table.column} = ?`, [id])
}
```

---

## üìù –ü–æ–ª–Ω—ã–π –∫–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### server/routes/admin.js

```javascript
router.delete('/users/:id', async (req, res) => {
  try {
    if (!req.session.user || req.session.user.role !== 'admin') {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    const { id } = req.params

    // Don't allow deleting yourself
    if (id === req.session.user.id) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç' })
    }

    // Check if user exists
    const user = await getQuery('SELECT id, email, role FROM users WHERE id = ?', [id])
    if (!user) {
      return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' })
    }

    console.log(`üóëÔ∏è Starting deletion of user ${user.email} (${user.role})`)

    // Delete related data first (cascade delete)
    const tablesToClean = [
      { name: 'orders', column: 'user_id' },
      { name: 'issued_meals', column: 'user_id' },
      { name: 'subscriptions', column: 'user_id' },
      { name: 'notifications', column: 'user_id' },
      { name: 'purchase_requests', column: 'created_by' },
      { name: 'menu_requests', column: 'created_by' },
      { name: 'password_reset_tokens', column: 'user_id' },
      { name: 'reviews', column: 'user_id' },
      { name: 'transaction_logs', column: 'user_id' },
      { name: 'payment_security_logs', column: 'user_id' },
      { name: 'login_attempts', column: 'user_id' },
      { name: 'two_factor_codes', column: 'user_id' },
      { name: 'audit_logs', column: 'user_id' },
      { name: 'inventory_logs', column: 'created_by' }
    ]

    for (const table of tablesToClean) {
      try {
        const result = await runQuery(`DELETE FROM ${table.name} WHERE ${table.column} = ?`, [id])
        console.log(`  ‚úì Deleted from ${table.name}`)
      } catch (tableError) {
        // Table might not exist or have different structure
        console.log(`  ‚ö† Could not delete from ${table.name}:`, tableError.message)
      }
    }

    // Also clean up reviewed_by references (SET NULL)
    const reviewedByTables = [
      { name: 'menu_requests', column: 'reviewed_by' },
      { name: 'inventory_logs', column: 'created_by' }
    ]

    for (const table of reviewedByTables) {
      try {
        await runQuery(`UPDATE ${table.name} SET ${table.column} = NULL WHERE ${table.column} = ?`, [id])
        console.log(`  ‚úì Cleaned ${table.column} in ${table.name}`)
      } catch (tableError) {
        console.log(`  ‚ö† Could not clean ${table.name}:`, tableError.message)
      }
    }

    // Delete user
    try {
      await runQuery('DELETE FROM users WHERE id = ?', [id])
      console.log(`‚úÖ Admin ${req.session.user.email} deleted user ${user.email} (${user.role})`)
      res.json({ message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω' })
    } catch (deleteError) {
      console.error('‚ùå Error deleting user:', deleteError)
      throw deleteError
    }

  } catch (error) {
    console.error('Delete user error:', error)
    console.error('Error stack:', error.stack)
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    })
  }
})
```

---

## üéØ –ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (DELETE):
1. ‚úÖ **orders** - –í—Å–µ –∑–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. ‚úÖ **issued_meals** - –í—Å–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –±–ª—é–¥–∞
3. ‚úÖ **subscriptions** - –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏
4. ‚úÖ **notifications** - –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
5. ‚úÖ **password_reset_tokens** - –¢–æ–∫–µ–Ω—ã —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
6. ‚úÖ **reviews** - –í—Å–µ –æ—Ç–∑—ã–≤—ã
7. ‚úÖ **transaction_logs** - –õ–æ–≥–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
8. ‚úÖ **payment_security_logs** - –õ–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂–µ–π
9. ‚úÖ **login_attempts** - –ü–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
10. ‚úÖ **two_factor_codes** - –ö–æ–¥—ã 2FA
11. ‚úÖ **audit_logs** - –õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞

### –î–ª—è –ø–æ–≤–∞—Ä–æ–≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (DELETE):
12. ‚úÖ **purchase_requests** - –ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–∫—É–ø–∫—É
13. ‚úÖ **menu_requests** - –ó–∞—è–≤–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ –±–ª—é–¥–∞
14. ‚úÖ **inventory_logs** - –õ–æ–≥–∏ —Å–∫–ª–∞–¥–∞

### –¢–∞–±–ª–∏—Ü—ã —Å SET NULL:
15. ‚úÖ **menu_requests.reviewed_by** - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è NULL
16. ‚úÖ **inventory_logs.created_by** - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è NULL (–µ—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

---

## üõ°Ô∏è –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

```javascript
console.log(`üóëÔ∏è Starting deletion of user ${user.email} (${user.role})`)

for (const table of tablesToClean) {
  try {
    await runQuery(`DELETE FROM ${table.name} WHERE ${table.column} = ?`, [id])
    console.log(`  ‚úì Deleted from ${table.name}`)
  } catch (tableError) {
    console.log(`  ‚ö† Could not delete from ${table.name}:`, tableError.message)
  }
}
```

### –ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:

```
üóëÔ∏è Starting deletion of user student@example.com (student)
  ‚úì Deleted from orders
  ‚úì Deleted from issued_meals
  ‚úì Deleted from subscriptions
  ‚úì Deleted from notifications
  ‚ö† Could not delete from purchase_requests: table does not exist
  ‚úì Deleted from menu_requests
  ‚úì Deleted from password_reset_tokens
  ‚úì Deleted from reviews
  ‚úì Deleted from transaction_logs
  ‚úì Deleted from payment_security_logs
  ‚úì Deleted from login_attempts
  ‚úì Deleted from two_factor_codes
  ‚úì Deleted from audit_logs
  ‚úì Deleted from inventory_logs
  ‚úì Cleaned reviewed_by in menu_requests
  ‚úì Cleaned created_by in inventory_logs
‚úÖ Admin admin@example.com deleted user student@example.com (student)
```

---

## üìä –ü–æ—Ä—è–¥–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:

```
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
   ‚Üì
2. –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ —É–¥–∞–ª—è–µ–º –ª–∏ —Å–µ–±—è?
   ‚Üì
3. –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?
   ‚Üì
4. –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (DELETE):
   - orders
   - issued_meals
   - subscriptions
   - notifications
   - purchase_requests
   - menu_requests
   - password_reset_tokens
   - reviews
   - transaction_logs
   - payment_security_logs
   - login_attempts
   - two_factor_codes
   - audit_logs
   - inventory_logs
   ‚Üì
5. –û—á–∏—Å—Ç–∫–∞ —Å—Å—ã–ª–æ–∫ (SET NULL):
   - menu_requests.reviewed_by
   - inventory_logs.created_by
   ‚Üì
6. –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚Üì
7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—Ö–∞
   ‚Üì
8. –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞:

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
# –í Docker
docker logs bufet-software-backend-1

# –ò–ª–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
üóëÔ∏è Starting deletion of user test@example.com (student)
  ‚úì Deleted from orders
  ‚úì Deleted from issued_meals
  ...
‚úÖ Admin admin@example.com deleted user test@example.com (student)
```

### –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫–∏:

```
‚ö† Could not delete from some_table: SQLITE_ERROR: no such table: some_table
```

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –≤–∞—à–µ–π –ë–î.

### –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:

```
‚ùå Error deleting user: SQLITE_CONSTRAINT: FOREIGN KEY constraint failed
```

–ó–Ω–∞—á–∏—Ç –µ—Å—Ç—å –µ—â–µ —Ç–∞–±–ª–∏—Ü–∞, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫.

---

## üîç –ö–∞–∫ –Ω–∞–π—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫:

```javascript
console.error('Error stack:', error.stack)
```

### 2. –ù–∞–π–¥–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º:

```sql
-- –î–ª—è SQLite
SELECT sql FROM sqlite_master WHERE type='table' AND sql LIKE '%FOREIGN KEY%user%';

-- –î–ª—è PostgreSQL
SELECT * FROM information_schema.table_constraints 
WHERE constraint_type = 'FOREIGN KEY';
```

### 3. –î–æ–±–∞–≤—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ —Å–ø–∏—Å–æ–∫:

```javascript
const tablesToClean = [
  // ... existing tables
  { name: 'new_table', column: 'user_id' }
]
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–∫–∏ 500
- ‚úÖ –£–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ 14+ —Ç–∞–±–ª–∏—Ü
- ‚úÖ –û—á–∏—â–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏ (SET NULL)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—à–∏–±–∫–∏ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

---

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ! üéâ**

–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 9 —Ñ–µ–≤—Ä–∞–ª—è 2026

