"""
–®–∫–æ–ª—å–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è
–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –≤—Ö–æ–¥–æ–º –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π
"""

from flask import Flask, jsonify, request, session, redirect, g, render_template_string
import sqlite3
import uuid
import os
import json
from datetime import date, datetime, timedelta
from werkzeug.security import generate_password_hash, check_password_hash
import calendar
import re

# ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================

app = Flask(__name__)
app.secret_key = '—à–∫–æ–ª–∞-—Å—Ç–æ–ª–æ–≤–∞—è-2024-—Å–µ–∫—Ä–µ—Ç-–∫–ª—é—á'
app.config['DATABASE'] = '—à–∫–æ–ª–∞_—Å—Ç–æ–ª–æ–≤–∞—è_–Ω–æ–≤–∞—è.db'

# ==================== –ë–ê–ó–ê –î–ê–ù–ù–´–• ====================

def get_db():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î"""
    if 'db' not in g:
        g.db = sqlite3.connect(app.config['DATABASE'])
        g.db.row_factory = sqlite3.Row
    return g.db

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π"""
    with app.app_context():
        db = get_db()
        
        print("üîÑ –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        db.execute('DROP TABLE IF EXISTS subscriptions')
        db.execute('DROP TABLE IF EXISTS issued_meals')
        db.execute('DROP TABLE IF EXISTS reviews')
        db.execute('DROP TABLE IF EXISTS orders')
        db.execute('DROP TABLE IF EXISTS menu')
        db.execute('DROP TABLE IF EXISTS users')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        db.execute('''
            CREATE TABLE users (
                id TEXT PRIMARY KEY,
                email TEXT UNIQUE NOT NULL,
                password TEXT NOT NULL,
                first_name TEXT NOT NULL,
                last_name TEXT NOT NULL,
                phone TEXT,
                class_name TEXT,
                role TEXT NOT NULL DEFAULT 'student',
                position TEXT,
                balance REAL DEFAULT 1000,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –º–µ–Ω—é
        db.execute('''
            CREATE TABLE menu (
                id TEXT PRIMARY KEY,
                day TEXT NOT NULL,
                name TEXT NOT NULL,
                description TEXT,
                price REAL NOT NULL,
                meal_type TEXT NOT NULL,
                available BOOLEAN DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∑–∞–∫–∞–∑–æ–≤
        db.execute('''
            CREATE TABLE orders (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                status TEXT DEFAULT '–æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –æ—Ç–∑—ã–≤–æ–≤
        db.execute('''
            CREATE TABLE reviews (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
                comment TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
        db.execute('''
            CREATE TABLE subscriptions (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                selected_dates TEXT NOT NULL, -- JSON –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç
                start_date TEXT NOT NULL,
                end_date TEXT NOT NULL,
                total_price REAL NOT NULL,
                status TEXT DEFAULT '–∞–∫—Ç–∏–≤–µ–Ω',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id)
            )
        ''')
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤—ã–¥–∞–Ω–Ω—ã—Ö –±–ª—é–¥
        db.execute('''
            CREATE TABLE issued_meals (
                id TEXT PRIMARY KEY,
                user_id TEXT NOT NULL,
                menu_id TEXT NOT NULL,
                subscription_id TEXT,
                issue_date TEXT NOT NULL,
                meal_type TEXT NOT NULL,
                issued_by TEXT, -- ID –ø–æ–≤–∞—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞–ª
                status TEXT DEFAULT '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (menu_id) REFERENCES menu(id),
                FOREIGN KEY (subscription_id) REFERENCES subscriptions(id)
            )
        ''')
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ–Ω—é –Ω–∞ –º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥
        today = date.today()
        menu_items = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –Ω–∞ 30 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
        for i in range(30):
            current_date = today + timedelta(days=i)
            date_str = current_date.strftime('%Y-%m-%d')
            
            # –ó–∞–≤—Ç—Ä–∞–∫–∏
            menu_items.append((date_str, '–ö–∞—à–∞ –æ–≤—Å—è–Ω–∞—è —Å —è–≥–æ–¥–∞–º–∏', '–ü–æ–ª–µ–∑–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫', 120, '–∑–∞–≤—Ç—Ä–∞–∫'))
            menu_items.append((date_str, '–°—ã—Ä–Ω–∏–∫–∏ —Å–æ —Å–º–µ—Ç–∞–Ω–æ–π', '–î–æ–º–∞—à–Ω–∏–µ —Å—ã—Ä–Ω–∏–∫–∏', 140, '–∑–∞–≤—Ç—Ä–∞–∫'))
            menu_items.append((date_str, '–û–º–ª–µ—Ç —Å –≤–µ—Ç—á–∏–Ω–æ–π', '–°—ã—Ç–Ω—ã–π –∑–∞–≤—Ç—Ä–∞–∫', 150, '–∑–∞–≤—Ç—Ä–∞–∫'))
            
            # –û–±–µ–¥—ã
            menu_items.append((date_str, '–°—É–ø –∫—É—Ä–∏–Ω—ã–π —Å –ª–∞–ø—à–æ–π', '–ê—Ä–æ–º–∞—Ç–Ω—ã–π —Å—É–ø', 150, '–æ–±–µ–¥'))
            menu_items.append((date_str, '–ì—Ä–µ—á–∫–∞ —Å –∫–æ—Ç–ª–µ—Ç–æ–π', '–°—ã—Ç–Ω—ã–π –æ–±–µ–¥', 180, '–æ–±–µ–¥'))
            menu_items.append((date_str, '–ü–ª–æ–≤ —Å –≥–æ–≤—è–¥–∏–Ω–æ–π', '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–ª–æ–≤', 200, '–æ–±–µ–¥'))
            menu_items.append((date_str, '–°–∞–ª–∞—Ç –æ–≤–æ—â–Ω–æ–π', '–°–≤–µ–∂–∏–µ –æ–≤–æ—â–∏', 90, '–æ–±–µ–¥'))
            
            # –ü–æ–ª–¥–Ω–∏–∫–∏
            menu_items.append((date_str, '–¢–≤–æ—Ä–æ–∂–Ω–∞—è –∑–∞–ø–µ–∫–∞–Ω–∫–∞', '–ù–µ–∂–Ω—ã–π –¥–µ—Å–µ—Ä—Ç', 130, '–ø–æ–ª–¥–Ω–∏–∫'))
            menu_items.append((date_str, '–ô–æ–≥—É—Ä—Ç —Å —Ñ—Ä—É–∫—Ç–∞–º–∏', '–õ–µ–≥–∫–∏–π –ø–æ–ª–¥–Ω–∏–∫', 100, '–ø–æ–ª–¥–Ω–∏–∫'))
        
        for item in menu_items:
            db.execute('''
                INSERT INTO menu (id, day, name, description, price, meal_type)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (str(uuid.uuid4()), *item))
        
        db.commit()
        print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")

# ==================== –í–ê–õ–ò–î–ê–¶–ò–Ø –¢–ï–õ–ï–§–û–ù–ê ====================

def validate_phone(phone):
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if not phone:
        return False
    
    # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –∫—Ä–æ–º–µ –ø–ª—é—Å–∞
    cleaned = re.sub(r'[^\d+]', '', phone)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
    # –†–æ—Å—Å–∏—è: +7XXXXXXXXXX, 8XXXXXXXXXX
    if cleaned.startswith('+7') and len(cleaned) == 12:
        return True
    elif cleaned.startswith('8') and len(cleaned) == 11:
        return True
    elif len(cleaned) == 10 and cleaned.startswith('9'):  # –ë–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã
        return True
    elif len(cleaned) >= 10 and len(cleaned) <= 15:  # –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        return True
    
    return False

def format_phone(phone):
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"""
    if not phone:
        return phone
    
    # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
    cleaned = re.sub(r'[^\d]', '', phone)
    
    if len(cleaned) == 11 and cleaned.startswith('8'):
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 8 –≤ +7
        return '+7' + cleaned[1:]
    elif len(cleaned) == 10:
        # –î–æ–±–∞–≤–ª—è–µ–º +7 –¥–ª—è 10-–∑–Ω–∞—á–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
        return '+7' + cleaned
    else:
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å —Å –ø–ª—é—Å–æ–º
        if not cleaned.startswith('+'):
            return '+' + cleaned
        return cleaned

# ==================== –ì–õ–ê–í–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê ====================

@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–®–∫–æ–ª—å–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è</title>
        <meta charset="utf-8">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
                color: white;
            }
            .container {
                max-width: 900px;
                margin: 0 auto;
                background: rgba(255, 255, 255, 0.95);
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                color: #333;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 10px;
                font-size: 2.5em;
            }
            .subtitle {
                text-align: center;
                color: #7f8c8d;
                margin-bottom: 40px;
                font-size: 1.2em;
            }
            .role-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin: 40px 0;
            }
            .role-card {
                background: white;
                border-radius: 15px;
                padding: 30px;
                text-align: center;
                text-decoration: none;
                color: #333;
                transition: all 0.3s;
                border: 2px solid transparent;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            .role-card:hover {
                transform: translateY(-10px);
                box-shadow: 0 15px 30px rgba(0,0,0,0.2);
                border-color: #3498db;
            }
            .role-icon {
                font-size: 3em;
                margin-bottom: 15px;
            }
            .role-name {
                font-size: 1.5em;
                font-weight: bold;
                margin-bottom: 10px;
                color: #2c3e50;
            }
            .role-desc {
                color: #7f8c8d;
                font-size: 0.9em;
            }
            .info-box {
                background: #e8f4fc;
                padding: 20px;
                border-radius: 10px;
                margin-top: 30px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üè´ –®–∫–æ–ª—å–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è</h1>
            <p class="subtitle">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏–µ–º –≤ —É—á–µ–±–Ω–æ–º –∑–∞–≤–µ–¥–µ–Ω–∏–∏</p>
            
            <div class="role-grid">
                <a href="/student" class="role-card">
                    <div class="role-icon">üë®‚Äçüéì</div>
                    <div class="role-name">–£—á–µ–Ω–∏–∫</div>
                    <div class="role-desc">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥, –∑–∞–∫–∞–∑ –ø–∏—Ç–∞–Ω–∏—è, –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã, –æ—Ç–∑—ã–≤—ã</div>
                </a>
                
                <a href="/chef" class="role-card">
                    <div class="role-icon">üë®‚Äçüç≥</div>
                    <div class="role-name">–ü–æ–≤–∞—Ä</div>
                    <div class="role-desc">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, —É—á–µ—Ç –≤—ã–¥–∞—á–∏</div>
                </a>
                
                <a href="/admin" class="role-card">
                    <div class="role-icon">üë®‚Äçüíº</div>
                    <div class="role-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    <div class="role-desc">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                </a>
            </div>
            
            <div class="info-box">
                <h3>üì± –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è!</h3>
                <p><strong>–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</strong> –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –ª—É—á—à–µ–π —Å–≤—è–∑–∏.</p>
                <p>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.</p>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –°–¢–†–ê–ù–ò–¶–ê –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student')
def student_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞: –≤—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è —É—á–µ–Ω–∏–∫–∞"""
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .btn {
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                text-decoration: none;
                display: block;
            }
            .btn-login {
                background: #3498db;
                color: white;
            }
            .btn-login:hover {
                background: #2980b9;
            }
            .btn-register {
                background: #2ecc71;
                color: white;
            }
            .btn-register:hover {
                background: #27ae60;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
                margin-top: 20px;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üë®‚Äçüéì –í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</h1>
            <p style="text-align: center; margin-bottom: 30px; color: #7f8c8d;">
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
            </p>
            
            <div class="btn-group">
                <a href="/student/login" class="btn btn-login">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
                <a href="/student/register" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="/" class="btn btn-back">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student/register', methods=['GET', 'POST'])
def student_register():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if request.method == 'POST':
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        confirm_password = request.form.get('confirm_password', '').strip()
        first_name = request.form.get('first_name', '').strip()
        last_name = request.form.get('last_name', '').strip()
        phone = request.form.get('phone', '').strip()
        class_name = request.form.get('class_name', '').strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if not all([email, password, confirm_password, first_name, last_name, phone, class_name]):
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!</p>
                <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
        if password != confirm_password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!</p>
                <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º email
        if '@' not in email or '.' not in email:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å!</p>
                <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if not validate_phone(phone):
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!</p>
                <p>–§–æ—Ä–º–∞—Ç: +7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX</p>
                <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
        formatted_phone = format_phone(phone)
        
        db = get_db()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ email
        existing_user = db.execute('SELECT id FROM users WHERE email = ?', (email,)).fetchone()
        if existing_user:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        existing_phone = db.execute('SELECT id FROM users WHERE phone = ?', (formatted_phone,)).fetchone()
        if existing_phone:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                <a href="/student/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = str(uuid.uuid4())
        hashed_password = generate_password_hash(password)
        
        db.execute('''
            INSERT INTO users (id, email, password, first_name, last_name, phone, class_name, role, balance)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (user_id, email, hashed_password, first_name, last_name, formatted_phone, class_name, 'student', 1000))
        
        db.commit()
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        session['user_id'] = user_id
        session['user_email'] = email
        session['user_name'] = f"{first_name} {last_name}"
        session['user_role'] = 'student'
        session['user_class'] = class_name
        
        return redirect('/dashboard')
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }
            input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }
            input:focus {
                border-color: #3498db;
                outline: none;
            }
            .help-text {
                font-size: 0.85em;
                color: #7f8c8d;
                margin-top: 5px;
            }
            .btn {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }
            .btn-register {
                background: #2ecc71;
                color: white;
            }
            .btn-register:hover {
                background: #27ae60;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–µ–Ω–∏–∫–∞</h1>
            
            <form method="POST" action="/student/register">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="example@school.ru">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required minlength="6" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <div class="form-group">
                    <label for="first_name">–ò–º—è:</label>
                    <input type="text" id="first_name" name="first_name" required placeholder="–ò–≤–∞–Ω">
                </div>
                
                <div class="form-group">
                    <label for="last_name">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="last_name" name="last_name" required placeholder="–ò–≤–∞–Ω–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="tel" id="phone" name="phone" required placeholder="+7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX">
                    <div class="help-text">–§–æ—Ä–º–∞—Ç: +7XXX XXX XX XX –∏–ª–∏ 8XXX XXX XX XX</div>
                </div>
                
                <div class="form-group">
                    <label for="class_name">–ö–ª–∞—Å—Å:</label>
                    <input type="text" id="class_name" name="class_name" required placeholder="10–ê">
                </div>
                
                <button type="submit" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <a href="/student" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
        </div>
    </body>
    </html>
    '''

# ==================== –í–•–û–î –£–ß–ï–ù–ò–ö–ê ====================

@app.route('/student/login', methods=['GET', 'POST'])
def student_login():
    """–í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        
        if not email or not password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</p>
                <a href="/student/login" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
            </body>
            </html>
            '''
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ? AND role = ?', (email, 'student')).fetchone()
        
        if user and check_password_hash(user['password'], password):
            session['user_id'] = user['id']
            session['user_email'] = email
            session['user_name'] = f"{user['first_name']} {user['last_name']}"
            session['user_role'] = user['role']
            session['user_class'] = user['class_name']
            return redirect('/dashboard')
        else:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å!</p>
                <a href="/student/login" style="color: #3498db;">‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
            </body>
            </html>
            '''
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }
            input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }
            input:focus {
                border-color: #3498db;
                outline: none;
            }
            .btn {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }
            .btn-login {
                background: #3498db;
                color: white;
            }
            .btn-login:hover {
                background: #2980b9;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
            .register-link {
                text-align: center;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –í—Ö–æ–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞</h1>
            
            <form method="POST" action="/student/login">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <button type="submit" class="btn btn-login">–í–æ–π—Ç–∏</button>
                <a href="/student" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
            
            <div class="register-link">
                <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/student/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –°–¢–†–ê–ù–ò–¶–ê –ü–û–í–ê–†–ê ====================

@app.route('/chef')
def chef_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞: –≤—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–≤–∞—Ä–∞"""
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .btn {
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                text-decoration: none;
                display: block;
            }
            .btn-login {
                background: #e67e22;
                color: white;
            }
            .btn-login:hover {
                background: #d35400;
            }
            .btn-register {
                background: #f39c12;
                color: white;
            }
            .btn-register:hover {
                background: #e67e22;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
                margin-top: 20px;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üë®‚Äçüç≥ –í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</h1>
            <p style="text-align: center; margin-bottom: 30px; color: #7f8c8d;">
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
            </p>
            
            <div class="btn-group">
                <a href="/chef/login" class="btn btn-login">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
                <a href="/chef/register" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="/" class="btn btn-back">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ü–û–í–ê–†–ê ====================

@app.route('/chef/register', methods=['GET', 'POST'])
def chef_register():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–≤–∞—Ä–∞ —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if request.method == 'POST':
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        confirm_password = request.form.get('confirm_password', '').strip()
        first_name = request.form.get('first_name', '').strip()
        last_name = request.form.get('last_name', '').strip()
        phone = request.form.get('phone', '').strip()
        position = request.form.get('position', '').strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if not all([email, password, confirm_password, first_name, last_name, phone, position]):
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!</p>
                <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
        if password != confirm_password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!</p>
                <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º email
        if '@' not in email or '.' not in email:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å!</p>
                <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if not validate_phone(phone):
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!</p>
                <p>–§–æ—Ä–º–∞—Ç: +7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX</p>
                <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
        formatted_phone = format_phone(phone)
        
        db = get_db()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ email
        existing_user = db.execute('SELECT id FROM users WHERE email = ?', (email,)).fetchone()
        if existing_user:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        existing_phone = db.execute('SELECT id FROM users WHERE phone = ?', (formatted_phone,)).fetchone()
        if existing_phone:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                <a href="/chef/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–≤–∞—Ä–∞
        user_id = str(uuid.uuid4())
        hashed_password = generate_password_hash(password)
        
        db.execute('''
            INSERT INTO users (id, email, password, first_name, last_name, phone, role, position)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (user_id, email, hashed_password, first_name, last_name, formatted_phone, 'chef', position))
        
        db.commit()
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        session['user_id'] = user_id
        session['user_email'] = email
        session['user_name'] = f"{first_name} {last_name}"
        session['user_role'] = 'chef'
        session['user_position'] = position
        
        return redirect('/dashboard')
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }
            input, select {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }
            input:focus, select:focus {
                border-color: #e67e22;
                outline: none;
            }
            .help-text {
                font-size: 0.85em;
                color: #7f8c8d;
                margin-top: 5px;
            }
            .btn {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }
            .btn-register {
                background: #f39c12;
                color: white;
            }
            .btn-register:hover {
                background: #e67e22;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–≤–∞—Ä–∞</h1>
            
            <form method="POST" action="/chef/register">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="chef@school.ru">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required minlength="6" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <div class="form-group">
                    <label for="first_name">–ò–º—è:</label>
                    <input type="text" id="first_name" name="first_name" required placeholder="–ü–µ—Ç—Ä">
                </div>
                
                <div class="form-group">
                    <label for="last_name">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="last_name" name="last_name" required placeholder="–ü–æ–≤–∞—Ä–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="tel" id="phone" name="phone" required placeholder="+7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX">
                    <div class="help-text">–§–æ—Ä–º–∞—Ç: +7XXX XXX XX XX –∏–ª–∏ 8XXX XXX XX XX</div>
                </div>
                
                <div class="form-group">
                    <label for="position">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                    <select id="position" name="position" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</option>
                        <option value="–®–µ—Ñ-–ø–æ–≤–∞—Ä">–®–µ—Ñ-–ø–æ–≤–∞—Ä</option>
                        <option value="–ü–æ–≤–∞—Ä">–ü–æ–≤–∞—Ä</option>
                        <option value="–ü–æ–º–æ—â–Ω–∏–∫ –ø–æ–≤–∞—Ä–∞">–ü–æ–º–æ—â–Ω–∏–∫ –ø–æ–≤–∞—Ä–∞</option>
                        <option value="–ë–∞—Ä–º–µ–Ω">–ë–∞—Ä–º–µ–Ω</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <a href="/chef" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
        </div>
    </body>
    </html>
    '''

# ==================== –í–•–û–î –ü–û–í–ê–†–ê ====================

@app.route('/chef/login', methods=['GET', 'POST'])
def chef_login():
    """–í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        
        if not email or not password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</p>
                <a href="/chef/login" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
            </body>
            </html>
            '''
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ? AND role = ?', (email, 'chef')).fetchone()
        
        if user and check_password_hash(user['password'], password):
            session['user_id'] = user['id']
            session['user_email'] = email
            session['user_name'] = f"{user['first_name']} {user['last_name']}"
            session['user_role'] = user['role']
            session['user_position'] = user['position']
            return redirect('/dashboard')
        else:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å!</p>
                <a href="/chef/login" style="color: #3498db;">‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
            </body>
            </html>
            '''
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }
            input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }
            input:focus {
                border-color: #e67e22;
                outline: none;
            }
            .btn {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }
            .btn-login {
                background: #e67e22;
                color: white;
            }
            .btn-login:hover {
                background: #d35400;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
            .register-link {
                text-align: center;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –í—Ö–æ–¥ –¥–ª—è –ø–æ–≤–∞—Ä–∞</h1>
            
            <form method="POST" action="/chef/login">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <button type="submit" class="btn btn-login">–í–æ–π—Ç–∏</button>
                <a href="/chef" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
            
            <div class="register-link">
                <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/chef/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –°–¢–†–ê–ù–ò–¶–ê –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================

@app.route('/admin')
def admin_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞: –≤—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .btn-group {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            .btn {
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                text-decoration: none;
                display: block;
            }
            .btn-login {
                background: #2c3e50;
                color: white;
            }
            .btn-login:hover {
                background: #1a252f;
            }
            .btn-register {
                background: #34495e;
                color: white;
            }
            .btn-register:hover {
                background: #2c3e50;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
                margin-top: 20px;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üë®‚Äçüíº –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <p style="text-align: center; margin-bottom: 30px; color: #7f8c8d;">
                –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
            </p>
            
            <div class="btn-group">
                <a href="/admin/login" class="btn btn-login">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
                <a href="/admin/register" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                <a href="/" class="btn btn-back">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================

@app.route('/admin/register', methods=['GET', 'POST'])
def admin_register():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if request.method == 'POST':
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        confirm_password = request.form.get('confirm_password', '').strip()
        first_name = request.form.get('first_name', '').strip()
        last_name = request.form.get('last_name', '').strip()
        phone = request.form.get('phone', '').strip()
        position = request.form.get('position', '').strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if not all([email, password, confirm_password, first_name, last_name, phone, position]):
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!</p>
                <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
        if password != confirm_password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!</p>
                <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º email
        if '@' not in email or '.' not in email:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å!</p>
                <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if not validate_phone(phone):
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞!</p>
                <p>–§–æ—Ä–º–∞—Ç: +7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX</p>
                <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
        formatted_phone = format_phone(phone)
        
        db = get_db()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ email
        existing_user = db.execute('SELECT id FROM users WHERE email = ?', (email,)).fetchone()
        if existing_user:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        existing_phone = db.execute('SELECT id FROM users WHERE phone = ?', (formatted_phone,)).fetchone()
        if existing_phone:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!</p>
                <a href="/admin/register" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</a>
            </body>
            </html>
            '''
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        user_id = str(uuid.uuid4())
        hashed_password = generate_password_hash(password)
        
        db.execute('''
            INSERT INTO users (id, email, password, first_name, last_name, phone, role, position)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (user_id, email, hashed_password, first_name, last_name, formatted_phone, 'admin', position))
        
        db.commit()
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        session['user_id'] = user_id
        session['user_email'] = email
        session['user_name'] = f"{first_name} {last_name}"
        session['user_role'] = 'admin'
        session['user_position'] = position
        
        return redirect('/dashboard')
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }
            input, select {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }
            input:focus, select:focus {
                border-color: #2c3e50;
                outline: none;
            }
            .help-text {
                font-size: 0.85em;
                color: #7f8c8d;
                margin-top: 5px;
            }
            .btn {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }
            .btn-register {
                background: #34495e;
                color: white;
            }
            .btn-register:hover {
                background: #2c3e50;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            
            <form method="POST" action="/admin/register">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="admin@school.ru">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required minlength="6" placeholder="–ù–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <div class="form-group">
                    <label for="first_name">–ò–º—è:</label>
                    <input type="text" id="first_name" name="first_name" required placeholder="–ê–ª–µ–∫—Å–µ–π">
                </div>
                
                <div class="form-group">
                    <label for="last_name">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="last_name" name="last_name" required placeholder="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤">
                </div>
                
                <div class="form-group">
                    <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="tel" id="phone" name="phone" required placeholder="+7XXXXXXXXXX –∏–ª–∏ 8XXXXXXXXXX">
                    <div class="help-text">–§–æ—Ä–º–∞—Ç: +7XXX XXX XX XX –∏–ª–∏ 8XXX XXX XX XX</div>
                </div>
                
                <div class="form-group">
                    <label for="position">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                    <select id="position" name="position" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</option>
                        <option value="–î–∏—Ä–µ–∫—Ç–æ—Ä —à–∫–æ–ª—ã">–î–∏—Ä–µ–∫—Ç–æ—Ä —à–∫–æ–ª—ã</option>
                        <option value="–ó–∞–≤—É—á">–ó–∞–≤—É—á</option>
                        <option value="–ó–∞–≤–µ–¥—É—é—â–∏–π —Å—Ç–æ–ª–æ–≤–æ–π">–ó–∞–≤–µ–¥—É—é—â–∏–π —Å—Ç–æ–ª–æ–≤–æ–π</option>
                        <option value="–ë—É—Ö–≥–∞–ª—Ç–µ—Ä">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä</option>
                        <option value="–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <a href="/admin" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
        </div>
    </body>
    </html>
    '''

# ==================== –í–•–û–î –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ====================

@app.route('/admin/login', methods=['GET', 'POST'])
def admin_login():
    """–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    if request.method == 'POST':
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '').strip()
        
        if not email or not password:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!</p>
                <a href="/admin/login" style="color: #3498db;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</a>
            </body>
            </html>
            '''
        
        db = get_db()
        user = db.execute('SELECT * FROM users WHERE email = ? AND role = ?', (email, 'admin')).fetchone()
        
        if user and check_password_hash(user['password'], password):
            session['user_id'] = user['id']
            session['user_email'] = email
            session['user_name'] = f"{user['first_name']} {user['last_name']}"
            session['user_role'] = user['role']
            session['user_position'] = user['position']
            return redirect('/dashboard')
        else:
            return '''
            <!DOCTYPE html>
            <html>
            <head><title>–û—à–∏–±–∫–∞</title></head>
            <body style="font-family: Arial; text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c;">‚ùå –û—à–∏–±–∫–∞</h2>
                <p>–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å!</p>
                <a href="/admin/login" style="color: #3498db;">‚Üê –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</a>
            </body>
            </html>
            '''
    
    # GET –∑–∞–ø—Ä–æ—Å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body { 
                font-family: 'Arial', sans-serif; 
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 500px;
                width: 100%;
            }
            h1 {
                color: #2c3e50;
                text-align: center;
                margin-bottom: 30px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            label {
                display: block;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }
            input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }
            input:focus {
                border-color: #2c3e50;
                outline: none;
            }
            .btn {
                width: 100%;
                padding: 15px;
                border: none;
                border-radius: 10px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.3s;
                margin-top: 10px;
            }
            .btn-login {
                background: #2c3e50;
                color: white;
            }
            .btn-login:hover {
                background: #1a252f;
            }
            .btn-back {
                background: #95a5a6;
                color: white;
            }
            .btn-back:hover {
                background: #7f8c8d;
            }
            .register-link {
                text-align: center;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            
            <form method="POST" action="/admin/login">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email">
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                
                <button type="submit" class="btn btn-login">–í–æ–π—Ç–∏</button>
                <a href="/admin" class="btn btn-back" style="text-decoration: none; display: block; text-align: center;">‚Üê –ù–∞–∑–∞–¥</a>
            </form>
            
            <div class="register-link">
                <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/admin/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
            </div>
        </div>
    </body>
    </html>
    '''

# ==================== –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ====================

@app.route('/dashboard')
def dashboard():
    """–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞"""
    if 'user_id' not in session:
        return redirect('/')
    
    role = session.get('user_role')
    
    if role == 'student':
        return student_dashboard()
    elif role == 'chef':
        return chef_dashboard()
    elif role == 'admin':
        return admin_dashboard()
    
    return redirect('/')

def student_dashboard():
    """–ü–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–∞"""
    db = get_db()
    today = date.today()
    today_str = today.strftime('%Y-%m-%d')
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        session.clear()
        return redirect('/')
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    phone_display = user['phone'] if user['phone'] else '–ù–µ —É–∫–∞–∑–∞–Ω'
    
    # –ü–æ–ª—É—á–∞–µ–º –º–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    menu = db.execute('SELECT * FROM menu WHERE day = ? AND available = 1', (today_str,)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    subscriptions = db.execute('''
        SELECT s.*, m.name as menu_name, m.price, m.meal_type
        FROM subscriptions s
        JOIN menu m ON s.menu_id = m.id
        WHERE s.user_id = ? AND s.status = '–∞–∫—Ç–∏–≤–µ–Ω'
        ORDER BY s.created_at DESC
    ''', (session.get('user_id'),)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—ã–¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –±–ª—é–¥–∞
    issued_today = db.execute('''
        SELECT im.*, m.name as menu_name
        FROM issued_meals im
        JOIN menu m ON im.menu_id = m.id
        WHERE im.user_id = ? AND im.issue_date = ? 
        ORDER BY im.created_at DESC
    ''', (session.get('user_id'), today_str)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_reviews = db.execute('''
        SELECT r.*, m.name as menu_name
        FROM reviews r
        JOIN menu m ON r.menu_id = m.id
        WHERE r.user_id = ?
        ORDER BY r.created_at DESC
        LIMIT 5
    ''', (session.get('user_id'),)).fetchall()
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–ü–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–∞</title>
        <meta charset="utf-8">
        <style>
            body {{ 
                font-family: 'Arial', sans-serif; 
                background: #f0f8ff;
                margin: 0;
                padding: 20px;
            }}
            .header {{ 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white; 
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-bottom: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            .menu-grid {{ 
                display: grid; 
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
                gap: 25px;
                margin-top: 30px;
            }}
            .menu-card {{ 
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                transition: transform 0.3s;
                border-left: 5px solid #3498db;
            }}
            .menu-card:hover {{
                transform: translateY(-5px);
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            }}
            .btn {{ 
                background: #27ae60; 
                color: white; 
                padding: 12px 25px;
                border: none; 
                border-radius: 8px; 
                cursor: pointer; 
                margin-top: 15px;
                font-size: 1em;
                transition: background 0.3s;
                display: inline-block;
                text-decoration: none;
            }}
            .btn:hover {{ 
                background: #219653; 
            }}
            .btn-subscription {{
                background: #3498db;
                margin-left: 10px;
            }}
            .btn-subscription:hover {{
                background: #2980b9;
            }}
            .btn-review {{
                background: #f39c12;
                margin-left: 10px;
            }}
            .btn-review:hover {{
                background: #e67e22;
            }}
            .balance {{ 
                font-size: 1.8em; 
                color: #2ecc71; 
                font-weight: bold; 
                background: rgba(255, 255, 255, 0.2);
                padding: 10px 20px;
                border-radius: 10px;
                display: inline-block;
                margin: 10px 0;
            }}
            .logout-btn {{
                background: #e74c3c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-left: 20px;
                transition: background 0.3s;
            }}
            .logout-btn:hover {{ 
                background: #c0392b; 
            }}
            .user-info {{
                margin-bottom: 15px;
            }}
            .phone-info {{
                background: rgba(255, 255, 255, 0.2);
                padding: 8px 15px;
                border-radius: 8px;
                display: inline-block;
                margin: 10px 0;
            }}
            .meal-type {{
                display: inline-block;
                background: #3498db;
                color: white;
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 0.9em;
                margin-right: 10px;
                margin-bottom: 10px;
            }}
            .subscription-card {{
                background: #e8f4fc;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #3498db;
            }}
            .issued-card {{
                background: #e8f6e8;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #27ae60;
            }}
            .status-badge {{
                display: inline-block;
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 0.8em;
                margin-left: 10px;
            }}
            .status-waiting {{ background: #f39c12; color: white; }}
            .status-issued {{ background: #27ae60; color: white; }}
            
            /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
            .calendar-container {{
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 1000;
                justify-content: center;
                align-items: center;
            }}
            .calendar {{
                background: white;
                padding: 30px;
                border-radius: 15px;
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
            }}
            .calendar-header {{
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }}
            .calendar-grid {{
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 5px;
                text-align: center;
            }}
            .calendar-day {{
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.3s;
            }}
            .calendar-day:hover {{
                background: #f0f8ff;
            }}
            .calendar-day.selected {{
                background: #3498db;
                color: white;
                border-color: #3498db;
            }}
            .calendar-day.today {{
                border: 2px solid #e74c3c;
            }}
            .calendar-day.weekend {{
                background: #f8f9fa;
            }}
            .calendar-day-header {{
                font-weight: bold;
                background: #f8f9fa;
                padding: 10px;
            }}
            .instructions {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 20px 0;
                border-left: 4px solid #3498db;
            }}
            .selected-dates {{
                background: #e8f4fc;
                padding: 15px;
                border-radius: 10px;
                margin: 20px 0;
                min-height: 50px;
            }}
            .date-chip {{
                display: inline-block;
                background: #3498db;
                color: white;
                padding: 5px 10px;
                border-radius: 15px;
                margin: 5px;
                font-size: 0.9em;
            }}
            .date-chip button {{
                background: none;
                border: none;
                color: white;
                margin-left: 5px;
                cursor: pointer;
            }}
            .star-rating {{
                color: #f39c12;
                font-size: 1.2em;
                margin: 10px 0;
            }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üë®‚Äçüéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user['first_name']} {user['last_name']}!</h1>
            <div class="user-info">
                <p><strong>–ö–ª–∞—Å—Å:</strong> {user['class_name']} | <strong>–ë–∞–ª–∞–Ω—Å:</strong> <span class="balance" id="userBalance">{user['balance']} —Ä—É–±.</span></p>
                <div class="phone-info">
                    üì± <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {phone_display}
                </div>
            </div>
            <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>üìã –í–∞—à–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã:</h2>
    '''
    
    if subscriptions:
        for sub in subscriptions:
            selected_dates = json.loads(sub['selected_dates'])
            html += f'''
                <div class="subscription-card">
                    <h4>{sub['menu_name']} ({sub['meal_type']})</h4>
                    <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> {sub['start_date']} - {sub['end_date']}</p>
                    <p><strong>–í—ã–±—Ä–∞–Ω–æ –¥–Ω–µ–π:</strong> {len(selected_dates)}</p>
                    <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {sub['total_price']} —Ä—É–±.</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge status-issued">{sub['status']}</span></p>
                </div>
            '''
    else:
        html += '<p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üçΩÔ∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</h2>
    '''
    
    if issued_today:
        for meal in issued_today:
            status_class = 'status-issued' if meal['status'] == '–≤—ã–¥–∞–Ω' else 'status-waiting'
            html += f'''
                <div class="issued-card">
                    <h4>{meal['menu_name']}</h4>
                    <p><strong>–í—Ä–µ–º—è –≤—ã–¥–∞—á–∏:</strong> {meal['created_at'][11:16] if meal['created_at'] else '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge {status_class}">{meal['status']}</span></p>
                </div>
            '''
    else:
        html += '<p>–°–µ–≥–æ–¥–Ω—è –≤—ã –µ—â–µ –Ω–µ –ø–æ–ª—É—á–∞–ª–∏ –ø–∏—Ç–∞–Ω–∏–µ.</p>'
    
    html += f'''
            </div>
        </div>
        
        <h2>üçΩÔ∏è –ú–µ–Ω—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({today_str}):</h2>
        
        <div class="menu-grid">
    '''
    
    if menu:
        for item in menu:
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª—é–¥–∞
            avg_rating = db.execute('''
                SELECT AVG(rating) as avg_rating, COUNT(*) as review_count 
                FROM reviews 
                WHERE menu_id = ?
            ''', (item['id'],)).fetchone()
            
            avg_rating_value = avg_rating['avg_rating'] if avg_rating['avg_rating'] else 0
            review_count = avg_rating['review_count'] or 0
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ —ç—Ç–æ –±–ª—é–¥–æ —Å–µ–≥–æ–¥–Ω—è
            has_subscription_today = False
            for sub in subscriptions:
                selected_dates = json.loads(sub['selected_dates'])
                if sub['menu_id'] == item['id'] and today_str in selected_dates:
                    has_subscription_today = True
                    break
            
            html += f'''
            <div class="menu-card">
                <h3>{item['name']}</h3>
                <p>{item['description']}</p>
                <span class="meal-type">{item['meal_type']}</span>
                <p><strong>–¶–µ–Ω–∞:</strong> {item['price']} —Ä—É–±.</p>
                <div class="star-rating">
                    {'‚òÖ' * int(avg_rating_value)}{'‚òÜ' * (5 - int(avg_rating_value))}
                    <span style="font-size: 0.9em; color: #7f8c8d;">
                        ({avg_rating_value:.1f} –∏–∑ 5, {review_count} –æ—Ç–∑—ã–≤–æ–≤)
                    </span>
                </div>
                <div>
                    <button onclick="orderItem('{item['id']}')" class="btn">–ó–∞–∫–∞–∑–∞—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</button>
            '''
            
            if not has_subscription_today:
                html += f'''<button onclick="openSubscriptionForm('{item['id']}', '{item['name']}', {item['price']}, '{item['meal_type']}')" class="btn btn-subscription">–û—Ñ–æ—Ä–º–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç</button>'''
            else:
                html += '''<button class="btn" style="background: #95a5a6;" disabled>–ê–±–æ–Ω–µ–º–µ–Ω—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω</button>'''
            
            html += f'''
                    <button onclick="openReviewForm('{item['id']}', '{item['name']}')" class="btn btn-review">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </div>
            </div>
            '''
    else:
        html += '<p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –º–µ–Ω—é –Ω–µ—Ç.</p>'
    
    html += '''
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ -->
        <div id="subscriptionModal" class="calendar-container">
            <div class="calendar">
                <div class="calendar-header">
                    <h2 id="subscriptionTitle">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞</h2>
                    <button onclick="closeSubscriptionForm()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                
                <div class="instructions">
                    <h3>üéØ –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º:</h3>
                    <p>1. <strong>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã</strong> - –∫–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –¥–Ω–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ, –∫–æ–≥–¥–∞ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —ç—Ç–æ –±–ª—é–¥–æ</p>
                    <p>2. <strong>–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–∞—Ç</strong> - –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ —É—á–µ–±–Ω—ã–µ –¥–Ω–∏ (–ø–Ω-–ø—Ç)</p>
                    <p>3. <strong>–¶–µ–Ω–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</strong> - —á–µ–º –±–æ–ª—å—à–µ –¥–Ω–µ–π, —Ç–µ–º –≤—ã—à–µ –æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</p>
                    <p>4. <strong>–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä</strong> - –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –µ—â–µ —Ä–∞–∑, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –µ–µ</p>
                    <p>5. <strong>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</strong> - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ñ–æ—Ä–º–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç" –≤–Ω–∏–∑—É</p>
                </div>
                
                <h3>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã:</h3>
                <div class="calendar-grid">
                    <div class="calendar-day-header">–ü–Ω</div>
                    <div class="calendar-day-header">–í—Ç</div>
                    <div class="calendar-day-header">–°—Ä</div>
                    <div class="calendar-day-header">–ß—Ç</div>
                    <div class="calendar-day-header">–ü—Ç</div>
                    <div class="calendar-day-header" style="color: #e74c3c;">–°–±</div>
                    <div class="calendar-day-header" style="color: #e74c3c;">–í—Å</div>
    '''
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞ 42 –¥–Ω—è (6 –Ω–µ–¥–µ–ª—å)
    for i in range(42):
        day_date = today + timedelta(days=i)
        date_str = day_date.strftime('%Y-%m-%d')
        day_name = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'][day_date.weekday()]
        is_weekend = day_date.weekday() >= 5
        is_today = i == 0
        
        day_class = 'calendar-day'
        if is_today:
            day_class += ' today'
        if is_weekend:
            day_class += ' weekend'
        
        html += f'''
            <div class="{day_class}" data-date="{date_str}" onclick="toggleDate('{date_str}')">
                {day_date.day}
            </div>
        '''
    
    html += '''
                </div>
                
                <div class="selected-dates">
                    <h4>üìã –í—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã:</h4>
                    <div id="selectedDatesList"></div>
                </div>
                
                <div style="margin-top: 20px;">
                    <p><strong>–¶–µ–Ω–∞ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å:</strong> <span id="dayPrice">0</span> —Ä—É–±.</p>
                    <p><strong>–í—ã–±—Ä–∞–Ω–æ –¥–Ω–µ–π:</strong> <span id="selectedDaysCount">0</span></p>
                    <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> <span id="totalPrice" style="font-size: 1.5em; color: #27ae60; font-weight: bold;">0</span> —Ä—É–±.</p>
                </div>
                
                <input type="hidden" id="selectedMenuId" value="">
                <input type="hidden" id="selectedMenuPrice" value="0">
                
                <div style="margin-top: 30px;">
                    <button onclick="createSubscription()" class="btn" style="font-size: 1.2em; padding: 15px 30px;">‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç</button>
                    <button onclick="closeSubscriptionForm()" class="btn" style="background: #95a5a6; margin-left: 10px;">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ -->
        <div id="reviewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px;">
                <h3 id="reviewTitle">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
                <div id="ratingStars" class="rating-stars">
                    <span data-rating="1">‚òÜ</span>
                    <span data-rating="2">‚òÜ</span>
                    <span data-rating="3">‚òÜ</span>
                    <span data-rating="4">‚òÜ</span>
                    <span data-rating="5">‚òÜ</span>
                </div>
                <input type="hidden" id="selectedRating" value="0">
                <input type="hidden" id="selectedMenuIdReview" value="">
                <input type="hidden" id="editReviewId" value="">
                <textarea id="reviewComment" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤ –∑–¥–µ—Å—å..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px;"></textarea>
                <div style="margin-top: 20px;">
                    <button onclick="submitReview()" class="btn" style="margin-right: 10px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                    <button onclick="closeReviewForm()" class="btn" style="background: #95a5a6;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
        
        <div id="message" style="margin-top: 40px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"></div>
        
        <script>
            let selectedDates = new Set();
            let currentRating = 0;
            let dayPrice = 0;
            
            function orderItem(menuId) {
                fetch('/api/order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({menu_id: menuId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('error', data.error);
                    } else {
                        showMessage('success', '‚úÖ <strong>–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</strong><br><br>üìã <strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> ' + data.order_id + '<br>üí∞ <strong>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:</strong> ' + data.new_balance + ' —Ä—É–±.');
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        document.getElementById('userBalance').textContent = data.new_balance + ' —Ä—É–±.';
                    }
                })
                .catch(error => {
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                });
            }
            
            function openSubscriptionForm(menuId, menuName, price, mealType) {
                document.getElementById('subscriptionTitle').textContent = '–ê–±–æ–Ω–µ–º–µ–Ω—Ç: ' + menuName + ' (' + mealType + ')';
                document.getElementById('selectedMenuId').value = menuId;
                document.getElementById('selectedMenuPrice').value = price;
                document.getElementById('dayPrice').textContent = price;
                
                // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç
                selectedDates.clear();
                updateSelectedDatesList();
                updatePrice();
                
                // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                document.getElementById('subscriptionModal').style.display = 'flex';
                dayPrice = price;
            }
            
            function closeSubscriptionForm() {
                document.getElementById('subscriptionModal').style.display = 'none';
            }
            
            function toggleDate(date) {
                if (selectedDates.has(date)) {
                    selectedDates.delete(date);
                } else {
                    selectedDates.add(date);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                updateCalendarSelection();
                updateSelectedDatesList();
                updatePrice();
            }
            
            function updateCalendarSelection() {
                document.querySelectorAll('.calendar-day').forEach(day => {
                    const date = day.getAttribute('data-date');
                    if (selectedDates.has(date)) {
                        day.classList.add('selected');
                    } else {
                        day.classList.remove('selected');
                    }
                });
            }
            
            function updateSelectedDatesList() {
                const container = document.getElementById('selectedDatesList');
                container.innerHTML = '';
                
                const sortedDates = Array.from(selectedDates).sort();
                
                sortedDates.forEach(date => {
                    const dateObj = new Date(date);
                    const dateStr = dateObj.toLocaleDateString('ru-RU', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short'
                    });
                    
                    const chip = document.createElement('div');
                    chip.className = 'date-chip';
                    chip.innerHTML = `
                        ${dateStr}
                        <button onclick="removeDate('${date}')">‚úï</button>
                    `;
                    container.appendChild(chip);
                });
                
                document.getElementById('selectedDaysCount').textContent = selectedDates.size;
            }
            
            function removeDate(date) {
                selectedDates.delete(date);
                updateCalendarSelection();
                updateSelectedDatesList();
                updatePrice();
            }
            
            function updatePrice() {
                const totalPrice = dayPrice * selectedDates.size;
                document.getElementById('totalPrice').textContent = totalPrice;
            }
            
            function createSubscription() {
                const menuId = document.getElementById('selectedMenuId').value;
                const dates = Array.from(selectedDates);
                
                if (dates.length === 0) {
                    showMessage('error', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –¥–∞—Ç—É –¥–ª—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞');
                    return;
                }
                
                const sortedDates = dates.sort();
                const startDate = sortedDates[0];
                const endDate = sortedDates[sortedDates.length - 1];
                const totalPrice = dayPrice * dates.length;
                
                fetch('/api/subscription', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        menu_id: menuId,
                        selected_dates: dates,
                        start_date: startDate,
                        end_date: endDate,
                        total_price: totalPrice
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('error', data.error);
                    } else {
                        showMessage('success', '‚úÖ <strong>–ê–±–æ–Ω–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!</strong><br><br>' +
                            'üìã <strong>–ù–æ–º–µ—Ä –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞:</strong> ' + data.subscription_id + '<br>' +
                            'üìÖ <strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</strong> ' + data.days_count + '<br>' +
                            'üí∞ <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ' + data.total_price + ' —Ä—É–±.<br>' +
                            'üí≥ <strong>–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:</strong> ' + data.new_balance + ' —Ä—É–±.');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        document.getElementById('userBalance').textContent = data.new_balance + ' —Ä—É–±.';
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        closeSubscriptionForm();
                        setTimeout(() => location.reload(), 3000);
                    }
                })
                .catch(error => {
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                });
            }
            
            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
            function openReviewForm(menuId, menuName) {
                document.getElementById('reviewTitle').textContent = '–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤: ' + menuName;
                document.getElementById('selectedMenuIdReview').value = menuId;
                document.getElementById('editReviewId').value = '';
                document.getElementById('reviewComment').value = '';
                currentRating = 0;
                updateStars();
                document.getElementById('reviewModal').style.display = 'flex';
            }
            
            function closeReviewForm() {
                document.getElementById('reviewModal').style.display = 'none';
            }
            
            function updateStars() {
                const stars = document.querySelectorAll('#ratingStars span');
                stars.forEach((star, index) => {
                    if (index < currentRating) {
                        star.textContent = '‚òÖ';
                        star.style.color = '#f39c12';
                    } else {
                        star.textContent = '‚òÜ';
                        star.style.color = '#ddd';
                    }
                });
                document.getElementById('selectedRating').value = currentRating;
            }
            
            function submitReview() {
                const menuId = document.getElementById('selectedMenuIdReview').value;
                const rating = currentRating;
                const comment = document.getElementById('reviewComment').value.trim();
                const reviewId = document.getElementById('editReviewId').value;
                
                if (rating === 0) {
                    showMessage('error', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
                    return;
                }
                
                if (!comment) {
                    showMessage('error', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
                    return;
                }
                
                const url = reviewId ? '/api/review/' + reviewId : '/api/review';
                const method = reviewId ? 'PUT' : 'POST';
                
                fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        menu_id: menuId,
                        rating: rating,
                        comment: comment
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('error', data.error);
                    } else {
                        showMessage('success', reviewId ? '‚úÖ –û—Ç–∑—ã–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!' : '‚úÖ –û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
                        closeReviewForm();
                        setTimeout(() => location.reload(), 2000);
                    }
                })
                .catch(error => {
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                });
            }
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–≤–µ–∑–¥
            document.addEventListener('DOMContentLoaded', function() {
                const stars = document.querySelectorAll('#ratingStars span');
                stars.forEach(star => {
                    star.addEventListener('click', function() {
                        currentRating = parseInt(this.getAttribute('data-rating'));
                        updateStars();
                    });
                    
                    star.addEventListener('mouseover', function() {
                        const hoverRating = parseInt(this.getAttribute('data-rating'));
                        const stars = document.querySelectorAll('#ratingStars span');
                        stars.forEach((s, index) => {
                            if (index < hoverRating) {
                                s.style.color = '#f39c12';
                            } else {
                                s.style.color = '#ddd';
                            }
                        });
                    });
                    
                    star.addEventListener('mouseout', function() {
                        updateStars();
                    });
                });
            });
            
            function showMessage(type, content) {
                const messageDiv = document.getElementById('message');
                if (type === 'error') {
                    messageDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border-left: 5px solid #e74c3c;">' + content + '</div>';
                } else {
                    messageDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; border-left: 5px solid #27ae60;">' + content + '</div>';
                }
                messageDiv.scrollIntoView({behavior: 'smooth'});
            }
        </script>
    </body>
    </html>
    '''
    
    return html

def chef_dashboard():
    """–ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞"""
    db = get_db()
    today = date.today().strftime('%Y-%m-%d')
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        session.clear()
        return redirect('/')
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    phone_display = user['phone'] if user['phone'] else '–ù–µ —É–∫–∞–∑–∞–Ω'
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    orders = db.execute('''
        SELECT o.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.price, m.meal_type
        FROM orders o
        JOIN users u ON o.user_id = u.id
        JOIN menu m ON o.menu_id = m.id
        WHERE DATE(o.created_at) = ?
        ORDER BY o.created_at DESC
    ''', (today,)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    subscriptions_today = db.execute('''
        SELECT s.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.price, m.meal_type
        FROM subscriptions s
        JOIN users u ON s.user_id = u.id
        JOIN menu m ON s.menu_id = m.id
        WHERE s.status = '–∞–∫—Ç–∏–≤–µ–Ω' AND json_extract(s.selected_dates, '$') LIKE ?
        ORDER BY s.created_at DESC
    ''', (f'%{today}%',)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º –±–ª—é–¥–∞ –¥–ª—è –≤—ã–¥–∞—á–∏ —Å–µ–≥–æ–¥–Ω—è
    meals_to_issue = db.execute('''
        SELECT im.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.meal_type
        FROM issued_meals im
        JOIN users u ON im.user_id = u.id
        JOIN menu m ON im.menu_id = m.id
        WHERE im.issue_date = ? AND im.status = '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏'
        ORDER BY im.created_at ASC
    ''', (today,)).fetchall()
    
    # –ü–æ–ª—É—á–∞–µ–º —É–∂–µ –≤—ã–¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –±–ª—é–¥–∞
    issued_meals = db.execute('''
        SELECT im.*, u.first_name, u.last_name, u.class_name, m.name as menu_name, m.meal_type
        FROM issued_meals im
        JOIN users u ON im.user_id = u.id
        JOIN menu m ON im.menu_id = m.id
        WHERE im.issue_date = ? AND im.status = '–≤—ã–¥–∞–Ω' AND im.issued_by = ?
        ORDER BY im.created_at DESC
        LIMIT 20
    ''', (today, session.get('user_id'))).fetchall()
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{
                font-family: 'Arial', sans-serif;
                background: #fff8f0;
                margin: 0;
                padding: 20px;
            }}
            .header {{
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 30px;
                margin-bottom: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            .meal-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #e67e22;
            }}
            .meal-card.issued {{
                border-left-color: #27ae60;
                background: #e8f6e8;
            }}
            .status-badge {{
                display: inline-block;
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 0.8em;
                margin: 5px;
            }}
            .status-waiting {{ background: #f39c12; color: white; }}
            .status-issued {{ background: #27ae60; color: white; }}
            .btn {{
                background: #e67e22;
                color: white;
                padding: 8px 16px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
                transition: background 0.3s;
            }}
            .btn:hover {{
                background: #d35400;
            }}
            .btn-issue {{
                background: #27ae60;
            }}
            .btn-issue:hover {{
                background: #219653;
            }}
            .logout-btn {{
                background: #e74c3c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-left: 20px;
                transition: background 0.3s;
            }}
            .logout-btn:hover {{
                background: #c0392b;
            }}
            .statistics {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }}
            .stat-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                text-align: center;
            }}
            .stat-value {{
                font-size: 1.5em;
                font-weight: bold;
                color: #e67e22;
                margin: 5px 0;
            }}
            .phone-info {{
                background: rgba(255, 255, 255, 0.2);
                padding: 8px 15px;
                border-radius: 8px;
                display: inline-block;
                margin: 10px 0;
            }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üë®‚Äçüç≥ –ü–∞–Ω–µ–ª—å –ø–æ–≤–∞—Ä–∞</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user['first_name']} {user['last_name']}!</p>
            <div class="phone-info">
                üì± <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {phone_display}
            </div>
            <p><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {user['position']} | <strong>–î–∞—Ç–∞:</strong> {today}</p>
            <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
        </div>
        
        <div class="statistics">
            <div class="stat-card">
                <div class="stat-value">{len(orders)}</div>
                <div>–†–∞–∑–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(subscriptions_today)}</div>
                <div>–ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(meals_to_issue)}</div>
                <div>–û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{len(issued_meals)}</div>
                <div>–í—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>‚è≥ –û–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏:</h2>
    '''
    
    if meals_to_issue:
        for meal in meals_to_issue:
            html += f'''
                <div class="meal-card">
                    <h4>{meal['menu_name']} ({meal['meal_type']})</h4>
                    <p><strong>–£—á–µ–Ω–∏–∫:</strong> {meal['first_name']} {meal['last_name']} ({meal['class_name']})</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge status-waiting">{meal['status']}</span></p>
                    <button onclick="issueMeal('{meal['id']}')" class="btn btn-issue">‚úÖ –í—ã–¥–∞—Ç—å</button>
                </div>
            '''
    else:
        html += '<p>–ù–µ—Ç –±–ª—é–¥, –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–¥–∞—á–∏.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>üìã –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:</h2>
    '''
    
    if subscriptions_today:
        for sub in subscriptions_today:
            selected_dates = json.loads(sub['selected_dates'])
            html += f'''
                <div class="meal-card">
                    <h4>{sub['menu_name']} ({sub['meal_type']})</h4>
                    <p><strong>–£—á–µ–Ω–∏–∫:</strong> {sub['first_name']} {sub['last_name']} ({sub['class_name']})</p>
                    <p><strong>–ê–±–æ–Ω–µ–º–µ–Ω—Ç –¥–æ:</strong> {sub['end_date']}</p>
                    <button onclick="createIssueFromSubscription('{sub['id']}', '{sub['menu_id']}', '{sub['user_id']}')" class="btn btn-issue">‚úÖ –í—ã–¥–∞—Ç—å –ø–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—É</button>
                </div>
            '''
    else:
        html += '<p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç.</p>'
    
    html += '''
            </div>
            
            <div class="section">
                <h2>‚úÖ –í—ã–¥–∞–Ω–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è –≤–∞–º–∏:</h2>
    '''
    
    if issued_meals:
        for meal in issued_meals:
            html += f'''
                <div class="meal-card issued">
                    <h4>{meal['menu_name']} ({meal['meal_type']})</h4>
                    <p><strong>–£—á–µ–Ω–∏–∫:</strong> {meal['first_name']} {meal['last_name']} ({meal['class_name']})</p>
                    <p><strong>–í—Ä–µ–º—è –≤—ã–¥–∞—á–∏:</strong> {meal['created_at'][11:16] if meal['created_at'] else '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge status-issued">{meal['status']}</span></p>
                </div>
            '''
    else:
        html += '<p>–í—ã –µ—â–µ –Ω–µ –≤—ã–¥–∞–≤–∞–ª–∏ –±–ª—é–¥ —Å–µ–≥–æ–¥–Ω—è.</p>'
    
    html += '''
            </div>
        </div>
        
        <div id="message" style="margin-top: 40px; padding: 25px; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"></div>
        
        <script>
            function issueMeal(mealId) {
                fetch('/api/issue-meal', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({meal_id: mealId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('error', data.error);
                    } else {
                        showMessage('success', '‚úÖ –ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–æ!');
                        setTimeout(() => location.reload(), 1500);
                    }
                })
                .catch(error => {
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                });
            }
            
            function createIssueFromSubscription(subscriptionId, menuId, userId) {
                fetch('/api/issue-from-subscription', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        subscription_id: subscriptionId,
                        menu_id: menuId,
                        user_id: userId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage('error', data.error);
                    } else {
                        showMessage('success', '‚úÖ –ó–∞–ø–∏—Å—å –Ω–∞ –≤—ã–¥–∞—á—É —Å–æ–∑–¥–∞–Ω–∞! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–í—ã–¥–∞—Ç—å" –≤ —Å–ø–∏—Å–∫–µ –æ–∂–∏–¥–∞—é—â–∏—Ö.');
                        setTimeout(() => location.reload(), 1500);
                    }
                })
                .catch(error => {
                    showMessage('error', '‚ùå –û—à–∏–±–∫–∞: ' + error);
                });
            }
            
            function showMessage(type, content) {
                const messageDiv = document.getElementById('message');
                if (type === 'error') {
                    messageDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; border-left: 5px solid #e74c3c;">' + content + '</div>';
                } else {
                    messageDiv.innerHTML = '<div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; border-left: 5px solid #27ae60;">' + content + '</div>';
                }
                messageDiv.scrollIntoView({behavior: 'smooth'});
            }
        </script>
    </body>
    </html>
    '''
    
    return html

def admin_dashboard():
    """–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    db = get_db()
    today = date.today().strftime('%Y-%m-%d')
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        session.clear()
        return redirect('/')
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    phone_display = user['phone'] if user['phone'] else '–ù–µ —É–∫–∞–∑–∞–Ω'
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_users = db.execute('SELECT COUNT(*) as count FROM users').fetchone()['count']
    total_students = db.execute('SELECT COUNT(*) as count FROM users WHERE role = ?', ('student',)).fetchone()['count']
    total_chefs = db.execute('SELECT COUNT(*) as count FROM users WHERE role = ?', ('chef',)).fetchone()['count']
    total_admins = db.execute('SELECT COUNT(*) as count FROM users WHERE role = ?', ('admin',)).fetchone()['count']
    total_orders = db.execute('SELECT COUNT(*) as count FROM orders').fetchone()['count']
    total_subscriptions = db.execute('SELECT COUNT(*) as count FROM subscriptions').fetchone()['count']
    total_reviews = db.execute('SELECT COUNT(*) as count FROM reviews').fetchone()['count']
    total_issued = db.execute('SELECT COUNT(*) as count FROM issued_meals WHERE issue_date = ?', (today,)).fetchone()['count']
    
    # –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total_orders_revenue = db.execute('SELECT SUM(m.price) as total FROM orders o JOIN menu m ON o.menu_id = m.id').fetchone()['total'] or 0
    total_subscriptions_revenue = db.execute('SELECT SUM(total_price) as total FROM subscriptions').fetchone()['total'] or 0
    total_revenue = total_orders_revenue + total_subscriptions_revenue
    
    # –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –≤—ã—Ä—É—á–∫–∞
    today_orders_revenue = db.execute('''
        SELECT SUM(m.price) as total FROM orders o 
        JOIN menu m ON o.menu_id = m.id 
        WHERE DATE(o.created_at) = ?
    ''', (today,)).fetchone()['total'] or 0
    
    today_subscriptions_revenue = db.execute('''
        SELECT SUM(total_price) as total FROM subscriptions 
        WHERE DATE(created_at) = ?
    ''', (today,)).fetchone()['total'] or 0
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    recent_users = db.execute('SELECT * FROM users ORDER BY created_at DESC LIMIT 5').fetchall()
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã
    recent_subscriptions = db.execute('''
        SELECT s.*, u.first_name, u.last_name, m.name as menu_name
        FROM subscriptions s
        JOIN users u ON s.user_id = u.id
        JOIN menu m ON s.menu_id = m.id
        ORDER BY s.created_at DESC
        LIMIT 5
    ''').fetchall()
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—ã–¥–∞—á–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
    issued_stats = db.execute('''
        SELECT m.meal_type, COUNT(*) as count
        FROM issued_meals im
        JOIN menu m ON im.menu_id = m.id
        WHERE im.issue_date = ? AND im.status = '–≤—ã–¥–∞–Ω'
        GROUP BY m.meal_type
    ''', (today,)).fetchall()
    
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
        <meta charset="utf-8">
        <style>
            body {{
                font-family: 'Arial', sans-serif;
                background: #f5f5f5;
                margin: 0;
                padding: 20px;
            }}
            .header {{
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                margin-bottom: 30px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }}
            .stats-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }}
            .stat-card {{
                background: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            }}
            .stat-value {{
                font-size: 2em;
                font-weight: bold;
                margin: 10px 0;
            }}
            .stat-orders {{ color: #3498db; }}
            .stat-subscriptions {{ color: #9b59b6; }}
            .stat-revenue {{ color: #27ae60; }}
            .stat-users {{ color: #e67e22; }}
            .dashboard-grid {{
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }}
            .section {{
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }}
            table {{
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }}
            th, td {{
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }}
            th {{
                background: #f8f9fa;
            }}
            .role-badge {{
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 0.8em;
            }}
            .role-student {{ background: #3498db; color: white; }}
            .role-chef {{ background: #e67e22; color: white; }}
            .role-admin {{ background: #2c3e50; color: white; }}
            .subscription-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                margin: 10px 0;
                border-left: 4px solid #9b59b6;
            }}
            .logout-btn {{
                background: #e74c3c;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                margin-left: 20px;
                transition: background 0.3s;
            }}
            .logout-btn:hover {{
                background: #c0392b;
            }}
            .progress-bar {{
                height: 20px;
                background: #ecf0f1;
                border-radius: 10px;
                margin: 10px 0;
                overflow: hidden;
            }}
            .progress-fill {{
                height: 100%;
                border-radius: 10px;
            }}
            .progress-breakfast {{ background: #3498db; }}
            .progress-lunch {{ background: #e67e22; }}
            .progress-snack {{ background: #9b59b6; }}
            .phone-info {{
                background: rgba(255, 255, 255, 0.2);
                padding: 8px 15px;
                border-radius: 8px;
                display: inline-block;
                margin: 10px 0;
            }}
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user['first_name']} {user['last_name']}!</p>
            <div class="phone-info">
                üì± <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {phone_display}
            </div>
            <p><strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {user['position']} | <strong>–î–∞—Ç–∞:</strong> {today}</p>
            <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
        </div>
        
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value stat-users">{total_users}</div>
                <div>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-orders">{total_orders}</div>
                <div>–†–∞–∑–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-subscriptions">{total_subscriptions}</div>
                <div>–ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-revenue">{total_revenue} —Ä—É–±.</div>
                <div>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{total_issued}</div>
                <div>–í—ã–¥–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-value stat-revenue">{today_orders_revenue + today_subscriptions_revenue} —Ä—É–±.</div>
                <div>–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="section">
                <h2>üë• –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h2>
                <table>
                    <thead>
                        <tr>
                            <th>–ò–º—è</th>
                            <th>Email</th>
                            <th>–†–æ–ª—å</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        </tr>
                    </thead>
                    <tbody>
    '''
    
    for user in recent_users:
        role_class = f"role-{user['role']}"
        html += f'''
                        <tr>
                            <td>{user['first_name']} {user['last_name']}</td>
                            <td>{user['email']}</td>
                            <td><span class="role-badge {role_class}">{user['role']}</span></td>
                            <td>{user['created_at'][:10] if user['created_at'] else '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                        </tr>
        '''
    
    html += '''
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã:</h2>
    '''
    
    if recent_subscriptions:
        for sub in recent_subscriptions:
            selected_dates = json.loads(sub['selected_dates'])
            html += f'''
                <div class="subscription-card">
                    <h4>{sub['menu_name']}</h4>
                    <p><strong>–£—á–µ–Ω–∏–∫:</strong> {sub['first_name']} {sub['last_name']}</p>
                    <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> {sub['start_date']} - {sub['end_date']}</p>
                    <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</strong> {len(selected_dates)}</p>
                    <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {sub['total_price']} —Ä—É–±.</p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {sub['status']}</p>
                </div>
            '''
    else:
        html += '<p>–ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>'
    
    html += '''
            </div>
        </div>
        
        <div class="section" style="margin-top: 30px;">
            <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:</h2>
    '''
    
    if issued_stats:
        for stat in issued_stats:
            meal_type_ru = {
                '–∑–∞–≤—Ç—Ä–∞–∫': '–ó–∞–≤—Ç—Ä–∞–∫–∏',
                '–æ–±–µ–¥': '–û–±–µ–¥—ã',
                '–ø–æ–ª–¥–Ω–∏–∫': '–ü–æ–ª–¥–Ω–∏–∫–∏'
            }.get(stat['meal_type'], stat['meal_type'])
            
            progress_class = {
                '–∑–∞–≤—Ç—Ä–∞–∫': 'progress-breakfast',
                '–æ–±–µ–¥': 'progress-lunch',
                '–ø–æ–ª–¥–Ω–∏–∫': 'progress-snack'
            }.get(stat['meal_type'], 'progress-breakfast')
            
            html += f'''
                <div style="margin: 15px 0;">
                    <p><strong>{meal_type_ru}:</strong> {stat['count']} –ø–æ—Ä—Ü–∏–π</p>
                    <div class="progress-bar">
                        <div class="progress-fill {progress_class}" style="width: {min(stat['count'] * 10, 100)}%;"></div>
                    </div>
                </div>
            '''
    else:
        html += '<p>–ù–∞ —Å–µ–≥–æ–¥–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—ã–¥–∞—á–∏ –Ω–µ—Ç.</p>'
    
    html += '''
        </div>
    </body>
    </html>
    '''
    
    return html

# ==================== API ====================

@app.route('/api/order', methods=['POST'])
def create_order():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ API"""
    if 'user_id' not in session or session.get('user_role') != 'student':
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ —É—á–µ–Ω–∏–∫'}), 401
    
    data = request.json
    if not data or 'menu_id' not in data:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω menu_id'}), 400
    
    db = get_db()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        return jsonify({'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
    
    # –ü–æ–ª—É—á–∞–µ–º –±–ª—é–¥–æ
    menu_item = db.execute('SELECT * FROM menu WHERE id = ?', (data['menu_id'],)).fetchone()
    if not menu_item:
        return jsonify({'error': '–ë–ª—é–¥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    if user['balance'] < menu_item['price']:
        return jsonify({'error': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ'}), 400
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
    order_id = str(uuid.uuid4())
    db.execute(
        'INSERT INTO orders (id, user_id, menu_id, status) VALUES (?, ?, ?, ?)',
        (order_id, user['id'], data['menu_id'], '–æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã')
    )
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ
    issue_id = str(uuid.uuid4())
    today = date.today().strftime('%Y-%m-%d')
    db.execute(
        'INSERT INTO issued_meals (id, user_id, menu_id, issue_date, meal_type, status) VALUES (?, ?, ?, ?, ?, ?)',
        (issue_id, user['id'], data['menu_id'], today, menu_item['meal_type'], '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏')
    )
    
    # –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞
    new_balance = user['balance'] - menu_item['price']
    db.execute('UPDATE users SET balance = ? WHERE id = ?', (new_balance, user['id']))
    
    db.commit()
    
    return jsonify({
        'success': True,
        'order_id': order_id,
        'new_balance': new_balance
    })

@app.route('/api/subscription', methods=['POST'])
def create_subscription():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞"""
    if 'user_id' not in session or session.get('user_role') != 'student':
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ —É—á–µ–Ω–∏–∫'}), 401
    
    data = request.json
    if not data or 'menu_id' not in data or 'selected_dates' not in data:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}), 400
    
    selected_dates = data['selected_dates']
    if not isinstance(selected_dates, list) or len(selected_dates) == 0:
        return jsonify({'error': '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –¥–∞—Ç—É'}), 400
    
    db = get_db()
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = db.execute('SELECT * FROM users WHERE id = ?', (session.get('user_id'),)).fetchone()
    if not user:
        return jsonify({'error': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
    
    # –ü–æ–ª—É—á–∞–µ–º –±–ª—é–¥–æ
    menu_item = db.execute('SELECT * FROM menu WHERE id = ?', (data['menu_id'],)).fetchone()
    if not menu_item:
        return jsonify({'error': '–ë–ª—é–¥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω –ª–∏ —É–∂–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ —ç—Ç–∏ –¥–∞—Ç—ã
    existing_subs = db.execute('SELECT selected_dates FROM subscriptions WHERE user_id = ? AND menu_id = ? AND status = "–∞–∫—Ç–∏–≤–µ–Ω"', 
                              (session.get('user_id'), data['menu_id'])).fetchall()
    
    for sub in existing_subs:
        existing_dates = json.loads(sub['selected_dates'])
        for date_str in selected_dates:
            if date_str in existing_dates:
                return jsonify({'error': f'–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ {date_str}'}), 400
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    total_price = data.get('total_price', menu_item['price'] * len(selected_dates))
    if user['balance'] < total_price:
        return jsonify({'error': f'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ. –ù—É–∂–Ω–æ: {total_price} —Ä—É–±., –µ—Å—Ç—å: {user["balance"]} —Ä—É–±.'}), 400
    
    # –°–æ–∑–¥–∞–µ–º –∞–±–æ–Ω–µ–º–µ–Ω—Ç
    subscription_id = str(uuid.uuid4())
    db.execute(
        '''INSERT INTO subscriptions (id, user_id, menu_id, selected_dates, start_date, end_date, total_price, status) 
           VALUES (?, ?, ?, ?, ?, ?, ?, ?)''',
        (subscription_id, user['id'], data['menu_id'], json.dumps(selected_dates, ensure_ascii=False), 
         data['start_date'], data['end_date'], total_price, '–∞–∫—Ç–∏–≤–µ–Ω')
    )
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏ –æ –≤—ã–¥–∞—á–µ –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã
    for date_str in selected_dates:
        issue_id = str(uuid.uuid4())
        db.execute(
            '''INSERT INTO issued_meals (id, user_id, menu_id, subscription_id, issue_date, meal_type, status) 
               VALUES (?, ?, ?, ?, ?, ?, ?)''',
            (issue_id, user['id'], data['menu_id'], subscription_id, date_str, menu_item['meal_type'], '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏')
        )
    
    # –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞
    new_balance = user['balance'] - total_price
    db.execute('UPDATE users SET balance = ? WHERE id = ?', (new_balance, user['id']))
    
    db.commit()
    
    return jsonify({
        'success': True,
        'subscription_id': subscription_id,
        'days_count': len(selected_dates),
        'total_price': total_price,
        'new_balance': new_balance
    })

@app.route('/api/issue-meal', methods=['POST'])
def issue_meal():
    """–í—ã–¥–∞—á–∞ –±–ª—é–¥–∞ –ø–æ–≤–∞—Ä–æ–º"""
    if 'user_id' not in session or session.get('user_role') != 'chef':
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –ø–æ–≤–∞—Ä'}), 401
    
    data = request.json
    if not data or 'meal_id' not in data:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω meal_id'}), 400
    
    db = get_db()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
    meal = db.execute('SELECT * FROM issued_meals WHERE id = ?', (data['meal_id'],)).fetchone()
    if not meal:
        return jsonify({'error': '–ó–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'}), 404
    
    if meal['status'] == '–≤—ã–¥–∞–Ω':
        return jsonify({'error': '–ë–ª—é–¥–æ —É–∂–µ –≤—ã–¥–∞–Ω–æ'}), 400
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —É–∫–∞–∑—ã–≤–∞–µ–º, –∫—Ç–æ –≤—ã–¥–∞–ª
    db.execute(
        'UPDATE issued_meals SET status = ?, issued_by = ? WHERE id = ?',
        ('–≤—ã–¥–∞–Ω', session.get('user_id'), data['meal_id'])
    )
    
    db.commit()
    
    return jsonify({
        'success': True,
        'message': '–ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–æ'
    })

@app.route('/api/issue-from-subscription', methods=['POST'])
def issue_from_subscription():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –≤—ã–¥–∞—á–µ –ø–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—É"""
    if 'user_id' not in session or session.get('user_role') != 'chef':
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –ø–æ–≤–∞—Ä'}), 401
    
    data = request.json
    if not data or 'subscription_id' not in data or 'menu_id' not in data or 'user_id' not in data:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}), 400
    
    db = get_db()
    today = date.today().strftime('%Y-%m-%d')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    existing_issue = db.execute('''
        SELECT * FROM issued_meals 
        WHERE user_id = ? AND menu_id = ? AND issue_date = ? AND subscription_id = ?
    ''', (data['user_id'], data['menu_id'], today, data['subscription_id'])).fetchone()
    
    if existing_issue:
        return jsonify({'error': '–ó–∞–ø–∏—Å—å –Ω–∞ –≤—ã–¥–∞—á—É —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª—é–¥–µ
    menu_item = db.execute('SELECT * FROM menu WHERE id = ?', (data['menu_id'],)).fetchone()
    if not menu_item:
        return jsonify({'error': '–ë–ª—é–¥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ
    issue_id = str(uuid.uuid4())
    db.execute(
        '''INSERT INTO issued_meals (id, user_id, menu_id, subscription_id, issue_date, meal_type, status) 
           VALUES (?, ?, ?, ?, ?, ?, ?)''',
        (issue_id, data['user_id'], data['menu_id'], data['subscription_id'], today, menu_item['meal_type'], '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–¥–∞—á–∏')
    )
    
    db.commit()
    
    return jsonify({
        'success': True,
        'message': '–ó–∞–ø–∏—Å—å –Ω–∞ –≤—ã–¥–∞—á—É —Å–æ–∑–¥–∞–Ω–∞'
    })

@app.route('/api/review', methods=['POST'])
def create_review():
    """–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    data = request.json
    if not data or 'menu_id' not in data or 'rating' not in data:
        return jsonify({'error': '–ù–µ —É–∫–∞–∑–∞–Ω—ã menu_id –∏–ª–∏ rating'}), 400
    
    rating = int(data['rating'])
    if rating < 1 or rating > 5:
        return jsonify({'error': '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5'}), 400
    
    db = get_db()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –±–ª—é–¥–æ
    menu_item = db.execute('SELECT * FROM menu WHERE id = ?', (data['menu_id'],)).fetchone()
    if not menu_item:
        return jsonify({'error': '–ë–ª—é–¥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ –±–ª—é–¥–æ
    existing_review = db.execute('SELECT * FROM reviews WHERE user_id = ? AND menu_id = ?', 
                                (session.get('user_id'), data['menu_id'])).fetchone()
    
    if existing_review:
        return jsonify({'error': '–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ –±–ª—é–¥–æ'}), 400
    
    # –°–æ–∑–¥–∞–µ–º –æ—Ç–∑—ã–≤
    review_id = str(uuid.uuid4())
    db.execute(
        'INSERT INTO reviews (id, user_id, menu_id, rating, comment) VALUES (?, ?, ?, ?, ?)',
        (review_id, session.get('user_id'), data['menu_id'], rating, data.get('comment', ''))
    )
    
    db.commit()
    
    return jsonify({
        'success': True,
        'review_id': review_id,
        'message': '–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω'
    })

@app.route('/api/review/<review_id>', methods=['GET', 'PUT', 'DELETE'])
def manage_review(review_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞"""
    if 'user_id' not in session:
        return jsonify({'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401
    
    db = get_db()
    
    if request.method == 'GET':
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
        review = db.execute('SELECT * FROM reviews WHERE id = ?', (review_id,)).fetchone()
        if not review:
            return jsonify({'error': '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
        
        if review['user_id'] != session.get('user_id') and session.get('user_role') not in ['admin', 'chef']:
            return jsonify({'error': '–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä —ç—Ç–æ–≥–æ –æ—Ç–∑—ã–≤–∞'}), 403
        
        return jsonify({
            'id': review['id'],
            'menu_id': review['menu_id'],
            'rating': review['rating'],
            'comment': review['comment'],
            'created_at': review['created_at']
        })
    
    elif request.method == 'PUT':
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
        data = request.json
        if not data:
            return jsonify({'error': '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'}), 400
        
        review = db.execute('SELECT * FROM reviews WHERE id = ?', (review_id,)).fetchone()
        if not review:
            return jsonify({'error': '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
        
        if review['user_id'] != session.get('user_id'):
            return jsonify({'error': '–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –æ—Ç–∑—ã–≤–∞'}), 403
        
        rating = data.get('rating', review['rating'])
        comment = data.get('comment', review['comment'])
        
        if rating < 1 or rating > 5:
            return jsonify({'error': '–†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 5'}), 400
        
        db.execute(
            'UPDATE reviews SET rating = ?, comment = ? WHERE id = ?',
            (rating, comment, review_id)
        )
        
        db.commit()
        
        return jsonify({
            'success': True,
            'message': '–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω'
        })
    
    elif request.method == 'DELETE':
        # –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
        review = db.execute('SELECT * FROM reviews WHERE id = ?', (review_id,)).fetchone()
        if not review:
            return jsonify({'error': '–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'}), 404
        
        if review['user_id'] != session.get('user_id') and session.get('user_role') != 'admin':
            return jsonify({'error': '–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –æ—Ç–∑—ã–≤–∞'}), 403
        
        db.execute('DELETE FROM reviews WHERE id = ?', (review_id,))
        db.commit()
        
        return jsonify({
            'success': True,
            'message': '–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω'
        })

# ==================== –í–´–•–û–î ====================

@app.route('/logout')
def logout():
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    session.clear()
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>–í—ã—Ö–æ–¥</title>
        <style>
            body { 
                font-family: Arial; 
                text-align: center; 
                padding: 100px; 
                background: #f0f8ff;
            }
            .message {
                background: white;
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                display: inline-block;
            }
            .btn {
                background: #3498db;
                color: white;
                padding: 12px 25px;
                border-radius: 8px;
                text-decoration: none;
                display: inline-block;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <div class="message">
            <h2>üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</h2>
            <p>–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã!</p>
            <a href="/" class="btn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </body>
    </html>
    '''

# ==================== –ó–ê–ü–£–°–ö ====================
@app.before_request
def before_request():
    """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º"""
    g.db = get_db()

@app.teardown_appcontext
def close_connection(exception):
    """–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞"""
    db = g.pop('db', None)
    if db is not None:
        db.close()

if __name__ == '__main__':
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
    with app.app_context():
        init_db()
    
    print("=" * 70)
    print("üöÄ –®–ö–û–õ–¨–ù–ê–Ø –°–¢–û–õ–û–í–ê–Ø –ó–ê–ü–£–©–ï–ù–ê!")
    print("=" * 70)
    print("‚ú® –û–ë–ù–û–í–õ–ï–ù–ò–Ø:")
    print("‚úÖ –£–î–ê–õ–ï–ù–´ –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã")
    print("‚úÖ –î–û–ë–ê–í–õ–ï–ù –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏")
    print("‚úÖ –£–õ–£–ß–®–ï–ù–ê –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
    print("=" * 70)
    
    print("\nüì° –î–æ—Å—Ç—É–ø –∫ —Å–∞–π—Ç—É:")
    print("1. –≠—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä: http://localhost:5000")
    print("2. –î—Ä—É–≥–∏–µ –≤ –≤–∞—à–µ–π Wi-Fi —Å–µ—Ç–∏: http://–í–ê–®_IP:5000")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º IP –∞–¥—Ä–µ—Å
    import socket
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        print(f"3. –í–∞—à IP –∞–¥—Ä–µ—Å: {ip}")
        print(f"   –î–ª—è –¥—Ä—É–∑–µ–π –≤ –≤–∞—à–µ–π —Å–µ—Ç–∏: http://{ip}:5000")
    except:
        print("3. –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å IP: –æ—Ç–∫—Ä–æ–π—Ç–µ cmd –∏ –≤–≤–µ–¥–∏—Ç–µ 'ipconfig'")
    
    print("=" * 70)
    print("üë®‚Äçüéì –£–ß–ï–ù–ò–ö: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–∞–π—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ–ª–µ—Ñ–æ–Ω)")
    print("üë®‚Äçüç≥ –ü–û–í–ê–†: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–∞–π—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ–ª–µ—Ñ–æ–Ω)")
    print("üë®‚Äçüíº –ê–î–ú–ò–ù: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å–∞–π—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ–ª–µ—Ñ–æ–Ω)")
    print("=" * 70)
    
    # –ó–∞–ø—É—Å–∫ Flask
    app.run(host='0.0.0.0', port=5000, debug=True)
